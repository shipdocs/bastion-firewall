#!/bin/bash
# Bastion Firewall - Config Reload Helper
# This script updates the config file and signals the daemon to reload
# Usage: bastion-reload-config <temp_file_path> <target_path>

set -e  # Exit on error

if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run as root" >&2
    exit 1
fi

if [ $# -ne 2 ]; then
    echo "Usage: $0 <temp_file> <config_file>" >&2
    exit 1
fi

TEMP_FILE="$1"
CONFIG_FILE="$2"

# Validate paths
if [ ! -f "$TEMP_FILE" ]; then
    echo "Error: Temporary file does not exist: $TEMP_FILE" >&2
    exit 1
fi

# Ensure the config file lives under the expected Bastion config directory
case "$CONFIG_FILE" in
    /etc/bastion/*) ;;
    *)
        echo "Error: Invalid config file path: $CONFIG_FILE" >&2
        exit 1
        ;;
esac

# Move the temporary file to the config location
mv "$TEMP_FILE" "$CONFIG_FILE"

# Set proper permissions (readable by all, writable by root)
chmod 644 "$CONFIG_FILE"

# Signal the daemon to reload config and clear cache
pkill -HUP -f bastion-daemon || true

exit 0
