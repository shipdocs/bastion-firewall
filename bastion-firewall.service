[Unit]
Description=Bastion Firewall Daemon
After=network.target

[Service]
Type=simple
ExecStartPre=/bin/sh -c 'iptables -C OUTPUT -m state --state NEW -j NFQUEUE --queue-num 1 --queue-bypass 2>/dev/null || iptables -I OUTPUT -m state --state NEW -j NFQUEUE --queue-num 1 --queue-bypass'
ExecStart=/usr/bin/bastion-daemon
ExecStartPost=/usr/bin/bastion-launch
ExecStopPost=/bin/sh -c 'iptables -D OUTPUT -m state --state NEW -j NFQUEUE --queue-num 1 --queue-bypass 2>/dev/null || true'
ExecStopPost=/bin/sh -c 'rm -f /var/run/bastion/bastion-daemon.sock'
Restart=always
RestartSec=5s
User=root
Group=root
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_RAW CAP_BPF CAP_PERFMON CAP_SYS_ADMIN
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_RAW CAP_BPF CAP_PERFMON
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
