{"body":"## **User description**\n### **User description**\nThis is a fresh implementation of the USB device control feature with updated code and clean comments. This PR replaces PR #5 to provide a cleaner review experience.\n\n\n___\n\n### **PR Type**\nEnhancement, Tests, Documentation\n\n\n___\n\n### **Description**\n- Comprehensive USB device control feature implementation with GUI components, monitoring, and authorization system\n\n- New `USBMonitor` class for detecting USB device insertion/removal events using `pyudev` library\n\n- Secure USB rules storage with `USBRuleManager` and `USBAuthorizer` for managing allow/block rules with atomic writes and input sanitization\n\n- USB device classification system with risk assessment (`USBDeviceInfo`, `USBClass` enum) and threat-based auto-blocking\n\n- GUI components including `USBPromptDialog` for device authorization decisions and `USBControlWidget` for device management\n\n- Privileged operations via new `bastion-root-helper` CLI tool invoked through polkit with strict input validation and audit logging\n\n- Enhanced socket security: moved from `/tmp` to `/run/bastion` with proper group permissions and symlink attack prevention\n\n- GUI privilege separation improvements with user session detection and proper environment variable setup\n\n- Comprehensive test suites for USB rules security, root helper validation, and device detection\n\n- Security documentation with threat model, privilege separation diagram, and input validation specifications\n\n- Updated build scripts, polkit policies, and package dependencies for USB support\n\n\n___\n\n### Diagram Walkthrough\n\n\n```mermaid\nflowchart LR\n  A[\"USB Device<br/>Insertion/Removal\"] -->|\"pyudev<br/>monitoring\"| B[\"USBMonitor\"]\n  B -->|\"device info\"| C[\"USBDeviceInfo<br/>Classification\"]\n  C -->|\"risk assessment\"| D[\"USBAuthorizer\"]\n  D -->|\"check rules\"| E[\"USBRuleManager<br/>JSON Storage\"]\n  E -->|\"allow/block\"| F[\"sysfs<br/>Authorization\"]\n  D -->|\"prompt user\"| G[\"USBPromptDialog<br/>GUI\"]\n  G -->|\"user decision\"| E\n  H[\"bastion-root-helper<br/>pkexec\"] -->|\"privileged ops\"| E\n  H -->|\"audit log\"| I[\"syslog\"]\n  J[\"GUI Manager\"] -->|\"ensure running\"| K[\"bastion-gui\"]\n  K -->|\"socket\"| L[\"/run/bastion<br/>daemon.sock\"]\n```\n\n\n\n<details><summary><h3>File Walkthrough</h3></summary>\n\n<table><thead><tr><th></th><th align=\"left\">Relevant files</th></tr></thead><tbody><tr><td><strong>Enhancement</strong></td><td><details><summary>11 files</summary><table>\n<tr>\n  <td>\n    <details>\n      <summary><strong>usb_gui.py</strong><dd><code>USB Device Control GUI Components Implementation</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/usb_gui.py\n\n<ul><li>New file implementing USB device control GUI components including <br><code>USBPromptDialog</code> for device authorization decisions and <br><code>USBControlWidget</code> for managing allowed/blocked devices<br> <li> Provides styled dialogs matching the application theme with support <br>for device scope selection (device/model/vendor level)<br> <li> Includes device management tables with delete functionality and USB <br>protection toggle with privilege escalation via <code>bastion-root-helper</code><br> <li> Implements anti-spoofing nonce validation and timeout-based <br>auto-blocking for high-risk devices</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bd\">+940/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>daemon.py</strong><dd><code>USB Monitoring and Daemon Socket Security Enhancements</code>&nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/daemon.py\n\n<ul><li>Added USB device monitoring with <code>USBMonitor</code> integration and rule-based <br>authorization decisions<br> <li> Implemented GUI communication for USB device prompts with nonce-based <br>anti-spoofing and response handling<br> <li> Added socket security improvements: moved from <code>/tmp</code> to <code>/run/bastion</code> <br>with proper group permissions and symlink attack prevention<br> <li> Integrated <code>GUIManager</code> to ensure GUI is always running and USB rules <br>are reloaded when modified</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baa\">+395/-20</a></td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>usb_rules.py</strong><dd><code>Secure USB Rules Storage and Authorization System</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/usb_rules.py\n\n<ul><li>New file implementing secure JSON-based USB rule storage with atomic <br>writes and input sanitization<br> <li> Provides <code>USBRuleManager</code> for managing allow/block rules with scope <br>support (device/model/vendor)<br> <li> Implements <code>USBAuthorizer</code> class for controlling device authorization <br>via sysfs with path traversal prevention<br> <li> Includes comprehensive input validation to prevent injection attacks <br>and symlink-based TOCTOU attacks</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-da629a89eec0c480da3d96816c0ba7044d8036e4822f9bb16483d0cdd014fca0\">+550/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>gui_qt.py</strong><dd><code>GUI Integration of USB Device Control Features</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/gui_qt.py\n\n<ul><li>Added USB navigation button and control page to main GUI with dynamic <br>status display<br> <li> Integrated USB device management widget into status dashboard showing <br>protection status and device counts<br> <li> Updated subprocess calls to use absolute paths (e.g., <br><code>/usr/bin/systemctl</code>) to prevent PATH hijacking<br> <li> Added tray icon management section in settings with button to <br>start/restart the tray icon</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f9f219109b878859f078120342e6af5b34efa439fd52b2b3cec00b97cb0fe859\">+166/-31</a></td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>root_helper.py</strong><dd><code>Privileged Root Helper CLI for USB Operations</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/root_helper.py\n\n<ul><li>New privileged operations CLI tool invoked via <code>pkexec</code> for <br>root-required USB operations<br> <li> Implements fixed command set for USB default policy management and <br>rule deletion with strict input validation<br> <li> All inputs validated against regex patterns before use; no shell <br>interpretation of arguments<br> <li> Includes audit logging to syslog (LOG_AUTH facility) for security <br>tracking</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-e14c111d9aa4b60221987bbf8f95e542a831e8ca7e826863a5de2f023a43f89d\">+331/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>bastion-gui.py</strong><dd><code>GUI Socket Security and USB Request Handling</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion-gui.py\n\n<ul><li>Updated socket path from <code>/tmp/bastion-daemon.sock</code> to <br><code>/run/bastion/daemon.sock</code> for security<br> <li> Fixed lock file location to use <code>XDG_RUNTIME_DIR</code> or <code>~/.cache/bastion</code> <br>instead of <code>/tmp</code> to prevent cross-user blocking<br> <li> Added USB request handling with nonce validation and <code>USBPromptDialog</code> <br>integration<br> <li> Implemented tray icon visibility check timer to ensure icon remains <br>visible</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-187b1e5910f096aae7417e760f849b9a564ea1ed82afd7d450e58fa8cced9a57\">+98/-7</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>usb_monitor.py</strong><dd><code>USB Device Monitoring with pyudev Integration</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/usb_monitor.py\n\n<ul><li>New USB device monitoring module using <code>pyudev</code> library for detecting <br>device insertion/removal events<br> <li> Implements <code>USBMonitor</code> class with start/stop methods and event callback <br>mechanism<br> <li> Extracts detailed device information including vendor/product IDs, <br>names, classes, and serial numbers<br> <li> Provides <code>list_usb_devices()</code> convenience function and <br><code>is_pyudev_available()</code> check</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-6d9892f3b2e6bad306242fdda365e835092002b80950f330bdb500cb4f7959eb\">+253/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>usb_device.py</strong><dd><code>USB Device Information and Classification Model</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/usb_device.py\n\n<ul><li>New dataclass <code>USBDeviceInfo</code> representing USB device metadata extracted <br>from udev<br> <li> Defines <code>USBClass</code> enum with USB device class codes (HID, mass storage, <br>hub, wireless, etc.)<br> <li> Provides risk classification properties (<code>is_high_risk</code>, <code>is_low_risk</code>) <br>and device type checks<br> <li> Includes human-readable class names and unique/model identifiers for <br>rule matching</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-bd906050220a1ab34e68971f950245b0fb82ac274aba12bd6632abf5c4c5051f\">+158/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>gui_manager.py</strong><dd><code>GUI Privilege Separation and User Session Detection</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/gui_manager.py\n\n<ul><li>Added <code>is_gui_running()</code> method to check if GUI process is alive<br> <li> Enhanced <code>start_gui()</code> to run GUI as logged-in user instead of root <br>using privilege dropping<br> <li> Implements DISPLAY discovery from user's X session via <code>/proc</code> and <code>ps</code> <br>commands<br> <li> Sets up proper environment variables (HOME, USER, XAUTHORITY, <br>XDG_RUNTIME_DIR) for GUI execution</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601f\">+178/-12</a></td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>icon_manager.py</strong><dd><code>Navigation Icon Management for GUI Sidebar</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/icon_manager.py\n\n<ul><li>Added <code>NAV_ICONS</code> dictionary mapping navigation sidebar items to icon <br>files<br> <li> Implemented <code>get_nav_icon()</code> method to load navigation icons with <br>fallback to empty icon<br> <li> Includes error handling for missing or invalid icon files with debug <br>logging</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-0515c74ff101428dd171e9b2a4e4c45b057207f7cb2f67e6fc8844216a2a04b0\">+44/-2</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>gui_theme.py</strong><dd><code>Centralized GUI Theme and String Configuration</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/gui_theme.py\n\n<ul><li>New theme configuration module with centralized color scheme (One Dark <br>Pro inspired)<br> <li> Defines <code>COLORS</code> dictionary with background, sidebar, card, text, and <br>status colors<br> <li> Provides <code>STRINGS</code> dictionary for GUI string constants related to USB <br>device control<br> <li> Includes helper functions <code>get_color()</code> and <code>get_string()</code> with fallback <br>defaults</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-a79735ee2c82973a247b201a763c77658b892067aa83777c0660d8c4fa39d9ed\">+47/-0</a>&nbsp; &nbsp; </td>\n\n</tr>\n</table></details></td></tr><tr><td><strong>Tests</strong></td><td><details><summary>3 files</summary><table>\n<tr>\n  <td>\n    <details>\n      <summary><strong>test_usb_rules.py</strong><dd><code>USB Rules Security and Functionality Test Suite</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\ntests/test_usb_rules.py\n\n<ul><li>New comprehensive test suite for USB rules storage, sanitization, and <br>authorization<br> <li> Tests cover rule persistence, scope matching, input sanitization <br>against injection attacks, and path traversal prevention<br> <li> Validates serial number sanitization, key format validation, and <br>malicious input handling<br> <li> Includes tests for <code>USBAuthorizer</code> path safety and rule key generation <br>with dangerous characters</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-385390e324128860e5a72d0b43d111c89adce3abf85504276a28495dbda391f1\">+372/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>test_root_helper.py</strong><dd><code>Root Helper Security and Input Validation Tests</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\ntests/test_root_helper.py\n\n<ul><li>New test suite for <code>bastion-root-helper</code> CLI security and correctness<br> <li> Tests key validation against injection attacks (shell, SQL, path <br>traversal, quotes, semicolons)<br> <li> Validates command-line argument parsing (--help, --version)<br> <li> Tests USB rule deletion with both invalid and valid keys using mocked <br><code>USBRuleManager</code></ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-3531f5b25b95c4eb6522e3367c91e5fddaa9817b38b7e99627d69fed91e5437e\">+172/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>test_usb_detection.py</strong><dd><code>USB Device Detection and Monitoring Test Script</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\ntests/test_usb_detection.py\n\n<ul><li>New interactive test script for USB device detection and monitoring<br> <li> Lists currently connected USB devices with risk classification<br> <li> Monitors USB insertion/removal events with colored output and device <br>details<br> <li> Provides graceful shutdown via Ctrl+C signal handling</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-32e26a436e642c26308c10280b55ace06eb569518d93ed9612c9f90d93944ad9\">+107/-0</a>&nbsp; </td>\n\n</tr>\n</table></details></td></tr><tr><td><strong>Documentation</strong></td><td><details><summary>3 files</summary><table>\n<tr>\n  <td>\n    <details>\n      <summary><strong>launch_bastion.sh</strong><dd><code>Launch Script Documentation Update</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nlaunch_bastion.sh\n\n<ul><li>Updated script comments to reflect current behavior (start tray icon <br>and control panel)<br> <li> Changed from Douane-specific wrapper to Bastion Firewall launcher</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-cf1a3590f678127f54b79139ad252f4823542d8e0d4065ede0d2e08ea7b70fde\">+3/-3</a>&nbsp; &nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>SECURITY.md</strong><dd><code>Security Architecture and Threat Model Documentation</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nSECURITY.md\n\n<ul><li>Added comprehensive security architecture documentation with privilege <br>separation diagram<br> <li> Documented trust boundaries between user GUI, root helper, and system <br>components<br> <li> Added input validation table with max lengths for USB identifiers and <br>rule keys<br> <li> Included audit logging details, USB threat model, and security <br>checklist</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f6ed156e4bf5c791680662464b94ea5d753f219ee816b385f67870e2c0d7d4c7\">+95/-4</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>README.md</strong><dd><code>README Updates for USB Device Control Feature</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nREADME.md\n\n<ul><li>Added \"USB Device Control\" feature to feature list with description of <br>blocking unauthorized devices<br> <li> Updated control panel capabilities to include USB device access <br>management<br> <li> Mentioned ability to manage USB device access in system tray icon <br>section</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5\">+3/-1</a>&nbsp; &nbsp; &nbsp; </td>\n\n</tr>\n</table></details></td></tr><tr><td><strong>Dependencies</strong></td><td><details><summary>2 files</summary><table>\n<tr>\n  <td>\n    <details>\n      <summary><strong>requirements.txt</strong><dd><code>USB Device Monitoring Dependency Addition</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nrequirements.txt\n\n<ul><li>Added <code>pyudev>=0.24.0</code> dependency for USB device monitoring <br>functionality</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-4d7c51b1efe9043e44439a949dfd92e5827321b34082903477fd04876edb7552\">+3/-0</a>&nbsp; &nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>control</strong><dd><code>Debian Package Dependencies Update for USB Support</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\ndebian/DEBIAN/control\n\n<ul><li>Updated installed size from 568 to 976 KB<br> <li> Added <code>python3-pyudev (>= 0.24.0)</code> as new dependency for USB monitoring<br> <li> Removed <code>python3-dev</code> and <code>build-essential</code> from main dependencies, moved <br>to <code>Build-Depends</code><br> <li> Removed <code>libnetfilter-queue-dev</code> and <code>linux-headers-generic</code> from main <br>dependencies</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f826abbd437d93ab643bb7e9772511a9aa637672c0a3255882ace19fa527bb2a\">+3/-2</a>&nbsp; &nbsp; &nbsp; </td>\n\n</tr>\n</table></details></td></tr><tr><td><strong>Security</strong></td><td><details><summary>2 files</summary><table>\n<tr>\n  <td>\n    <details>\n      <summary><strong>usb_validation.py</strong><dd><code>USB Data Validation and Sanitization Utilities</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion/usb_validation.py\n\n<ul><li>Centralized validation and sanitization module for USB device data<br> <li> Implements strict input validation for hex IDs, serial numbers, and <br>rule keys with regex-based character filtering<br> <li> Provides <code>USBValidation</code> class with methods for sanitizing <br>vendor/product IDs, serials, and keys<br> <li> Includes security-focused design to prevent injection attacks through <br>character set restrictions</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-cdf38e4ae4ca1dee26c9221eace6008667e878546c0eb26ed825cfd844986be4\">+215/-0</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>com.bastion.root-helper.policy</strong><dd><code>Polkit Policy for Bastion Root Helper Authorization</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\ncom.bastion.root-helper.policy\n\n<ul><li>New polkit policy file defining authorization rules for <br><code>bastion-root-helper</code><br> <li> Defines three actions: main root helper, USB policy management, and <br>USB rule management<br> <li> Requires admin authentication for active sessions only (denies <br>remote/inactive access)<br> <li> Includes security annotations and internationalized descriptions</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-8790b6f79f713974a4a2ab098eb7b4648c5302ba01c76f11ce9bb1a0a639d417\">+64/-0</a>&nbsp; &nbsp; </td>\n\n</tr>\n</table></details></td></tr><tr><td><strong>Configuration changes</strong></td><td><details><summary>4 files</summary><table>\n<tr>\n  <td>\n    <details>\n      <summary><strong>setup.py</strong><dd><code>Setup Configuration for Root Helper and Polkit Integration</code></dd></summary>\n<hr>\n\nsetup.py\n\n<ul><li>Added <code>bastion-root-helper</code> console script entry point for privileged <br>operations<br> <li> Updated <code>data_files</code> to include polkit policy, systemd service, and <br>desktop entries<br> <li> Added <code>/etc/xdg/autostart</code> and <code>/usr/share/polkit-1/actions</code> installation <br>paths<br> <li> Removed note about entry_points and replaced with proper <br>console_scripts configuration</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7\">+15/-3</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>uninstall_bastion.sh</strong><dd><code>Uninstaller Updates for Bastion Branding and Root Helper</code>&nbsp; </dd></summary>\n<hr>\n\nuninstall_bastion.sh\n\n<ul><li>Updated script title and descriptions from \"Douane\" to \"Bastion <br>Firewall\"<br> <li> Enhanced binary removal to handle both old <code>douane</code> and new <code>bastion-*</code> <br>executables<br> <li> Added removal of <code>bastion-root-helper</code> binary and polkit policies<br> <li> Improved Python module removal for both Debian and RPM paths with <br>safety checks for <code>/run/bastion</code></ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-0162f5ae93b9be739c3877c60fa14ab273308ec7fd34877fa3873a70339e4fba\">+78/-38</a>&nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>build_deb.sh</strong><dd><code>Debian Build Script Updates for Root Helper and Polkit</code>&nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbuild_deb.sh\n\n<ul><li>Added creation of <code>bastion-root-helper</code> wrapper script in <code>/usr/bin/</code><br> <li> Implemented installation of polkit policy file with secure permissions <br>(0644)<br> <li> Added <code>tmpfiles.d</code> configuration directory creation for <code>/run/bastion</code> <br>management<br> <li> Included copying of <code>bastion.conf</code> to <code>/usr/lib/tmpfiles.d/</code></ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-5ff8ce75532c01d42d4af24ef679dd19b1a225266046c14cd5d4493e144a30eb\">+22/-0</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td>\n    <details>\n      <summary><strong>bastion.conf</strong><dd><code>Systemd Tmpfiles Configuration for Runtime Directory</code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </dd></summary>\n<hr>\n\nbastion.conf\n\n<ul><li>New tmpfiles.d configuration file for creating <code>/run/bastion</code> directory <br>at boot<br> <li> Defines directory with 0755 permissions owned by root<br> <li> Follows systemd-tmpfiles standard format for runtime directory <br>management</ul>\n\n\n</details>\n\n\n  </td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-23105155a7880df618edea8728860224e46b732b39ecf6761d4681b301619abf\">+8/-0</a>&nbsp; &nbsp; &nbsp; </td>\n\n</tr>\n</table></details></td></tr><tr><td><strong>Additional files</strong></td><td><details><summary>4 files</summary><table>\n<tr>\n  <td><strong>firewall_core.py</strong></td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-addda00e3f7b10a3d93cf521c8ac77493dd72e358d3b82659fbff2a4d7517850\">+0/-3</a>&nbsp; &nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td><strong>test_network.py</strong></td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-6c851720260fe416f4e5629fd1d065cf0f40d26136635594e58b76168a384470\">+0/-10</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td><strong>test_startup.py</strong></td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-ab95579b1b433c84e669a5dbdc33fe4c353f3e5c0dbb3c0e6c1e150fee231097\">+0/-35</a>&nbsp; &nbsp; </td>\n\n</tr>\n\n<tr>\n  <td><strong>ufw_firewall_gui.py</strong></td>\n  <td><a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-fce95d3eaac48ff206c4a5b5adf0b83a6e376776465705e22c9760dd27c9cf88\">+0/-403</a>&nbsp; </td>\n\n</tr>\n</table></details></td></tr></tbody></table>\n\n</details>\n\n___\n\n\n___\n\n## **CodeAnt-AI Description**\nUSB Device Control UI and secure daemon integration\n\n### What Changed\n- New USB device control UI: a popup dialog for new devices (allow/block once or always, scope selection, 30s auto-block) and a USB control page showing allowed/blocked lists and protection status\n- Daemon now monitors USB events, blocks new devices by default, consults stored rules, and prompts the GUI for decisions; GUI responses are nonce-validated to prevent spoofing\n- Secure rule storage and privileged helper: USB rules use atomic, sanitized JSON storage; a minimal root helper CLI performs only validated privileged operations (set default policy, delete/clear rules)\n- UX and reliability improvements: tray/GUI restart checks, socket moved to /run with restricted permissions, and tests for USB detection and rules added\n\n### Impact\n`‚úÖ Clearer USB allow/block prompts for new devices`\n`‚úÖ Fewer accidental USB auto-allows (new devices blocked by default until user approves)`\n`‚úÖ Fewer lost tray icons (daemon auto-restarts GUI and socket access is more reliable)`\n<details>\n<summary><strong>üí° Usage Guide</strong></summary>\n\n### Checking Your Pull Request\nEvery time you make a pull request, our system automatically looks through it. We check for security issues, mistakes in how you're setting up your infrastructure, and common code problems. We do this to make sure your changes are solid and won't cause any trouble later.\n\n### Talking to CodeAnt AI\nGot a question or need a hand with something in your pull request? You can easily get in touch with CodeAnt AI right here. Just type the following in a comment on your pull request, and replace \"Your question here\" with whatever you want to ask:\n<pre>\n<code>@codeant-ai ask: Your question here</code>\n</pre>\nThis lets you have a chat with CodeAnt AI about your pull request, making it easier to understand and improve your code.\n\n#### Example\n<pre>\n<code>@codeant-ai ask: Can you suggest a safer alternative to storing this secret?</code>\n</pre>\n\n### Preserve Org Learnings with CodeAnt\nYou can record team preferences so CodeAnt AI applies them in future reviews. Reply directly to the specific CodeAnt AI suggestion (in the same thread) and replace \"Your feedback here\" with your input:\n<pre>\n<code>@codeant-ai: Your feedback here</code>\n</pre>\nThis helps CodeAnt AI learn and adapt to your team's coding style and standards.\n\n#### Example\n<pre>\n<code>@codeant-ai: Do not flag unused imports.</code>\n</pre>\n\n### Retrigger review\nAsk CodeAnt AI to review the PR again, by typing:\n<pre>\n<code>@codeant-ai: review</code>\n</pre>\n\n### Check Your Repository Health\nTo analyze the health of your code repository, visit our dashboard at [https://app.codeant.ai](https://app.codeant.ai). This tool helps you identify potential issues and areas for improvement in your codebase, ensuring your repository maintains high standards of code health.\n\n</details>\n\n\n<!-- This is an auto-generated comment: release notes by coderabbit.ai -->\n## Summary by CodeRabbit\n\n* **New Features**\n  * USB Device Control: allow/block rules, prompts, USB management dashboard, and tray actions to start/monitor the GUI\n  * Privileged root-helper CLI for USB policy and rule management; installer now registers tmpfiles/polkit entries\n\n* **Documentation**\n  * Expanded SECURITY.md with architecture, threat model and checklist; README documents USB Device Control and updated tray usage\n\n* **Bug Fixes / Reliability**\n  * More robust daemon/tray IPC, socket handling, and GUI process management\n\n* **Tests**\n  * New tests for root-helper CLI and USB rules/monitoring\n\n<sub>‚úèÔ∏è Tip: You can customize this high-level summary in your review settings.</sub>\n<!-- end of auto-generated comment: release notes by coderabbit.ai -->","comments":[{"id":"IC_kwDOQsqSJc7b-5Nc","author":{"login":"codeant-ai"},"authorAssociation":"NONE","body":"CodeAnt AI is reviewing your PR.\n\n---\n\n### Thanks for using CodeAnt! üéâ\n\nWe're free for open-source projects. if you're enjoying it, help us grow by sharing.\n\n[Share on X](https://twitter.com/intent/tweet?text=Just%20tried%20%40CodeAntAI%20for%20automated%20code%20review%20and%20I%27m%20impressed%21%20Free%20for%20open%20source%20with%20a%20free%20trial%20for%20private%20repos.%20Worth%20checking%20out%3A&url=https%3A//codeant.ai) ¬∑\n[Reddit](https://www.reddit.com/submit?title=Check%20out%20CodeAnt%20for%20automated%20code%20review&text=Just%20tried%20CodeAnt%20for%20automated%20code%20review%20and%20I%27m%20impressed%21%20Free%20for%20open%20source%20with%20a%20free%20trial%20for%20private%20repos.%20Worth%20checking%20out%3A%20https%3A//codeant.ai) ¬∑\n[LinkedIn](https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcodeant.ai&mini=true&title=Check%20out%20CodeAnt%20for%20automated%20code%20review&summary=Just%20tried%20CodeAnt%20for%20automated%20code%20review%20and%20I%27m%20impressed%21%20Free%20for%20open%20source%20with%20a%20free%20trial%20for%20private%20repos)\n","createdAt":"2025-12-25T01:33:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690697564","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7b-5Ot","author":{"login":"coderabbitai"},"authorAssociation":"CONTRIBUTOR","body":"<!-- This is an auto-generated comment: summarize by coderabbit.ai -->\n<!-- walkthrough_start -->\n\n<details>\n<summary>üìù Walkthrough</summary>\n\n## Walkthrough\n\nAdds a USB Device Control subsystem (monitor, rules, GUI prompts, authorizer, root helper), integrates USB UI and tray management, moves IPC socket/tmpfiles to /run/bastion, updates packaging/policy, and adjusts gitignore, docs, and several scripts. Also removes legacy UFW GUI and some test scripts.\n\n## Changes\n\n| Cohort / File(s) | Summary of changes / attention areas |\n|---|---|\n| **USB subsystem (new modules)**<br>`bastion/usb_device.py`, `bastion/usb_monitor.py`, `bastion/usb_rules.py`, `bastion/usb_validation.py`, `bastion/usb_gui.py` | New data model, validation, persistent JSON rules, sysfs authorizer, pyudev-based monitor, GUI dialogs/widgets; review security (sanitizers, sysfs paths), atomic file I/O, and thread/event coordination. |\n| **Daemon & IPC**<br>`bastion/daemon.py`, `bastion.conf` | Adds GUI manager integration, USB monitor lifecycle, pending-request/nonce handling, GUI message reader, socket moved to `/run/bastion/daemon.sock`, and tmpfiles config; review concurrency, socket permissions, and nonce validation. |\n| **GUI client & Qt UI**<br>`bastion-gui.py`, `bastion/gui_manager.py`, `bastion/gui_qt.py`, `bastion/gui_theme.py`, `bastion/icon_manager.py` | Tray visibility timer, USB request handling in client, improved GUI start logic (user/X env), new USB page and controls, centralized theme/strings, icon loading; review environment detection, privilege demotion, and tray/socket changes. |\n| **Privileged helper & packaging**<br>`bastion/root_helper.py`, `build_deb.sh`, `setup.py`, `com.bastion.root-helper.policy`, `debian/*`, `bastion.conf` | New bastion-root-helper CLI with audited actions (usb-policy, usb-rule management), polkit policy, packaging changes and tmpfiles install; review allowed command surface, input validation, and packaging entries. |\n| **Firewall core & subprocess imports**<br>`bastion/firewall_core.py` | Removed local `subprocess` imports inside functions (requires module-level import); check for missing import causing NameError. |\n| **Removed legacy UFW GUI & test scripts**<br>`ufw_firewall_gui.py`, `test_network.py`, `test_startup.py` | Large deletion of legacy UFW GUI and two test scripts; ensure no remaining references. |\n| **Tests (new/updated)**<br>`tests/test_root_helper.py`, `tests/test_usb_rules.py`, `tests/test_usb_detection.py` | New coverage for root helper and USB rules/monitor; review mocking, file-system assumptions, and pyudev dependency in CI. |\n| **Docs & metadata**<br>`README.md`, `SECURITY.md`, `.gitignore` | README USB feature bullets added, SECURITY expanded with architecture and audit notes, `.gitignore` updated for AI tool artifacts. Review SECURITY claims vs implemented controls. |\n| **Launcher & uninstall scripts**<br>`launch_bastion.sh`, `uninstall_bastion.sh` | Replaced Douane references with Bastion, updated launcher to ensure GUI running, broadened uninstall cleanup; verify paths and service names. |\n| **Requirements**<br>`requirements.txt` | Added `pyudev>=0.24.0`; confirm CI and packaging compatibility. |\n\n## Sequence Diagram(s)\n\n```mermaid\nsequenceDiagram\n    participant USB as USB device / kernel\n    participant Monitor as bastion-usb-monitor\n    participant Daemon as bastion-daemon\n    participant GUI as bastion-gui\n    participant Root as bastion-root-helper (pkexec)\n    rect `#EFEFEF`\n      Note over Monitor,Daemon: Device detected -> decision flow\n    end\n    USB->>Monitor: udev event (add)\n    Monitor->>Daemon: USBDeviceInfo + action\n    Daemon->>Daemon: evaluate rules (USBRuleManager)\n    alt rule found (allow/block)\n        Daemon->>Daemon: apply verdict via USBAuthorizer (sysfs)\n    else rule not found\n        Daemon->>GUI: send usb_request (includes nonce)\n        GUI->>User: show USBPromptDialog\n        User-->>GUI: verdict, scope, save_rule\n        GUI->>Daemon: usb_response (echo nonce + verdict)\n        Daemon->>Daemon: validate nonce -> store verdict\n        Daemon->>USBAuthorizer: authorize/deauthorize device\n        Daemon->>USBRuleManager: optional save_rule\n    end\n    Daemon->>Monitor: acknowledge / continue\n```\n\n## Estimated code review effort\n\nüéØ 4 (Complex) | ‚è±Ô∏è ~45 minutes\n\n## Possibly related PRs\n\n- shipdocs/bastion-firewall#2 ‚Äî overlapping changes around entrypoint/daemon and notifier behavior; related to daemon/entrypoint refactors and renames.\n\n## Suggested labels\n\n`codex`, `Review effort 2/5`, `size:M`\n\n## Poem\n\n> üêá I hopped through rules and sysfs trees,  \n> Prompted humans while nibbling keys.  \n> Nonces safe in my little paw,  \n> I guard the USB door with awe.  \n> Cheers ‚Äî a rabbit's code-approved breeze!\n\n</details>\n\n<!-- walkthrough_end -->\n\n\n<!-- pre_merge_checks_walkthrough_start -->\n\n## Pre-merge checks and finishing touches\n<details>\n<summary>‚úÖ Passed checks (3 passed)</summary>\n\n|     Check name     | Status   | Explanation                                                                                                                                                                       |\n| :----------------: | :------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n|  Description Check | ‚úÖ Passed | Check skipped - CodeRabbit‚Äôs high-level summary is enabled.                                                                                                                       |\n|     Title check    | ‚úÖ Passed | The title 'USB Device Control - Fresh Implementation' directly reflects the main objective of this comprehensive feature addition focused on USB device management functionality. |\n| Docstring Coverage | ‚úÖ Passed | Docstring coverage is 80.27% which is sufficient. The required threshold is 80.00%.                                                                                               |\n\n</details>\n\n<!-- pre_merge_checks_walkthrough_end -->\n\n<!-- finishing_touch_checkbox_start -->\n\n<details>\n<summary>‚ú® Finishing touches</summary>\n\n- [ ] <!-- {\"checkboxId\": \"7962f53c-55bc-4827-bfbf-6a18da830691\"} --> üìù Generate docstrings\n<details>\n<summary>üß™ Generate unit tests (beta)</summary>\n\n- [ ] <!-- {\"checkboxId\": \"f47ac10b-58cc-4372-a567-0e02b2c3d479\", \"radioGroupId\": \"utg-output-choice-group-unknown_comment_id\"} -->   Create PR with unit tests\n- [ ] <!-- {\"checkboxId\": \"07f1e7d6-8a8e-4e23-9900-8731c2c87f58\", \"radioGroupId\": \"utg-output-choice-group-unknown_comment_id\"} -->   Post copyable unit tests in a comment\n- [ ] <!-- {\"checkboxId\": \"6ba7b810-9dad-11d1-80b4-00c04fd430c8\", \"radioGroupId\": \"utg-output-choice-group-unknown_comment_id\"} -->   Commit unit tests in branch `feature/usb-device-control-v2`\n\n</details>\n\n</details>\n\n<!-- finishing_touch_checkbox_end -->\n\n<!-- tips_start -->\n\n---\n\nThanks for using [CodeRabbit](https://coderabbit.ai?utm_source=oss&utm_medium=github&utm_campaign=shipdocs/bastion-firewall&utm_content=6)! It's free for OSS, and your support helps us grow. If you like it, consider giving us a shout-out.\n\n<details>\n<summary>‚ù§Ô∏è Share</summary>\n\n- [X](https://twitter.com/intent/tweet?text=I%20just%20used%20%40coderabbitai%20for%20my%20code%20review%2C%20and%20it%27s%20fantastic%21%20It%27s%20free%20for%20OSS%20and%20offers%20a%20free%20trial%20for%20the%20proprietary%20code.%20Check%20it%20out%3A&url=https%3A//coderabbit.ai)\n- [Mastodon](https://mastodon.social/share?text=I%20just%20used%20%40coderabbitai%20for%20my%20code%20review%2C%20and%20it%27s%20fantastic%21%20It%27s%20free%20for%20OSS%20and%20offers%20a%20free%20trial%20for%20the%20proprietary%20code.%20Check%20it%20out%3A%20https%3A%2F%2Fcoderabbit.ai)\n- [Reddit](https://www.reddit.com/submit?title=Great%20tool%20for%20code%20review%20-%20CodeRabbit&text=I%20just%20used%20CodeRabbit%20for%20my%20code%20review%2C%20and%20it%27s%20fantastic%21%20It%27s%20free%20for%20OSS%20and%20offers%20a%20free%20trial%20for%20proprietary%20code.%20Check%20it%20out%3A%20https%3A//coderabbit.ai)\n- [LinkedIn](https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcoderabbit.ai&mini=true&title=Great%20tool%20for%20code%20review%20-%20CodeRabbit&summary=I%20just%20used%20CodeRabbit%20for%20my%20code%20review%2C%20and%20it%27s%20fantastic%21%20It%27s%20free%20for%20OSS%20and%20offers%20a%20free%20trial%20for%20proprietary%20code)\n\n</details>\n\n<sub>Comment `@coderabbitai help` to get the list of available commands and usage tips.</sub>\n\n<!-- tips_end -->\n\n<!-- internal state start -->\n\n\n<!-- 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 -->\n\n<!-- internal state end -->","createdAt":"2025-12-25T01:33:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690697645","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7b-5XJ","author":{"login":"qodo-code-review"},"authorAssociation":"CONTRIBUTOR","body":"## PR Compliance Guide üîç\n\n\n<!-- https://github.com/shipdocs/bastion-firewall/commit/daaef9d4123ee89bd278031d3516b609b5882b14 -->\n#### (Compliance updated until commit https://github.com/shipdocs/bastion-firewall/commit/daaef9d4123ee89bd278031d3516b609b5882b14)\nBelow is a summary of compliance checks for this PR:<br>\n<table><tbody><tr><td colspan='2'><strong>Security Compliance</strong></td></tr>\n<tr><td rowspan=1>‚ö™</td>\n<td><details><summary><strong>Unauthenticated IPC\n</strong></summary><br>\n\n<b>Description:</b> The GUI‚Üîdaemon Unix socket IPC appears unauthenticated (any process able to connect to <br><code>/run/bastion/daemon.sock</code> can act as the GUI and send responses), and while USB replies use <br>a nonce, the connection-approval path in <code>_ask_gui()</code> accepts JSON without any <br>anti-spoofing/authentication, potentially allowing a local attacker with socket access <br>(e.g., via the broad <code>users</code> group fallback) to force-allow network connections.<br> <strong><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR401-R646'>daemon.py [401-646]</a></strong><br>\n\n<details open><summary>Referred Code</summary>\n\n```python\ndef _setup_socket(self):\n    \"\"\"Setup Unix domain socket in /run/bastion for security\"\"\"\n    import grp\n\n    # Create socket directory if it doesn't exist\n    # /run is tmpfs, so this needs to be created each boot\n    if not os.path.exists(self.SOCKET_DIR):\n        os.makedirs(self.SOCKET_DIR, mode=0o755)\n        logger.info(f\"Created socket directory: {self.SOCKET_DIR}\")\n\n    if os.path.exists(self.SOCKET_PATH):\n        os.remove(self.SOCKET_PATH)\n\n    self.server_socket = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)\n    self.server_socket.bind(self.SOCKET_PATH)\n\n    # Set socket permissions: owner (root) + group read/write\n    # Try to use 'bastion' group, fall back to 'users' or world-readable\n    try:\n        socket_gid = None\n        socket_mode = 0o660  # rw-rw---- by default\n\n\n ... (clipped 225 lines)\n```\n\n</details></details></td></tr>\n<tr><td colspan='2'><strong>Ticket Compliance</strong></td></tr>\n<tr><td>‚ö™</td><td><details><summary>üé´ <strong>No ticket provided </strong></summary>\n\n\n- [ ] Create ticket/issue <!-- /create_ticket --create_ticket=true -->\n\n</details></td></tr>\n<tr><td colspan='2'><strong>Codebase Duplication Compliance</strong></td></tr>\n<tr><td>‚ö™</td><td><details><summary><strong>Codebase context is not defined </strong></summary>\n\n\nFollow the <a href='https://qodo-merge-docs.qodo.ai/core-abilities/rag_context_enrichment/'>guide</a> to enable codebase context checks.\n\n</details></td></tr>\n<tr><td colspan='2'><strong>Custom Compliance</strong></td></tr>\n<tr><td rowspan=3>üü¢</td><td>\n<details><summary><strong>Generic: Meaningful Naming and Self-Documenting Code</strong></summary><br>\n\n**Objective:** Ensure all identifiers clearly express their purpose and intent, making code <br>self-documenting<br>\n\n**Status:** Passed<br>\n\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td>\n<details><summary><strong>Generic: Robust Error Handling and Edge Case Management</strong></summary><br>\n\n**Objective:** Ensure comprehensive error handling that provides meaningful context and graceful <br>degradation<br>\n\n**Status:** Passed<br>\n\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td>\n<details><summary><strong>Generic: Security-First Input Validation and Data Handling</strong></summary><br>\n\n**Objective:** Ensure all data inputs are validated, sanitized, and handled securely to prevent <br>vulnerabilities<br>\n\n**Status:** Passed<br>\n\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td rowspan=2>üî¥</td>\n<td><details>\n<summary><strong>Generic: Secure Error Handling</strong></summary><br>\n\n**Objective:** To prevent the leakage of sensitive system information through error messages while <br>providing sufficient detail for internal debugging.<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f9f219109b878859f078120342e6af5b34efa439fd52b2b3cec00b97cb0fe859R1079-R1086'><strong>Exception shown to user</strong></a>: User-facing notifications include raw exception details (e.g., <code>Failed to disable UFW: </code><br><code>{e}</code>), which can leak internal system information instead of using a generic error message <br>with details only in logs.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ntry:\n    subprocess.run(['pkexec', '/usr/bin/ufw', 'disable'], check=True)\n    from .notification import show_notification\n    show_notification(self, \"Success\", \"UFW disabled.\")\nexcept Exception as e:\n    from .notification import show_notification\n    show_notification(self, \"Error\", f\"Failed to disable UFW: {e}\")\nself.refresh_ui()\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td><details>\n<summary><strong>Generic: Secure Logging Practices</strong></summary><br>\n\n**Objective:** To ensure logs are useful for debugging and auditing without exposing sensitive <br>information like PII, PHI, or cardholder data.<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR414-R440'><strong>PII in logs</strong></a>: The GUI logs the local username in plaintext (e.g., <code>User &#x27;{username}&#x27; ... USB </code><br><code>device</code>), which is PII and violates the requirement to avoid sensitive data in logs.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ndef allow_device(self, save_rule: bool = True):\n    \"\"\"User chose to allow the device.\"\"\"\n    import getpass\n    self.verdict = 'allow'\n    self.scope = self._get_selected_scope()\n    self.save_rule = save_rule\n    action = \"allowed\" if save_rule else \"allowed once\"\n    try:\n        username = getpass.getuser()\n    except Exception:\n        username = \"unknown\"\n    logger.info(f\"User '{username}' {action} USB device: {self.device.product_name} (scope={self.scope})\")\n    self.accept()\n\ndef block_device(self, save_rule: bool = True):\n    \"\"\"User chose to block the device.\"\"\"\n    import getpass\n    self.verdict = 'block'\n    self.scope = self._get_selected_scope()\n    self.save_rule = save_rule\n    action = \"blocked\" if save_rule else \"blocked once\"\n\n\n ... (clipped 6 lines)\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td rowspan=1>‚ö™</td>\n<td><details>\n<summary><strong>Generic: Comprehensive Audit Trails</strong></summary><br>\n\n**Objective:** To create a detailed and reliable record of critical system actions for security analysis <br>and compliance.<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR880-R910'><strong>Missing user context</strong></a>: Some critical security actions (e.g., USB device allow/block decisions) are logged without <br>a clear user identifier and standardized audit context, making event reconstruction <br>potentially incomplete.<br>\n<details open><summary>Referred Code</summary>\n\n```python\nwith self.socket_lock:\n    self.gui_socket.sendall(json.dumps(request).encode() + b'\\n')\n\nlogger.debug(f\"USB request sent, waiting for GUI response...\")\n\n# Wait for response (60 second timeout)\nif self.usb_response_event.wait(timeout=60):\n    with self.usb_pending_lock:\n        verdict = self.usb_response_verdict\n        scope = self.usb_response_scope\n        save_rule = self.usb_response_save_rule\n        self.usb_pending_device = None\n\n    if verdict == 'allow':\n        action = \"allowed\" if save_rule else \"allowed once\"\n        logger.info(f\"User {action} USB device: {device.product_name}\")\n        if save_rule:\n            self.usb_rule_manager.add_rule(device, 'allow', scope)\n        USBAuthorizer.authorize(device.bus_id)\n        self.stats['usb_devices_allowed'] += 1\n    else:\n\n\n ... (clipped 10 lines)\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n\n<tr><td align=\"center\" colspan=\"2\">\n\n- [ ] Update <!-- /compliance --update_compliance=true -->\n\n</td></tr></tbody></table>\n<details><summary>Compliance status legend</summary>\nüü¢ - Fully Compliant<br>\nüü° - Partial Compliant<br>\nüî¥ - Not Compliant<br>\n‚ö™ - Requires Further Human Verification<br>\nüè∑Ô∏è - Compliance label<br>\n</details>\n\n___\n\n#### Previous compliance checks\n\n<details>\n<summary>Compliance check up to commit <a href='https://github.com/shipdocs/bastion-firewall/commit/ba6c9352bd6e6326b1623756b592cd0b6a692ef3'>ba6c935</a></summary><br>\n<table><tbody><tr><td colspan='2'><strong>Security Compliance</strong></td></tr>\n<tr><td rowspan=1>‚ö™</td>\n<td><details><summary><strong>PATH hijacking\n</strong></summary><br>\n\n<b>Description:</b> The GUI invokes <code>pkexec</code> via <code>subprocess.run(['pkexec', ...])</code> which relies on the caller‚Äôs <br><code>PATH</code> to locate <code>pkexec</code>, enabling a realistic PATH-hijack risk if the environment is <br>compromised; use an absolute path like <code>/usr/bin/pkexec</code> (also check other <code>pkexec</code> call sites <br>such as <code>bastion/daemon.py</code> and <code>bastion/gui_qt.py</code> for the same pattern).<br> <strong><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR762-R873'>usb_gui.py [762-873]</a></strong><br>\n\n<details open><summary>Referred Code</summary>\n\n```python\npolicy_arg = '--authorize' if authorize else '--block'\npolicy_name = 'allow' if authorize else 'block'\n\ntry:\n    # Use the root helper - no dynamic code, just fixed arguments\n    # Use absolute path to prevent PATH hijacking via pkexec\n    result = subprocess.run(\n        ['pkexec', '/usr/bin/bastion-root-helper', 'usb-default-policy', 'set', policy_arg],\n        check=False,\n        capture_output=True,\n        text=True,\n        timeout=30\n    )\n\n    if result.returncode == 0:\n        logger.info(f\"USB default policy set to {policy_name}\")\n    elif result.returncode == 126:\n        # User cancelled pkexec authentication dialog\n        logger.info(\"USB policy change cancelled by user\")\n    else:\n        # Log details internally, show generic message to user\n\n\n ... (clipped 91 lines)\n```\n\n</details></details></td></tr>\n<tr><td colspan='2'><strong>Ticket Compliance</strong></td></tr>\n<tr><td>‚ö™</td><td><details><summary>üé´ <strong>No ticket provided </strong></summary>\n\n\n- [ ] Create ticket/issue <!-- /create_ticket --create_ticket=true -->\n\n</details></td></tr>\n<tr><td colspan='2'><strong>Codebase Duplication Compliance</strong></td></tr>\n<tr><td>‚ö™</td><td><details><summary><strong>Codebase context is not defined </strong></summary>\n\n\nFollow the <a href='https://qodo-merge-docs.qodo.ai/core-abilities/rag_context_enrichment/'>guide</a> to enable codebase context checks.\n\n</details></td></tr>\n<tr><td colspan='2'><strong>Custom Compliance</strong></td></tr>\n<tr><td rowspan=1>üü¢</td><td>\n<details><summary><strong>Generic: Meaningful Naming and Self-Documenting Code</strong></summary><br>\n\n**Objective:** Ensure all identifiers clearly express their purpose and intent, making code <br>self-documenting<br>\n\n**Status:** Passed<br>\n\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td rowspan=3>üî¥</td>\n<td><details>\n<summary><strong>Generic: Robust Error Handling and Edge Case Management</strong></summary><br>\n\n**Objective:** Ensure comprehensive error handling that provides meaningful context and graceful <br>degradation<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR752-R799'><strong>Missing import crash</strong></a>: New code calls <code>subprocess.run(...)</code> for privileged USB policy/rule operations without <br>importing <code>subprocess</code>, which will raise a runtime <code>NameError</code> and break the feature path.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ndef _set_usb_default_policy(self, authorize: bool):\n    \"\"\"\n    Set USB default authorization policy via bastion-root-helper.\n\n    Uses the dedicated root helper CLI to safely change USB policy\n    without any code injection risks.\n\n    Args:\n        authorize: True = allow new devices, False = block new devices\n    \"\"\"\n    policy_arg = '--authorize' if authorize else '--block'\n    policy_name = 'allow' if authorize else 'block'\n\n    try:\n        # Use the root helper - no dynamic code, just fixed arguments\n        # Use absolute path to prevent PATH hijacking via pkexec\n        result = subprocess.run(\n            ['pkexec', '/usr/bin/bastion-root-helper', 'usb-default-policy', 'set', policy_arg],\n            check=False,\n            capture_output=True,\n            text=True,\n\n\n ... (clipped 27 lines)\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td><details>\n<summary><strong>Generic: Secure Error Handling</strong></summary><br>\n\n**Objective:** To prevent the leakage of sensitive system information through error messages while <br>providing sufficient detail for internal debugging.<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f9f219109b878859f078120342e6af5b34efa439fd52b2b3cec00b97cb0fe859R1079-R1086'><strong>Exception shown to user</strong></a>: User-facing notifications include raw exception text (e.g., <code>Failed to disable UFW: {e}</code>), <br>which can leak internal system details rather than keeping detailed errors only in logs.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ntry:\n    subprocess.run(['pkexec', '/usr/bin/ufw', 'disable'], check=True)\n    from .notification import show_notification\n    show_notification(self, \"Success\", \"UFW disabled.\")\nexcept Exception as e:\n    from .notification import show_notification\n    show_notification(self, \"Error\", f\"Failed to disable UFW: {e}\")\nself.refresh_ui()\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td><details>\n<summary><strong>Generic: Secure Logging Practices</strong></summary><br>\n\n**Objective:** To ensure logs are useful for debugging and auditing without exposing sensitive <br>information like PII, PHI, or cardholder data.<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR413-R439'><strong>Unstructured sensitive logging</strong></a>: Security-relevant USB authorization decisions are logged as unstructured free-text and <br>include user identifiers and device identifiers, reducing auditability and increasing the <br>risk of sensitive data exposure in logs.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ndef allow_device(self, save_rule: bool = True):\n    \"\"\"User chose to allow the device.\"\"\"\n    import getpass\n    self.verdict = 'allow'\n    self.scope = self._get_selected_scope()\n    self.save_rule = save_rule\n    action = \"allowed\" if save_rule else \"allowed once\"\n    try:\n        username = getpass.getuser()\n    except Exception:\n        username = \"unknown\"\n    logger.info(f\"User '{username}' {action} USB device: {self.device.product_name} (scope={self.scope})\")\n    self.accept()\n\ndef block_device(self, save_rule: bool = True):\n    \"\"\"User chose to block the device.\"\"\"\n    import getpass\n    self.verdict = 'block'\n    self.scope = self._get_selected_scope()\n    self.save_rule = save_rule\n    action = \"blocked\" if save_rule else \"blocked once\"\n\n\n ... (clipped 6 lines)\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td rowspan=2>‚ö™</td>\n<td><details>\n<summary><strong>Generic: Comprehensive Audit Trails</strong></summary><br>\n\n**Objective:** To create a detailed and reliable record of critical system actions for security analysis <br>and compliance.<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR413-R439'><strong>Missing audit context</strong></a>: Critical USB allow/block actions are logged but may lack required audit context such as a <br>stable user identifier (UID) and an explicit outcome for privileged operations.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ndef allow_device(self, save_rule: bool = True):\n    \"\"\"User chose to allow the device.\"\"\"\n    import getpass\n    self.verdict = 'allow'\n    self.scope = self._get_selected_scope()\n    self.save_rule = save_rule\n    action = \"allowed\" if save_rule else \"allowed once\"\n    try:\n        username = getpass.getuser()\n    except Exception:\n        username = \"unknown\"\n    logger.info(f\"User '{username}' {action} USB device: {self.device.product_name} (scope={self.scope})\")\n    self.accept()\n\ndef block_device(self, save_rule: bool = True):\n    \"\"\"User chose to block the device.\"\"\"\n    import getpass\n    self.verdict = 'block'\n    self.scope = self._get_selected_scope()\n    self.save_rule = save_rule\n    action = \"blocked\" if save_rule else \"blocked once\"\n\n\n ... (clipped 6 lines)\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n<tr><td><details>\n<summary><strong>Generic: Security-First Input Validation and Data Handling</strong></summary><br>\n\n**Objective:** Ensure all data inputs are validated, sanitized, and handled securely to prevent <br>vulnerabilities<br>\n\n**Status:** <br><a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR401-R444'><strong>IPC auth depends on perms</strong></a>: Although USB GUI responses are nonce-validated, overall IPC trust still depends on correct <br><code>/run/bastion/daemon.sock</code> group ownership and polkit/root-helper enforcement which cannot <br>be fully verified from the partial diff.<br>\n<details open><summary>Referred Code</summary>\n\n```python\ndef _setup_socket(self):\n    \"\"\"Setup Unix domain socket in /run/bastion for security\"\"\"\n    import grp\n\n    # Create socket directory if it doesn't exist\n    # /run is tmpfs, so this needs to be created each boot\n    if not os.path.exists(self.SOCKET_DIR):\n        os.makedirs(self.SOCKET_DIR, mode=0o755)\n        logger.info(f\"Created socket directory: {self.SOCKET_DIR}\")\n\n    if os.path.exists(self.SOCKET_PATH):\n        os.remove(self.SOCKET_PATH)\n\n    self.server_socket = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)\n    self.server_socket.bind(self.SOCKET_PATH)\n\n    # Set socket permissions: owner (root) + group read/write\n    # Try to use 'bastion' group, fall back to 'users' or world-readable\n    try:\n        socket_gid = None\n        socket_mode = 0o660  # rw-rw---- by default\n\n\n ... (clipped 23 lines)\n```\n\n</details>\n\n> Learn more about managing compliance <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#configuration-options'>generic rules</a> or creating your own <a href='https://qodo-merge-docs.qodo.ai/tools/compliance/#custom-compliance'>custom rules</a>\n</details></td></tr>\n\n<tr><td align=\"center\" colspan=\"2\">\n\n <!-- /compliance --update_compliance=true -->\n\n</td></tr></tbody></table>\n</details>","createdAt":"2025-12-25T01:33:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690698185","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7b-5pO","author":{"login":"qodo-code-review"},"authorAssociation":"CONTRIBUTOR","body":"## PR Code Suggestions ‚ú®\n<!-- 94d9a1f -->\n\nLatest suggestions up to 94d9a1f\n\n<table><thead><tr><td><strong>Category</strong></td><td align=left><strong>Suggestion&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </strong></td><td align=center><strong>Impact</strong></td></tr><tbody><tr><td rowspan=5>Possible issue</td>\n<td>\n\n\n\n<details><summary>Make socket reads message-framed</summary>\n\n___\n\n**Correct a critical bug by ensuring the <code>_ask_gui</code> function uses a buffered, <br>newline-delimited reading strategy for JSON messages, consistent with the rest <br>of the daemon's socket protocol.**\n\n[bastion/daemon.py [622-645]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR622-R645)\n\n```diff\n-response = self.gui_socket.recv(4096).decode().strip()\n-\n-if not response:\n-    return False\n-\n-data = json.loads(response)\n-\n-# Handle case where a USB response arrives while waiting for connection decision\n-# This is a race condition - keep reading until we get the connection response\n original_timeout = self.gui_socket.gettimeout()\n+buffer = \"\"\n try:\n     self.gui_socket.settimeout(60.0)\n-    while data.get('type') == 'usb_response':\n-        self.handle_usb_response(data)\n-        # Read next message to get the actual connection response\n-        try:\n-            response = self.gui_socket.recv(4096).decode().strip()\n-            if not response:\n-                logger.warning(\"Empty response after handling USB response\")\n-                return True if learning_mode else False\n-            data = json.loads(response)\n-        except json.JSONDecodeError as e:\n-            logger.warning(f\"Error parsing connection response after USB: {e}\")\n+\n+    while True:\n+        chunk = self.gui_socket.recv(4096)\n+        if not chunk:\n             return True if learning_mode else False\n-except socket.timeout:\n-    logger.warning(\"Socket timeout waiting for connection response after USB\")\n+\n+        buffer += chunk.decode('utf-8', errors='replace')\n+        if '\\n' not in buffer:\n+            continue\n+\n+        line, buffer = buffer.split('\\n', 1)\n+        line = line.strip()\n+        if not line:\n+            continue\n+\n+        data = json.loads(line)\n+\n+        # If a USB response arrives while waiting, handle it and keep reading\n+        if data.get('type') == 'usb_response':\n+            self.handle_usb_response(data)\n+            continue\n+\n+        break\n+except (json.JSONDecodeError, socket.timeout):\n     return True if learning_mode else False\n finally:\n     self.gui_socket.settimeout(original_timeout)\n```\n\n\n\n`[To ensure code accuracy, apply this suggestion manually]`\n\n\n<details><summary>Suggestion importance[1-10]: 9</summary>\n\n__\n\nWhy: This suggestion identifies a critical bug in the socket communication protocol that could lead to data corruption, parsing errors, or deadlocks, and provides a robust fix.\n\n</details></details></td><td align=center>High\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Parse logged-in username correctly</summary>\n\n___\n\n**Correctly parse the output of the <code>who</code> command by splitting the line and using <br>only the first field as the username, preventing a crash when looking up the <br>user.**\n\n[bastion/gui_manager.py [96-109]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR96-R109)\n\n```diff\n if result.stdout:\n     # Filter for real users (UID >= 1000) to avoid system accounts\n     users = result.stdout.strip().split('\\n')\n     for line in users:\n-        if line.strip():\n-            user = line.strip()\n-            # Verify this is a real user account\n-            try:\n-                import pwd\n-                pw = pwd.getpwnam(user)\n-                if pw and pw.pw_uid >= 1000:\n-                    break  # Found valid user\n-            except (KeyError, ImportError):\n-                pass\n+        line = line.strip()\n+        if not line:\n+            continue\n+        candidate = line.split(None, 1)[0]  # \"who\" format: user tty date...\n+        # Verify this is a real user account\n+        try:\n+            import pwd\n+            pw = pwd.getpwnam(candidate)\n+            if pw and pw.pw_uid >= 1000:\n+                user = candidate\n+                break  # Found valid user\n+        except (KeyError, ImportError):\n+            pass\n```\n\n\n\n`[To ensure code accuracy, apply this suggestion manually]`\n\n\n<details><summary>Suggestion importance[1-10]: 8</summary>\n\n__\n\nWhy: The suggestion correctly identifies a bug in the new logic for finding the logged-in user, which would fail because it does not properly parse the output of the `who` command.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Normalize request field types</summary>\n\n___\n\n**Add type validation and coercion for <code>device_class</code> and <code>interface_classes</code> when <br>handling a <code>usb_request</code> to prevent potential crashes from malformed data.**\n\n[bastion-gui.py [294-303]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-187b1e5910f096aae7417e760f849b9a564ea1ed82afd7d450e58fa8cced9a57R294-R303)\n\n```diff\n+raw_device_class = req.get('device_class', 0)\n+try:\n+    device_class = int(raw_device_class)\n+except (TypeError, ValueError):\n+    device_class = 0\n+\n+raw_ifaces = req.get('interface_classes', [])\n+if not isinstance(raw_ifaces, list):\n+    raw_ifaces = []\n+interface_classes = []\n+for v in raw_ifaces:\n+    try:\n+        interface_classes.append(int(v))\n+    except (TypeError, ValueError):\n+        continue\n+\n device = USBDeviceInfo(\n     vendor_id=req.get('vendor_id', '0000'),\n     product_id=req.get('product_id', '0000'),\n     vendor_name=req.get('vendor_name', 'Unknown'),\n     product_name=req.get('product_name', 'Unknown Device'),\n-    device_class=req.get('device_class', 0),\n-    interface_classes=req.get('interface_classes', []),\n+    device_class=device_class,\n+    interface_classes=interface_classes,\n     serial=req.get('serial'),\n     bus_id=req.get('bus_id', '1-1')\n )\n```\n\n\n- [ ] **Apply / Chat** <!-- /improve --apply_suggestion=2 -->\n\n\n<details><summary>Suggestion importance[1-10]: 7</summary>\n\n__\n\nWhy: The suggestion improves robustness by adding type validation for data received over the socket, preventing potential `TypeError` exceptions if the daemon sends data in an unexpected format.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Fix directory permission enforcement</summary>\n\n___\n\n**Fix a bug in directory permission setting by checking for the directory's <br>existence before creating it, ensuring <code>chmod</code> is correctly called on new <br>directories.**\n\n[bastion/usb_rules.py [154-163]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-da629a89eec0c480da3d96816c0ba7044d8036e4822f9bb16483d0cdd014fca0R154-R163)\n\n```diff\n+existed_before = parent.exists()\n parent.mkdir(parents=True, exist_ok=True)\n \n # Verify it's still not a symlink after creation (race condition mitigation)\n if parent.is_symlink():\n     logger.error(f\"Directory {parent} became a symlink, refusing to use\")\n     raise SecurityError(f\"Directory {parent} is a symlink\")\n \n # Only chmod if we created the directory (don't change existing permissions)\n-if not parent.exists():\n+if not existed_before:\n     os.chmod(parent, self.DIR_MODE)\n```\n\n\n- [ ] **Apply / Chat** <!-- /improve --apply_suggestion=3 -->\n\n\n<details><summary>Suggestion importance[1-10]: 6</summary>\n\n__\n\nWhy: The suggestion correctly identifies a logic bug where directory permissions are not applied on initial creation, and the proposed fix of checking existence before `mkdir` is correct.\n\n</details></details></td><td align=center>Low\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Ensure lock directory exists</summary>\n\n___\n\n**Ensure the lock file directory is always created, even when <code>XDG_RUNTIME_DIR</code> is <br>set, to prevent startup failures in certain environments.**\n\n[bastion-gui.py [23-28]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-187b1e5910f096aae7417e760f849b9a564ea1ed82afd7d450e58fa8cced9a57R23-R28)\n\n```diff\n _runtime_dir = _os.environ.get('XDG_RUNTIME_DIR')\n if not _runtime_dir:\n     # Fallback to user-specific cache directory\n     _runtime_dir = _os.path.join(_os.path.expanduser('~'), '.cache', 'bastion')\n-    _os.makedirs(_runtime_dir, mode=0o700, exist_ok=True)\n+\n+# Ensure runtime directory exists and is private\n+_os.makedirs(_runtime_dir, mode=0o700, exist_ok=True)\n+try:\n+    _os.chmod(_runtime_dir, 0o700)\n+except OSError:\n+    pass\n+\n LOCK_FILE = _os.path.join(_runtime_dir, 'bastion-gui.lock')\n```\n\n\n- [ ] **Apply / Chat** <!-- /improve --apply_suggestion=4 -->\n\n\n<details><summary>Suggestion importance[1-10]: 6</summary>\n\n__\n\nWhy: The suggestion correctly identifies an edge case where `XDG_RUNTIME_DIR` is set but does not exist, which would cause the application to fail on startup.\n\n</details></details></td><td align=center>Low\n\n</td></tr><tr><td rowspan=1>General</td>\n<td>\n\n\n\n<details><summary>Correct USB protection status logic</summary>\n\n___\n\n**Correct the USB protection status logic to show \"Protected\" only when all USB <br>controllers are confirmed to be in a blocking state, preventing a misleading <br>status.**\n\n[bastion/gui_qt.py [955-964]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f9f219109b878859f078120342e6af5b34efa439fd52b2b3cec00b97cb0fe859R955-R964)\n\n```diff\n-usb_protected = False\n usb_controllers = 0\n+protected_controllers = 0\n for path in Path('/sys/bus/usb/devices').glob('usb*/authorized_default'):\n     usb_controllers += 1\n     try:\n         val = path.read_text().strip()\n         if val == '0':\n-            usb_protected = True\n+            protected_controllers += 1\n     except (OSError, PermissionError) as e:\n         logger.debug(f\"Could not read {path}: {e}\")\n \n+usb_protected = (usb_controllers > 0 and protected_controllers == usb_controllers)\n+\n```\n\n\n- [ ] **Apply / Chat** <!-- /improve --apply_suggestion=5 -->\n\n\n<details><summary>Suggestion importance[1-10]: 7</summary>\n\n__\n\nWhy: The suggestion correctly points out that the USB protection status is misleading and potentially unsafe, and the proposed fix ensures the status is only \"Protected\" if all controllers are secured.\n\n</details></details></td><td align=center>Medium\n\n</td></tr>\n<tr><td align=\"center\" colspan=\"2\">\n\n- [ ] More <!-- /improve --more_suggestions=true -->\n\n</td><td></td></tr></tbody></table>\n\n___\n\n#### Previous suggestions\n\n\n<details><summary>‚úÖ Suggestions up to commit daaef9d</summary>\n<br><table><thead><tr><td><strong>Category</strong></td><td align=left><strong>Suggestion&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </strong></td><td align=center><strong>Impact</strong></td></tr><tbody><tr><td rowspan=4>Possible issue</td>\n<td>\n\n\n\n<details><summary>Authorize low-risk fallback decisions</summary>\n\n___\n\n**Add the missing <code>USBAuthorizer.authorize()</code> call in the fallback logic for <br>low-risk USB devices to ensure they are correctly enabled when the GUI is <br>unavailable or times out.**\n\n[bastion/daemon.py [844-920]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR844-R920)\n\n```diff\n if not self.gui_socket:\n     logger.warning(\"No GUI connected - cannot prompt for USB device decision\")\n     # Default: block high-risk, allow low-risk\n     if device.is_high_risk:\n         logger.warning(f\"Blocking high-risk USB device without GUI: {device.product_name}\")\n         USBAuthorizer.deauthorize(device.bus_id)\n         self.stats['usb_devices_blocked'] += 1\n     else:\n         logger.info(f\"Allowing low-risk USB device without GUI: {device.product_name}\")\n+        if not USBAuthorizer.authorize(device.bus_id):\n+            logger.warning(f\"Failed to authorize low-risk USB device without GUI: {device.product_name}\")\n         self.stats['usb_devices_allowed'] += 1\n     return\n ...\n else:\n     # Timeout - default based on risk\n     logger.warning(f\"USB decision timeout for: {device.product_name}\")\n     with self.usb_pending_lock:\n         self.usb_pending_device = None\n         self.usb_pending_nonce = None\n \n     if device.is_high_risk:\n         logger.warning(f\"Blocking high-risk USB device on timeout: {device.product_name}\")\n         USBAuthorizer.deauthorize(device.bus_id)\n         self.stats['usb_devices_blocked'] += 1\n     else:\n         logger.info(f\"Allowing low-risk USB device on timeout: {device.product_name}\")\n+        if not USBAuthorizer.authorize(device.bus_id):\n+            logger.warning(f\"Failed to authorize low-risk USB device on timeout: {device.product_name}\")\n         self.stats['usb_devices_allowed'] += 1\n```\n\n\n\n\n\n\n<details><summary>Suggestion importance[1-10]: 9</summary>\n\n__\n\nWhy: The suggestion correctly identifies a critical bug where the fallback logic for low-risk devices fails to authorize them, rendering the feature ineffective in those scenarios.\n\n</details></details></td><td align=center>High\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Lock rule writes against reloads</summary>\n\n___\n\n**Prevent a race condition by acquiring <code>self.usb_rules_lock</code> when adding new USB <br>rules and updating the <code>self.usb_rules_last_modified</code> timestamp to avoid lost <br>updates.**\n\n[bastion/daemon.py [886-906]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR886-R906)\n\n```diff\n if self.usb_response_event.wait(timeout=60):\n     with self.usb_pending_lock:\n         verdict = self.usb_response_verdict\n         scope = self.usb_response_scope\n         save_rule = self.usb_response_save_rule\n         self.usb_pending_device = None\n \n     if verdict == 'allow':\n         action = \"allowed\" if save_rule else \"allowed once\"\n         logger.info(f\"User {action} USB device: {device.product_name}\")\n         if save_rule:\n-            self.usb_rule_manager.add_rule(device, 'allow', scope)\n+            with self.usb_rules_lock:\n+                self.usb_rule_manager.add_rule(device, 'allow', scope)\n+                try:\n+                    self.usb_rules_last_modified = self.usb_rule_manager.db_path.stat().st_mtime\n+                except OSError:\n+                    pass\n         USBAuthorizer.authorize(device.bus_id)\n         self.stats['usb_devices_allowed'] += 1\n     else:\n         action = \"blocked\" if save_rule else \"blocked once\"\n         logger.info(f\"User {action} USB device: {device.product_name}\")\n         if save_rule:\n-            self.usb_rule_manager.add_rule(device, 'block', scope)\n+            with self.usb_rules_lock:\n+                self.usb_rule_manager.add_rule(device, 'block', scope)\n+                try:\n+                    self.usb_rules_last_modified = self.usb_rule_manager.db_path.stat().st_mtime\n+                except OSError:\n+                    pass\n         USBAuthorizer.deauthorize(device.bus_id)\n         self.stats['usb_devices_blocked'] += 1\n```\n\n\n <!-- /improve --apply_suggestion=1 -->\n\n\n<details><summary>Suggestion importance[1-10]: 8</summary>\n\n__\n\nWhy: The suggestion correctly identifies a race condition between adding a new USB rule and the periodic rule-reloading mechanism, which could lead to lost rule updates.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Only update UI on success</summary>\n\n___\n\n**Refactor <code>_toggle_usb_protection</code> to only update the UI and internal state after <br>confirming that the underlying <code>_set_usb_default_policy</code> operation was successful.**\n\n[bastion/usb_gui.py [707-798]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR707-R798)\n\n```diff\n def _toggle_usb_protection(self):\n     \"\"\"Toggle USB protection on/off.\"\"\"\n \n-    self.usb_enabled = not self.usb_enabled\n+    desired_enabled = not self.usb_enabled\n \n-    if self.usb_enabled:\n+    if desired_enabled:\n         # Enable: set authorized_default=0 (block new devices)\n-        ...\n-        # Set default to block (authorized_default=0)\n-        self._set_usb_default_policy(authorize=False)\n+        if not self._set_usb_default_policy(authorize=False):\n+            return\n+        self.usb_enabled = True\n+        self.btn_toggle.setText(STRINGS[\"usb_protection_disable\"])\n+        self.btn_toggle.setStyleSheet(f\"\"\"\n+            QPushButton {{\n+                background-color: {COLORS['danger']};\n+                color: white;\n+                border: none;\n+                padding: 8px 16px;\n+                border-radius: 4px;\n+                font-weight: bold;\n+            }}\n+            QPushButton:hover {{\n+                background-color: #c0392b;\n+            }}\n+        \"\"\")\n+        self.lbl_status.setText(STRINGS[\"usb_protection_active\"])\n+        self.lbl_status.setStyleSheet(f\"font-size: 16px; font-weight: bold; color: {COLORS['success']};\")\n     else:\n         # Disable: set authorized_default=1 (allow new devices)\n-        ...\n-        # Set default to allow (authorized_default=1)\n-        self._set_usb_default_policy(authorize=True)\n+        if not self._set_usb_default_policy(authorize=True):\n+            return\n+        self.usb_enabled = False\n+        self.btn_toggle.setText(STRINGS[\"usb_protection_enable\"])\n+        self.btn_toggle.setStyleSheet(f\"\"\"\n+            QPushButton {{\n+                background-color: {COLORS['success']};\n+                color: white;\n+                border: none;\n+                padding: 8px 16px;\n+                border-radius: 4px;\n+                font-weight: bold;\n+            }}\n+            QPushButton:hover {{\n+                background-color: #27ae60;\n+            }}\n+        \"\"\")\n+        self.lbl_status.setText(STRINGS[\"usb_protection_disabled\"])\n+        self.lbl_status.setStyleSheet(f\"font-size: 16px; font-weight: bold; color: {COLORS['danger']};\")\n \n-def _set_usb_default_policy(self, authorize: bool):\n+def _set_usb_default_policy(self, authorize: bool) -> bool:\n     \"\"\"\n     Set USB default authorization policy via bastion-root-helper.\n-    ...\n+\n+    Returns:\n+        True if policy changed successfully, False otherwise.\n     \"\"\"\n     policy_arg = '--authorize' if authorize else '--block'\n     policy_name = 'allow' if authorize else 'block'\n \n     try:\n-        ...\n+        result = subprocess.run(\n+            ['pkexec', '/usr/bin/bastion-root-helper', 'usb-default-policy', 'set', policy_arg],\n+            check=False,\n+            capture_output=True,\n+            text=True,\n+            timeout=30\n+        )\n+\n         if result.returncode == 0:\n             logger.info(f\"USB default policy set to {policy_name}\")\n+            return True\n         elif result.returncode == 126:\n-            # User cancelled pkexec authentication dialog\n             logger.info(\"USB policy change cancelled by user\")\n+            return False\n         else:\n-            ...\n+            logger.warning(f\"Failed to set USB policy: {result.stderr}\")\n+            from bastion.notification import show_notification\n+            show_notification(self, \"Error\", \"Failed to change USB policy. Check logs for details.\")\n+            return False\n \n+    except subprocess.TimeoutExpired:\n+        logger.error(\"USB policy change timed out\")\n+        from bastion.notification import show_notification\n+        show_notification(self, \"Timeout\", \"USB policy change timed out\")\n+        return False\n+    except FileNotFoundError:\n+        logger.error(\"bastion-root-helper not found\")\n+        from bastion.notification import show_notification\n+        show_notification(self, \"Error\", \"Root helper not installed. Please reinstall Bastion.\")\n+        return False\n+    except Exception as e:\n+        logger.error(f\"Failed to set USB policy: {e}\")\n+        return False\n+\n```\n\n\n\n\n\n\n<details><summary>Suggestion importance[1-10]: 7</summary>\n\n__\n\nWhy: The suggestion correctly points out that the UI state can become desynchronized from the actual system state if the privileged operation fails, which is a valid user experience issue.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>Read process environ as bytes</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit changed reading /proc/<pid>/environ from text mode ('r') to binary mode ('rb'), splitting on NUL bytes (b'\\0') and decoding each entry safely, preventing UnicodeDecodeError issues as suggested (though implemented via per-variable decode with errors='replace' and extra exception handling rather than decoding only DISPLAY value).\n\n\ncode diff:\n\n```diff\n@@ -128,17 +140,21 @@\n                 for pid in pids:\n                     if pid and pid.isdigit():\n                         try:\n-                            with open(f'/proc/{pid}/environ', 'r') as f:\n-                                # /proc environ uses NUL separators\n-                                for var in f.read().split('\\0'):\n-                                    if var.startswith('DISPLAY='):\n-                                        display = var.split('=', 1)[1]\n+                            with open(f'/proc/{pid}/environ', 'rb') as f:\n+                                # /proc environ uses NUL separators, read as binary to avoid decode issues\n+                                for var in f.read().split(b'\\0'):\n+                                    try:\n+                                        var_str = var.decode('utf-8', errors='replace')\n+                                    except UnicodeDecodeError:\n+                                        continue  # Skip malformed entries\n+                                    if var_str.startswith('DISPLAY='):\n+                                        display = var_str.split('=', 1)[1]\n                                         if display:\n                                             env['DISPLAY'] = display\n                                             logger.info(f\"Found DISPLAY from /proc/{pid}: {display}\")\n                                             display_found = True\n                                             break\n-                        except (OSError, PermissionError):\n+                        except (OSError, PermissionError, UnicodeDecodeError):\n                             continue\n```\n\n</details>\n\n\n___\n\n**Read the process environment file in binary mode (<code>'rb'</code>) and decode variables <br>individually to prevent potential <code>UnicodeDecodeError</code>.**\n\n[bastion/gui_manager.py [131-140]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR131-R140)\n\n```diff\n-with open(f'/proc/{pid}/environ', 'r') as f:\n-    # /proc environ uses NUL separators\n-    for var in f.read().split('\\0'):\n-        if var.startswith('DISPLAY='):\n-            display = var.split('=', 1)[1]\n+with open(f'/proc/{pid}/environ', 'rb') as f:\n+    # /proc environ uses NUL separators and may contain non-UTF8 bytes\n+    for var in f.read().split(b'\\0'):\n+        if var.startswith(b'DISPLAY='):\n+            display = var.split(b'=', 1)[1].decode('utf-8', errors='ignore')\n             if display:\n                 env['DISPLAY'] = display\n                 logger.info(f\"Found DISPLAY from /proc/{pid}: {display}\")\n                 display_found = True\n                 break\n```\n\n\n`[Suggestion processed]`\n\n\n<details><summary>Suggestion importance[1-10]: 7</summary>\n\n__\n\nWhy: The suggestion correctly identifies that reading `/proc/<pid>/environ` in text mode is fragile and can cause a `UnicodeDecodeError`, proposing a robust fix by reading in binary mode.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td rowspan=2>Security</td>\n<td>\n\n\n\n<details><summary>Fully drop inherited group privileges<!-- not_implemented --></summary>\n\n___\n\n**Harden the privilege drop in <code>demote_to_user</code> by clearing supplementary groups <br>with <code>os.setgroups([])</code> and setting a restrictive umask with <code>os.umask(0o077)</code>.**\n\n[bastion/gui_manager.py [216-219]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR216-R219)\n\n```diff\n def demote_to_user():\n     \"\"\"Drop privileges to target user before exec\"\"\"\n+    os.setgroups([])\n     os.setgid(user_gid)\n     os.setuid(user_uid)\n+    os.umask(0o077)\n```\n\n\n <!-- /improve --apply_suggestion=4 -->\n\n\n<details><summary>Suggestion importance[1-10]: 8</summary>\n\n__\n\nWhy: This is a valid security hardening suggestion that ensures the process fully drops all elevated group privileges, reducing the potential attack surface.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Restrict runtime directory permissions</summary>\n\n___\n\n**Restrict the permissions of the <code>/run/bastion</code> directory from <code>0755</code> to a more <br>secure <code>0750</code> to limit access.**\n\n[bastion.conf [7]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-23105155a7880df618edea8728860224e46b732b39ecf6761d4681b301619abfR7-R7)\n\n```diff\n-d /run/bastion 0755 root root -\n+d /run/bastion 0750 root root -\n```\n\n\n <!-- /improve --apply_suggestion=5 -->\n\n\n<details><summary>Suggestion importance[1-10]: 6</summary>\n\n__\n\nWhy: The suggestion correctly points out that the directory permissions are too permissive and proposes a more secure default, which is a good security hardening practice.\n\n</details></details></td><td align=center>Low\n\n</td></tr>\n<tr><td align=\"center\" colspan=\"2\">\n\n <!-- /improve_multi --more_suggestions=true -->\n\n</td><td></td></tr></tbody></table>\n\n</details>\n<details><summary>‚úÖ Suggestions up to commit ba6c935</summary>\n<br><table><thead><tr><td><strong>Category</strong></td><td align=left><strong>Suggestion&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </strong></td><td align=center><strong>Impact</strong></td></tr><tbody><tr><td rowspan=1>High-level</td>\n<td>\n\n\n\n<details><summary>Consider using a dedicated USB management daemon<!-- not_implemented --></summary>\n\n___\n\n**Instead of implementing custom USB monitoring and complex GUI management from a <br>root process, integrate with a dedicated, security-audited daemon like USBGuard. <br>This would simplify the architecture by offloading device monitoring and rule <br>management.**\n\n\n### Examples:\n\n\n\n<details>\n<summary>\n<a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR119-R131\">bastion/daemon.py [119-131]</a>\n</summary>\n\n\n\n```python\n        # USB Device Control\n        self.usb_monitor: Optional[USBMonitor] = None\n        self.usb_rule_manager = USBRuleManager()\n        self.usb_rules_lock = threading.Lock()  # Lock for thread-safe rule reloading\n        self.usb_rules_last_modified = 0  # Track last modification time\n        self.usb_pending_lock = threading.Lock()\n        self.usb_pending_device: Optional[USBDeviceInfo] = None\n        self.usb_pending_nonce: Optional[str] = None  # Anti-spoofing nonce\n        self.usb_response_event = threading.Event()\n        self.usb_response_verdict: Optional[Verdict] = None\n\n ... (clipped 3 lines)\n```\n</details>\n\n\n\n<details>\n<summary>\n<a href=\"https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR71-R240\">bastion/gui_manager.py [71-240]</a>\n</summary>\n\n\n\n```python\n    def start_gui(self):\n        \"\"\"Start GUI application in background as the logged-in user\"\"\"\n        if not self.gui_path:\n            logger.error(\"Cannot start GUI: executable not found\")\n            return False\n\n        if self.is_gui_running():\n            logger.debug(\"GUI already running\")\n            return True\n\n\n ... (clipped 160 lines)\n```\n</details>\n\n\n\n\n### Solution Walkthrough:\n\n\n\n#### Before:\n```python\n# bastion/daemon.py\nclass BastionDaemon:\n    def start(self):\n        # ...\n        self._start_usb_monitor()\n        # Periodically check and start GUI if not running\n        self._ensure_gui_running()\n\n    def _start_usb_monitor(self):\n        # Custom USB monitoring using pyudev\n        self.usb_monitor = USBMonitor(callback=self._handle_usb_event)\n        self.usb_monitor.start()\n\n    def _handle_usb_event(self, device, action):\n        # Custom rule checking and decision logic\n        verdict = self.usb_rule_manager.get_verdict(device)\n        if verdict is None:\n            self._prompt_usb_decision(device)\n\n    def _prompt_usb_decision(self, device):\n        # Sends custom message to GUI over a socket\n        self.gui_socket.sendall(...)\n\n```\n\n\n\n#### After:\n```python\n# bastion/daemon.py\nclass BastionDaemon:\n    def start(self):\n        # ...\n        # No longer needs to manage USB or GUI lifecycle\n        self.connect_to_usbguard_ipc()\n\n    def connect_to_usbguard_ipc(self):\n        # Connect to the standard USBGuard daemon's IPC\n        # to listen for device events.\n        self.usbguard_listener = USBGuardIPCListener(self.handle_usbguard_event)\n        self.usbguard_listener.start()\n\n    def handle_usbguard_event(self, event):\n        # An event from USBGuard indicates a device needs a decision\n        if event.needs_decision:\n            # Send request to our GUI to show a prompt\n            self.send_gui_request(event.device_info)\n\n    def handle_gui_response(self, decision):\n        # Send user's decision back to USBGuard via its IPC\n        USBGuardIPCClient.send_decision(decision)\n\n```\n\n\n\n\n<details><summary>Suggestion importance[1-10]: 9</summary>\n\n__\n\nWhy: This is a critical architectural suggestion that correctly identifies the high complexity and potential security risks of re-implementing a USB management system, proposing a more robust and standard solution.\n\n\n</details></details></td><td align=center>High\n\n</td></tr><tr><td rowspan=4>Possible issue</td>\n<td>\n\n\n\n<details><summary>Fix race condition in GUI message reader</summary>\n\n___\n\n**Fix a race condition in the GUI message reader by using the <code>socket_lock</code> around <br>the <code>self.gui_socket.recv()</code> call. This prevents the reader thread from consuming <br>messages intended for other parts of the application.**\n\n[bastion/daemon.py [291-338]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR291-R338)\n\n```diff\n def _read_gui_messages(self):\n     \"\"\"Read messages from GUI in background (for USB responses etc.)\"\"\"\n     buffer = \"\"\n     MAX_BUFFER_SIZE = 65536  # 64KB limit to prevent memory exhaustion\n     try:\n         while self.running and self.gui_socket:\n             # Avoid race with _ask_gui: if there are pending connection requests,\n             # let _ask_gui own socket reads to prevent stealing responses\n             with self.request_lock:\n                 has_pending = bool(self.pending_requests)\n             if has_pending:\n                 time.sleep(0.1)\n                 continue\n-            try:\n-                data = self.gui_socket.recv(4096)\n-                if not data:\n-                    logger.warning(\"GUI disconnected\")\n+            \n+            # Acquire socket lock to prevent race condition with _ask_gui\n+            with self.socket_lock:\n+                # Re-check if GUI socket is still valid after acquiring lock\n+                if not self.gui_socket:\n                     break\n                 try:\n-                    buffer += data.decode('utf-8', errors='replace')\n-                except UnicodeDecodeError:\n-                    logger.warning(\"Invalid UTF-8 data from GUI, skipping\")\n-                    continue\n-                # Prevent buffer overflow from malicious/buggy GUI\n-                if len(buffer) > MAX_BUFFER_SIZE:\n-                    logger.warning(\"GUI message buffer overflow, resetting\")\n-                    buffer = \"\"\n-                    continue\n-                while '\\n' in buffer:\n-                    line, buffer = buffer.split('\\n', 1)\n-                    if line.strip():\n-                        self._process_gui_message(line)\n-            except socket.timeout:\n+                    # Use a very short timeout to avoid blocking the lock for long\n+                    self.gui_socket.settimeout(0.1)\n+                    data = self.gui_socket.recv(4096)\n+                except socket.timeout:\n+                    continue # No data, release lock and loop\n+                finally:\n+                    # Restore default timeout if socket is still valid\n+                    if self.gui_socket:\n+                        self.gui_socket.settimeout(None)\n+\n+            if not data:\n+                logger.warning(\"GUI disconnected\")\n+                break\n+            try:\n+                buffer += data.decode('utf-8', errors='replace')\n+            except UnicodeDecodeError:\n+                logger.warning(\"Invalid UTF-8 data from GUI, skipping\")\n                 continue\n-            except Exception as e:\n-                logger.debug(f\"GUI read error: {e}\")\n-                break\n+            # Prevent buffer overflow from malicious/buggy GUI\n+            if len(buffer) > MAX_BUFFER_SIZE:\n+                logger.warning(\"GUI message buffer overflow, resetting\")\n+                buffer = \"\"\n+                continue\n+            while '\\n' in buffer:\n+                line, buffer = buffer.split('\\n', 1)\n+                if line.strip():\n+                    self._process_gui_message(line)\n+\n     except Exception as e:\n         logger.error(f\"GUI reader thread error: {e}\")\n     finally:\n         # Mark socket as disconnected\n         with self.socket_lock:\n             if self.gui_socket:\n                 try:\n                     self.gui_socket.close()\n                 except OSError:\n                     pass\n                 self.gui_socket = None\n```\n\n\n <!-- /improve --apply_suggestion=1 -->\n\n\n<details><summary>Suggestion importance[1-10]: 9</summary>\n\n__\n\nWhy: This suggestion correctly identifies a critical race condition between the `_read_gui_messages` and `_ask_gui` threads, which could lead to incorrect behavior and timeouts. The proposed fix using `socket_lock` is appropriate and effectively resolves this concurrency bug.\n\n\n</details></details></td><td align=center>High\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Fix incorrect low-risk device classification</summary>\n\n___\n\n**Correct the logic in <code>is_low_risk</code> to prevent composite devices with high-risk <br>interfaces from being incorrectly classified as low-risk.**\n\n[bastion/usb_device.py [120-129]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-bd906050220a1ab34e68971f950245b0fb82ac274aba12bd6632abf5c4c5051fR120-R129)\n\n```diff\n @property\n def is_low_risk(self) -> bool:\n     \"\"\"True if device is in a low-risk category (hub, audio, video) and NOT high-risk\"\"\"\n-    # A device cannot be both high-risk and low-risk - high-risk takes precedence\n+    # A device cannot be both high-risk and low-risk - high-risk takes precedence.\n     if self.is_high_risk:\n         return False\n+    \n+    # Check if the primary device class is low-risk.\n     if self.device_class in LOW_RISK_CLASSES:\n         return True\n-    # Also check interface classes for consistency with is_high_risk\n-    return bool(set(self.interface_classes) & LOW_RISK_CLASSES)\n+    \n+    # For composite devices, check if there are any low-risk interfaces\n+    # AND no high-risk interfaces.\n+    if self.device_class == USBClass.PER_INTERFACE:\n+        interfaces = set(self.interface_classes)\n+        has_low_risk_iface = bool(interfaces & LOW_RISK_CLASSES)\n+        # is_high_risk is already checked, so we just need to confirm a low-risk interface exists.\n+        return has_low_risk_iface\n+        \n+    return False\n```\n\n\n <!-- /improve --apply_suggestion=2 -->\n\n\n<details><summary>Suggestion importance[1-10]: 8</summary>\n\n__\n\nWhy: The suggestion correctly identifies a critical logic flaw in risk classification where a device with both high and low-risk interfaces could be misclassified as low-risk, which has security implications.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Correct exception block indentation</summary>\n\n___\n\n**Correct the indentation of the <code>self.handle_disconnect()</code> call within the <code>except</code> <br>block to fix a syntax error.**\n\n[bastion-gui.py [330-332]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-187b1e5910f096aae7417e760f849b9a564ea1ed82afd7d450e58fa8cced9a57R330-R332)\n\n```diff\n except Exception as e:\n     print(f\"[USB] Failed to send response: {e}\")\n-             self.handle_disconnect()\n+    self.handle_disconnect()\n```\n\n\n <!-- /improve --apply_suggestion=3 -->\n\n\n<details><summary>Suggestion importance[1-10]: 7</summary>\n\n__\n\nWhy: The suggestion correctly identifies and fixes an `IndentationError` that would cause a crash during error handling, which is a significant correctness issue.\n\n</details></details></td><td align=center>Medium\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>Remove duplicated exception handling block</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit removed the duplicated `except Exception as e:` block and its duplicate logger.debug line, matching the suggestion to eliminate unreachable copy-paste error handling.\n\n\ncode diff:\n\n```diff\n                 except Exception as e:\n                     logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n-                except Exception as e:\n-                    logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n```\n\n</details>\n\n\n___\n\n**Remove the duplicated <code>except Exception</code> block, as it is unreachable and <br>represents a copy-paste error.**\n\n[bastion/gui_manager.py [148-174]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR148-R174)\n\n```diff\n # Fallback: try ps -o environ= (output format varies by system)\n if not display_found:\n     try:\n         result = subprocess.run(\n             ['ps', '-u', user, '-o', 'environ='],\n             capture_output=True,\n             text=True,\n             timeout=2\n         )\n         for line in result.stdout.splitlines():\n             if 'DISPLAY=' in line:\n                 # Try both space and NUL separators (format varies by OS)\n                 tokens = line.replace('\\0', ' ').split()\n                 for tok in tokens:\n                     if tok.startswith('DISPLAY='):\n                         display = tok.split('=', 1)[1]\n                         if display:\n                             env['DISPLAY'] = display\n                             logger.info(f\"Found DISPLAY from ps: {display}\")\n                             display_found = True\n                             break\n                 if display_found:\n                     break\n     except Exception as e:\n         logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n-    except Exception as e:\n-        logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n```\n\n\n`[Suggestion processed]`\n\n\n<details><summary>Suggestion importance[1-10]: 3</summary>\n\n__\n\nWhy: The suggestion correctly identifies and removes a duplicated, unreachable `except` block, which is a code quality issue.\n\n</details></details></td><td align=center>Low\n\n</td></tr><tr><td rowspan=1>Security</td>\n<td>\n\n\n\n<details><summary>‚úÖ <s>Fix path traversal vulnerability in USB authorizer</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit tightened validation of bus_id by adding a strict regex check for the expected USB bus ID format (e.g. \"1-2.3\"), reducing path traversal risk. However, the diff shown does not implement the suggested robust mitigation of resolving the constructed path and verifying it remains within the sysfs base directory.\n\n\ncode diff:\n\n```diff\n@@ -426,6 +439,12 @@\n         if not bus_id or not bus_id.strip():\n             logger.error(\"Invalid bus_id: empty string\")\n             raise ValueError(\"Invalid bus_id: empty string\")\n+        \n+        # Validate bus_id format more strictly (expected format: ^\\d+-[\\d.]+$ like \"1-2.3\")\n+        # First check if it matches the expected pattern\n+        if not re.match(r'^\\d+-[\\d.]+$', bus_id):\n+            logger.error(f\"Invalid bus_id format (expected format like '1-2.3'): {bus_id}\")\n+            raise ValueError(f\"Invalid bus_id: {bus_id}\")\n         \n```\n\n</details>\n\n\n___\n\n**Fix a path traversal vulnerability in <code>_get_auth_path</code> by replacing the weak <br>sanitization with a more secure method. The improved code resolves the <br>constructed path and verifies it is located within the expected <br><code>/sys/bus/usb/devices</code> directory.**\n\n[bastion/usb_rules.py [419-441]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-da629a89eec0c480da3d96816c0ba7044d8036e4822f9bb16483d0cdd014fca0R419-R441)\n\n```diff\n def _get_auth_path(cls, bus_id: str) -> Path:\n     \"\"\"Get authorization file path for device.\n \n     Raises:\n         ValueError: If bus_id is invalid or empty after sanitization.\n+        SecurityError: If path traversal is detected.\n     \"\"\"\n     # Reject empty bus_id immediately\n     if not bus_id or not bus_id.strip():\n         logger.error(\"Invalid bus_id: empty string\")\n         raise ValueError(\"Invalid bus_id: empty string\")\n     \n-    # Sanitize bus_id to prevent path traversal\n-    # Only allow alphanumeric and dash (bus_id format: \"1-2.3\" becomes \"1-23\")\n-    safe_bus_id = re.sub(r'[^0-9a-zA-Z.-]', '', bus_id)\n-    # Reject empty IDs after sanitization\n-    if not safe_bus_id:\n-        logger.error(f\"Invalid bus_id format (empty after sanitization): {bus_id}\")\n+    # Sanitize bus_id to prevent path traversal.\n+    # Allow only characters known to be in bus IDs: alphanumeric, '-', '.'\n+    safe_bus_id = re.sub(r'[^a-zA-Z0-9.-]', '', bus_id)\n+    \n+    # An attacker could still use '..' or '.' as the bus_id.\n+    # We must construct the full path and verify it's within the base directory.\n+    if not safe_bus_id or '/' in safe_bus_id or '\\\\' in safe_bus_id:\n+        logger.error(f\"Invalid characters in bus_id after sanitization: {bus_id}\")\n         raise ValueError(f\"Invalid bus_id: {bus_id}\")\n-    # Additional safety: reject if contains \"..\" or starts with \"/\"\n-    if '..' in safe_bus_id or safe_bus_id.startswith('/'):\n-        logger.error(f\"Invalid bus_id format: {bus_id}\")\n-        raise ValueError(f\"Invalid bus_id: {bus_id}\")\n-    return cls.SYSFS_USB_PATH / safe_bus_id / 'authorized'\n \n+    # Construct the full path to the device directory\n+    device_path = (cls.SYSFS_USB_PATH / safe_bus_id).resolve()\n+\n+    # Security check: ensure the resolved path is within the allowed base directory\n+    if not str(device_path).startswith(str(cls.SYSFS_USB_PATH.resolve())):\n+        logger.critical(f\"Path traversal attempt detected for bus_id: {bus_id}\")\n+        raise SecurityError(\"Path traversal attempt detected\")\n+\n+    return device_path / 'authorized'\n+\n```\n\n\n <!-- /improve --apply_suggestion=5 -->\n\n\n<details><summary>Suggestion importance[1-10]: 9</summary>\n\n__\n\nWhy: This suggestion correctly identifies a significant path traversal vulnerability in the `_get_auth_path` method. The existing sanitization is insufficient. The proposed solution of resolving the path and verifying it is within the expected base directory is a robust and standard way to prevent such attacks.\n\n\n</details></details></td><td align=center>High\n\n</td></tr><tr><td rowspan=1>General</td>\n<td>\n\n\n\n<details><summary>Make keyboard shortcuts safer by default</summary>\n\n___\n\n**Improve the keyboard shortcuts in the USB prompt dialog for better security and <br>user experience. The 'A' and 'B' keys will now perform \"Allow Once\" and \"Block <br>Once\" respectively, while <code>Shift+A</code> and <code>Shift+B</code> will perform the \"Always\" actions.**\n\n[bastion/usb_gui.py [441-449]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR441-R449)\n\n```diff\n def keyPressEvent(self, event):\n     \"\"\"Handle keyboard shortcuts.\"\"\"\n     key = event.key()\n+    # 'A' for \"Allow Once\", Shift+'A' for \"Allow Always\"\n     if key == Qt.Key.Key_A:\n-        self.allow_device()\n-    elif key == Qt.Key.Key_B or key == Qt.Key.Key_Escape:\n-        self.block_device()\n+        if event.modifiers() & Qt.KeyboardModifier.ShiftModifier:\n+            self.allow_device(save_rule=True) # Allow Always\n+        else:\n+            self.allow_device(save_rule=False) # Allow Once\n+\n+    # 'B' for \"Block Once\", Shift+'B' for \"Block Always\"\n+    elif key == Qt.Key.Key_B:\n+        if event.modifiers() & Qt.KeyboardModifier.ShiftModifier:\n+            self.block_device(save_rule=True) # Block Always\n+        else:\n+            self.block_device(save_rule=False) # Block Once\n+    \n+    # Escape always blocks once\n+    elif key == Qt.Key.Key_Escape:\n+        self.block_device(save_rule=False)\n+\n     else:\n         super().keyPressEvent(event)\n```\n\n\n <!-- /improve --apply_suggestion=6 -->\n\n\n<details><summary>Suggestion importance[1-10]: 7</summary>\n\n__\n\nWhy: The suggestion improves user experience and security by making the default keyboard shortcut action the less permissive \"once\" option. The improved code also introduces `Shift` modifier keys for the \"always\" actions, providing more control to the user and following a common UI pattern.\n\n\n</details></details></td><td align=center>Medium\n\n</td></tr>\n<tr><td align=\"center\" colspan=\"2\">\n\n <!-- /improve_multi --more_suggestions=true -->\n\n</td><td></td></tr></tbody></table>\n\n</details>\n","createdAt":"2025-12-25T01:35:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690699342","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7b-5x6","author":{"login":"codeant-ai"},"authorAssociation":"NONE","body":"## Nitpicks üîç\n\n<table>\n<tr><td>üîí&nbsp;<strong>No security issues identified</strong></td></tr>\n<tr><td>‚ö°&nbsp;<strong>Recommended areas for review</strong><br><br>\n\n- [ ] <a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-0162f5ae93b9be739c3877c60fa14ab273308ec7fd34877fa3873a70339e4fbaR294-R302'><strong>Aggressive user-file deletion</strong></a><br>The script performs mass rm -rf on user home configuration directories (e.g. /home/*/.config/douane and /home/*/.config/bastion) without verifying that the target directory belongs to a real user account or has an expected UID range. This can remove non-user directories (NFS mounts, system accounts, or special home folders) or misbehave if /home/* contains symlinks. Consider iterating actual user accounts (UID >= 1000) or verifying ownership before deletion.<br>\n\n- [ ] <a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-0162f5ae93b9be739c3877c60fa14ab273308ec7fd34877fa3873a70339e4fbaR204-R214'><strong>Wildcard removals in /usr/bin</strong></a><br>Removing files via broad globs (e.g. /usr/bin/douane* and many /usr/bin/bastion-*) can unintentionally remove similarly named files that aren't part of this package. Consider checking package ownership, installed-file lists, or validating file contents/ownership before rm.<br>\n\n- [ ] <a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-f9f219109b878859f078120342e6af5b34efa439fd52b2b3cec00b97cb0fe859R1208-R1215'><strong>TOCTOU / Tempfile Race</strong></a><br>Writing a temporary file in an unprivileged context and then using pkexec to move it into a privileged location leaves a small window where an attacker could manipulate the temp file (race or symlink). Consider safer atomic replacement strategies or having the privileged helper write the file directly.<br>\n\n- [ ] <a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-0162f5ae93b9be739c3877c60fa14ab273308ec7fd34877fa3873a70339e4fbaR111-R116'><strong>Broad process termination</strong></a><br>The script uses pkill -f with loose patterns (e.g. matching substring \"bastion-root-helper\") which can terminate unrelated processes whose command line contains the substring. This may kill third-party processes or other users' processes. Use more targeted termination (exact binary path, PID files, systemd stop) or verify matched PIDs before killing.<br>\n\n- [ ] <a href='https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-8790b6f79f713974a4a2ab098eb7b4648c5302ba01c76f11ce9bb1a0a639d417R21-R24'><strong>Auth persistence</strong></a><br>The policy uses `auth_admin_keep` (remember elevated auth for a short time) for actions, which reduces the frequency of re-authentication. For sensitive operations (USB rules/policy) this increases risk of unauthorized changes if an authenticated session remains active.<br>\n\n</td></tr>\n</table>\n","createdAt":"2025-12-25T01:36:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690699898","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7b-6J2","author":{"login":"codeant-ai"},"authorAssociation":"NONE","body":"## PR Code Suggestions ‚ú®\n\n<!-- ba6c935 -->\n\n<table><thead><tr><td>Category</td><td align=left>Suggestion&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </td><td align=center>Score</td></tr><tbody><tr><td rowspan=5><strong>Possible bug</strong></td>\n<td>\n\n\n\n<details><summary>Missing directory creation for the XDG runtime path can cause the lock acquisition to fail and incorrectly block GUI startup</summary>\n\n___\n\n\n**When XDG_RUNTIME_DIR is set but the directory does not exist, the lock file <br>directory is never created, causing open() in the lock acquisition to fail and be <br>treated as \"already running\", which prevents the GUI from starting even though no <br>instance is running; ensuring the runtime directory exists in both branches fixes <br>this.**\n\n[bastion-gui.py [22-28]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-187b1e5910f096aae7417e760f849b9a564ea1ed82afd7d450e58fa8cced9a57R22-R28)\n\n```diff\n import os as _os\n _runtime_dir = _os.environ.get('XDG_RUNTIME_DIR')\n if not _runtime_dir:\n     # Fallback to user-specific cache directory\n     _runtime_dir = _os.path.join(_os.path.expanduser('~'), '.cache', 'bastion')\n-    _os.makedirs(_runtime_dir, mode=0o700, exist_ok=True)\n+# Ensure runtime directory exists (whether from XDG_RUNTIME_DIR or fallback)\n+_os.makedirs(_runtime_dir, mode=0o700, exist_ok=True)\n LOCK_FILE = _os.path.join(_runtime_dir, 'bastion-gui.lock')\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The PR's final file state shows that _os.makedirs(...) is only called in the fallback branch. If XDG_RUNTIME_DIR is set but the directory doesn't actually exist (possible on some systems or after cleanup), the code will attempt to use LOCK_FILE inside a non-existent directory and open() will fail, causing acquire_lock to treat the situation as \"already running\". The suggested change is a small, correct fix: ensure the runtime directory exists regardless of whether it came from XDG_RUNTIME_DIR or the fallback. This resolves a real startup bug, not a cosmetic preference.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>Text-mode reading of <code>/proc/*/environ</code> can raise decode errors and prematurely stop DISPLAY detection</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit changed /proc/<pid>/environ reading from text ('r') to binary ('rb'), split on NUL bytes, and decodes each entry with error handling before checking for DISPLAY=, making DISPLAY extraction robust against undecodable bytes.\n\n\ncode diff:\n\n```diff\n@@ -128,17 +140,21 @@\n                 for pid in pids:\n                     if pid and pid.isdigit():\n                         try:\n-                            with open(f'/proc/{pid}/environ', 'r') as f:\n-                                # /proc environ uses NUL separators\n-                                for var in f.read().split('\\0'):\n-                                    if var.startswith('DISPLAY='):\n-                                        display = var.split('=', 1)[1]\n+                            with open(f'/proc/{pid}/environ', 'rb') as f:\n+                                # /proc environ uses NUL separators, read as binary to avoid decode issues\n+                                for var in f.read().split(b'\\0'):\n+                                    try:\n+                                        var_str = var.decode('utf-8', errors='replace')\n+                                    except UnicodeDecodeError:\n+                                        continue  # Skip malformed entries\n+                                    if var_str.startswith('DISPLAY='):\n+                                        display = var_str.split('=', 1)[1]\n                                         if display:\n                                             env['DISPLAY'] = display\n                                             logger.info(f\"Found DISPLAY from /proc/{pid}: {display}\")\n                                             display_found = True\n                                             break\n-                        except (OSError, PermissionError):\n+                        except (OSError, PermissionError, UnicodeDecodeError):\n                             continue\n```\n\n</details>\n\n\n___\n\n\n**Reading <code>/proc/<pid>/environ</code> in text mode and splitting on <code>'\\0'</code> relies on implicit UTF-8 <br>decoding; any non-decodable byte sequence can abort the entire scan and cause <br>DISPLAY detection to fail even when a valid value exists, so reading as bytes and <br>decoding per-variable defensively avoids this failure.**\n\n[bastion/gui_manager.py [128-141]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR128-R141)\n\n```diff\n for pid in pids:\n     if pid and pid.isdigit():\n         try:\n-            with open(f'/proc/{pid}/environ', 'r') as f:\n-                # /proc environ uses NUL separators\n-                for var in f.read().split('\\0'):\n-                    if var.startswith('DISPLAY='):\n-                        display = var.split('=', 1)[1]\n+            # Read as bytes to avoid Unicode decode issues in /proc\n+            with open(f'/proc/{pid}/environ', 'rb') as f:\n+                # /proc environ uses NUL separators and may contain non-text bytes\n+                for var in f.read().split(b'\\0'):\n+                    try:\n+                        decoded = var.decode(errors='ignore')\n+                    except Exception:\n+                        continue\n+                    if decoded.startswith('DISPLAY='):\n+                        display = decoded.split('=', 1)[1]\n                         if display:\n                             env['DISPLAY'] = display\n                             logger.info(f\"Found DISPLAY from /proc/{pid}: {display}\")\n                             display_found = True\n                             break\n         except (OSError, PermissionError):\n             continue\n     if display_found:\n         break\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: Reading `/proc/*/environ` in text mode can throw decoding errors on unusual byte sequences; switching to binary reads and decoding per-variable (or ignoring undecodable bytes) makes DISPLAY extraction more robust and avoids a hard failure that prevents GUI startup.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>Missing <code>subprocess</code> import causes a NameError when USB policy changes or rule deletions are attempted</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit adds the missing `import subprocess` at the top of the module, preventing runtime NameError in code paths that call subprocess.run.\n\n\ncode diff:\n\n```diff\n import logging\n+import subprocess\n from typing import Optional\n```\n\n</details>\n\n\n___\n\n\n**The module calls <code>subprocess.run</code> in both the USB default policy setter and the <br>privileged rule deletion helper but never imports <code>subprocess</code>, which will raise a <br><code>NameError</code> the first time these code paths are executed (for example when toggling <br>USB protection or deleting a rule), preventing the operations from running at all.**\n\n[bastion/usb_gui.py [10-24]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR10-R24)\n\n```diff\n import logging\n+import subprocess\n from typing import Optional\n \n from PyQt6.QtWidgets import (\n     QDialog, QVBoxLayout, QHBoxLayout, QGridLayout, QLabel, QPushButton,\n     QFrame, QRadioButton, QButtonGroup, QWidget, QScrollArea,\n     QTableWidget, QTableWidgetItem, QHeaderView, QAbstractItemView, QMessageBox\n )\n from PyQt6.QtCore import Qt, QTimer\n from PyQt6.QtGui import QFont\n \n from bastion.usb_device import USBDeviceInfo\n from bastion.usb_rules import USBRuleManager, USBRule, Verdict, Scope\n from bastion.gui_theme import COLORS, STRINGS\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The final file uses subprocess.run in _set_usb_default_policy and _delete_rule_with_privilege but there's no import subprocess at the top of the module. That will raise NameError the first time either path executes (e.g. toggling protection or deleting a rule). Adding \"import subprocess\" at the top is the correct, minimal fix. This is a real runtime bug, not cosmetic.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Duplicated key validation logic can drift from the canonical USB validation rules, causing inconsistent acceptance of the same key across components</summary>\n\n___\n\n\n**The local key validation logic duplicates and can diverge from the central <br><code>USBValidation</code> rules, risking situations where a key is accepted elsewhere in the <br>system but rejected (or vice versa) by this root helper, so delegating to the shared <br>validator avoids inconsistent behavior.**\n\n[bastion/root_helper.py [70-87]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-e14c111d9aa4b60221987bbf8f95e542a831e8ca7e826863a5de2f023a43f89dR70-R87)\n\n```diff\n # Valid key pattern: vendor_id:product_id:serial or vendor_id:* or vendor_id:product_id:*\n # vendor_id/product_id: 4 hex chars\n # serial: alphanumeric, dots, dashes, underscores, or * for wildcard\n-KEY_PATTERN = re.compile(\n-    r'^[0-9a-f]{4}:[0-9a-f]{4}:[A-Za-z0-9._\\-]+$|'  # device key\n-    r'^[0-9a-f]{4}:[0-9a-f]{4}:\\*$|'                  # model key\n-    r'^[0-9a-f]{4}:\\*:\\*$'                            # vendor key\n-)\n-\n-\n def validate_key(key: str) -> bool:\n     \"\"\"\n     Validate USB rule key format.\n+\n+    Uses the central USBValidation helper to keep rules consistent\n+    with the rest of the system, falling back to a local strict\n+    regex check if the bastion modules are not importable.\n \n     Returns True if key matches expected format, False otherwise.\n     \"\"\"\n     if not isinstance(key, str):\n         return False\n     if not key or len(key) > 256:\n         return False\n-    return KEY_PATTERN.match(key) is not None\n \n+    try:\n+        from bastion.usb_validation import USBValidation\n+    except ImportError:\n+        # Fallback: local strict pattern (kept in sync with USBValidation.KEY_PATTERN)\n+        return re.match(\n+            r'^[0-9a-fA-F]{4}:[0-9a-fA-F]{4}:[A-Za-z0-9._\\-]+$|'\n+            r'^[0-9a-fA-F]{4}:[0-9a-fA-F]{4}:\\*$|'\n+            r'^[0-9a-fA-F]{4}:\\*:\\*$',\n+            key,\n+        ) is not None\n+    else:\n+        return USBValidation.validate_key(key)\n+\n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The repository already contains a centralized bastion.usb_validation.USBValidation with validate_key/sanitize_key logic. Delegating to the canonical validator avoids drift between modules and ensures consistent handling (including sanitization rules, max lengths and logging). The suggestion correctly identifies a potential maintenance bug and points to an existing module (usb_validation.py) discovered in the codebase.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>Unvalidated <code>last_seen</code> timestamps from JSON can be invalid and break consumers expecting a proper ISO timestamp</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit adds logic to extract `last_seen` from the JSON, validate/sanitize it with `USBValidation.sanitize_timestamp` when present, and pass the sanitized value into the `USBRule` constructor instead of the raw JSON value.\n\n\ncode diff:\n\n```diff\n+        # Validate and sanitize last_seen timestamp if present\n+        raw_last_seen = data.get('last_seen')\n+        last_seen = None\n+        if raw_last_seen:\n+            last_seen = USBValidation.sanitize_timestamp(raw_last_seen)\n+            \n         return cls(\n             verdict=USBValidation.validate_verdict(data.get('verdict', 'block')),\n             vendor_id=USBValidation.sanitize_hex_id(data.get('vendor_id', '')),\n@@ -90,7 +96,7 @@\n             product_name=USBValidation.sanitize_string(data.get('product_name', 'Unknown')),\n             scope=USBValidation.validate_scope(data.get('scope', 'device')),\n             added=USBValidation.sanitize_timestamp(data.get('added', '')),\n-            last_seen=data.get('last_seen'),\n+            last_seen=last_seen,\n             serial=serial,\n         )\n```\n\n</details>\n\n\n___\n\n\n**The <code>last_seen</code> field in rules loaded from JSON is taken directly from the file <br>without validation, so a corrupted or malicious value (e.g. non-ISO string) could <br>later cause consumers that assume a valid timestamp to raise errors; it should be <br>sanitized similarly to <code>added</code>.**\n\n[bastion/usb_rules.py [85-95]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-da629a89eec0c480da3d96816c0ba7044d8036e4822f9bb16483d0cdd014fca0R85-R95)\n\n```diff\n return cls(\n     verdict=USBValidation.validate_verdict(data.get('verdict', 'block')),\n     vendor_id=USBValidation.sanitize_hex_id(data.get('vendor_id', '')),\n     product_id=USBValidation.sanitize_hex_id(data.get('product_id', '')),\n     vendor_name=USBValidation.sanitize_string(data.get('vendor_name', 'Unknown')),\n     product_name=USBValidation.sanitize_string(data.get('product_name', 'Unknown')),\n     scope=USBValidation.validate_scope(data.get('scope', 'device')),\n     added=USBValidation.sanitize_timestamp(data.get('added', '')),\n-    last_seen=data.get('last_seen'),\n+    last_seen=USBValidation.sanitize_timestamp(data.get('last_seen', '')) if data.get('last_seen') else None,\n     serial=serial,\n )\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The PR currently assigns last_seen directly from the JSON without validation. Consumers elsewhere may assume an ISO timestamp and could break when encountering malformed or malicious values. Sanitizing/validating last_seen (e.g. via USBValidation.sanitize_timestamp) is a small, safe hardening step that prevents a real data-integrity/runtime issue ‚Äî it's not just cosmetic.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td rowspan=6><strong>Logic error</strong></td>\n<td>\n\n\n\n<details><summary>‚úÖ <s>Broad process matching can incorrectly report the GUI as running and prevent it from being started</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The process check was hardened by switching from `pgrep -f bastion-gui` (full command-line match) to `pgrep -x bastion-gui` (exact process name match), reducing false positives that could incorrectly prevent the GUI from starting.\n\n\ncode diff:\n\n```diff\n             # Also check if any bastion-gui process is running\n+            # Use exact binary path to avoid matching unrelated processes\n             result = subprocess.run(\n-                ['pgrep', '-f', 'bastion-gui'],\n+                ['pgrep', '-x', 'bastion-gui'],\n                 capture_output=True,\n                 timeout=2\n```\n\n</details>\n\n\n___\n\n\n**Using <code>pgrep -f 'bastion-gui'</code> matches any process whose full command line contains <br>that string, so unrelated processes can cause the check to report the GUI as running <br>and prevent it from being started when needed; restricting the match to the actual <br>process name avoids these false positives.**\n\n[bastion/gui_manager.py [60-66]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR60-R66)\n\n```diff\n # Also check if any bastion-gui process is running\n+# Use exact process name to avoid false positives on other commands\n result = subprocess.run(\n-    ['pgrep', '-f', 'bastion-gui'],\n+    ['pgrep', '-x', 'bastion-gui'],\n     capture_output=True,\n     timeout=2\n )\n return result.returncode == 0\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The PR uses `pgrep -f 'bastion-gui'`, which matches the full command line and can return false positives (other commands containing that string). Restricting to the exact process name with `-x` is a safe, minimal hardening that reduces incorrect \"already running\" reports and won't change behavior when the process is actually named `bastion-gui`.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>A duplicated generic exception handler makes part of the code unreachable and unnecessarily confusing</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit removed the redundant second `except Exception` handler, eliminating unreachable code and matching the suggested cleanup.\n\n\ncode diff:\n\n```diff\n@@ -170,8 +170,6 @@\n                                 break\n                 except Exception as e:\n                     logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n-                except Exception as e:\n-                    logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n```\n\n</details>\n\n\n___\n\n\n**The duplicated <code>except Exception</code> block around the <code>ps</code> fallback is unreachable and <br>redundant, which is a control-flow bug that adds confusion and may hide intended <br>specialized handling for different errors.**\n\n[bastion/gui_manager.py [149-174]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR149-R174)\n\n```diff\n if not display_found:\n     try:\n         result = subprocess.run(\n             ['ps', '-u', user, '-o', 'environ='],\n             capture_output=True,\n             text=True,\n             timeout=2\n         )\n         for line in result.stdout.splitlines():\n             if 'DISPLAY=' in line:\n                 # Try both space and NUL separators (format varies by OS)\n                 tokens = line.replace('\\0', ' ').split()\n                 for tok in tokens:\n                     if tok.startswith('DISPLAY='):\n                         display = tok.split('=', 1)[1]\n                         if display:\n                             env['DISPLAY'] = display\n                             logger.info(f\"Found DISPLAY from ps: {display}\")\n                             display_found = True\n                             break\n                 if display_found:\n                     break\n     except Exception as e:\n         logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n-    except Exception as e:\n-        logger.debug(f\"Could not find DISPLAY from ps: {e}\")\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The final file contains two identical `except Exception` blocks for the same try; the second is unreachable and redundant. Removing the duplicate clarifies control flow without changing behavior.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Low-risk USB devices are never actually authorized when no GUI is connected, even though the code logs them as allowed</summary>\n\n___\n\n\n**When the GUI is not connected and a low-risk USB device is inserted, the code logs <br>that it is allowing the device and updates statistics but never actually calls the <br>USB authorizer to enable it, so the device will remain blocked despite being <br>reported as allowed.**\n\n[bastion/daemon.py [842-854]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR842-R854)\n\n```diff\n def _prompt_usb_decision(self, device: USBDeviceInfo):\n     \"\"\"Prompt user for USB device decision via GUI.\"\"\"\n     if not self.gui_socket:\n         logger.warning(\"No GUI connected - cannot prompt for USB device decision\")\n         # Default: block high-risk, allow low-risk\n         if device.is_high_risk:\n             logger.warning(f\"Blocking high-risk USB device without GUI: {device.product_name}\")\n             USBAuthorizer.deauthorize(device.bus_id)\n             self.stats['usb_devices_blocked'] += 1\n         else:\n             logger.info(f\"Allowing low-risk USB device without GUI: {device.product_name}\")\n+            USBAuthorizer.authorize(device.bus_id)\n             self.stats['usb_devices_allowed'] += 1\n         return\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The suggestion correctly points out a logic gap in the current PR: in the \"no GUI\" fallback path the code logs and counts a low-risk device as allowed but never calls USBAuthorizer.authorize(), so on systems where the default policy was set to block new devices the device will actually remain blocked. This is a real functional bug, not cosmetic.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Low-risk USB devices are not authorized after a GUI timeout despite being treated as allowed, leaving them blocked under the default block policy</summary>\n\n___\n\n\n**On USB decision timeout for low-risk devices, the code increments the \"allowed\" <br>counter and logs that the device is allowed but never calls the USB authorizer, so <br>with the default policy set to block new devices, the device remains disabled <br>instead of being enabled.**\n\n[bastion/daemon.py [907-920]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR907-R920)\n\n```diff\n else:\n     # Timeout - default based on risk\n     logger.warning(f\"USB decision timeout for: {device.product_name}\")\n     with self.usb_pending_lock:\n         self.usb_pending_device = None\n         self.usb_pending_nonce = None\n \n     if device.is_high_risk:\n         logger.warning(f\"Blocking high-risk USB device on timeout: {device.product_name}\")\n         USBAuthorizer.deauthorize(device.bus_id)\n         self.stats['usb_devices_blocked'] += 1\n     else:\n         logger.info(f\"Allowing low-risk USB device on timeout: {device.product_name}\")\n+        USBAuthorizer.authorize(device.bus_id)\n         self.stats['usb_devices_allowed'] += 1\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: This is another true logic omission: on GUI timeout the low-risk branch increments the allowed counter and logs allowance but never invokes USBAuthorizer.authorize(), so with the daemon setting default policy to block new devices the device remains blocked. The improved code (calling authorize) resolves the real-world mismatch between state and action.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>The USB protection toggle updates UI state even when the privileged policy change fails or is cancelled, leaving the interface out of sync with the actual system policy</summary>\n\n___\n\n\n**The USB protection toggle updates the internal <code>usb_enabled</code> flag and all UI labels <br>before attempting to change the kernel's default USB policy via the root helper, so <br>if the helper fails or the user cancels the pkexec prompt, the GUI will misleadingly <br>show the new state while the actual system policy remains unchanged; refactor the <br>toggle to call <code>_set_usb_default_policy</code> first and only update <code>usb_enabled</code> and the UI <br>when that call reports success.**\n\n[bastion/usb_gui.py [706-844]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-064a2f5444493185150a145494d3018dc5ed398be3a634a0fdcd42d7cd60d8bdR706-R844)\n\n```diff\n def _toggle_usb_protection(self):\n-    \"\"\"Toggle USB protection on/off.\"\"\"\n+    \"\"\"Toggle USB protection on/off.\n \n-    self.usb_enabled = not self.usb_enabled\n+    Only update the UI state if the underlying USB default policy\n+    was successfully changed via the root helper.\n+    \"\"\"\n+    # Determine desired state and corresponding kernel policy\n+    desired_enabled = not self.usb_enabled\n+    # When protection is enabled, new devices should be blocked by default\n+    authorize = not desired_enabled  # True = allow new devices, False = block new devices\n+\n+    if not self._set_usb_default_policy(authorize=authorize):\n+        # Root helper failed or was cancelled; keep previous UI state\n+        logger.warning(\"USB protection toggle aborted due to policy change failure\")\n+        return\n+\n+    # Policy change succeeded, update internal state and labels\n+    self.usb_enabled = desired_enabled\n \n     if self.usb_enabled:\n         # Enable: set authorized_default=0 (block new devices)\n         self.btn_toggle.setText(STRINGS[\"usb_protection_disable\"])\n         self.btn_toggle.setStyleSheet(f\"\"\"\n             QPushButton {{\n                 background-color: {COLORS['danger']};\n                 color: white;\n                 border: none;\n                 padding: 8px 16px;\n                 border-radius: 4px;\n                 font-weight: bold;\n             }}\n             QPushButton:hover {{\n                 background-color: #c0392b;\n             }}\n         \"\"\")\n         self.lbl_status.setText(STRINGS[\"usb_protection_active\"])\n         self.lbl_status.setStyleSheet(f\"font-size: 16px; font-weight: bold; color: {COLORS['success']};\")\n-        # Set default to block (authorized_default=0)\n-        self._set_usb_default_policy(authorize=False)\n     else:\n         # Disable: set authorized_default=1 (allow new devices)\n         self.btn_toggle.setText(STRINGS[\"usb_protection_enable\"])\n         self.btn_toggle.setStyleSheet(f\"\"\"\n             QPushButton {{\n                 background-color: {COLORS['success']};\n                 color: white;\n                 border: none;\n                 padding: 8px 16px;\n                 border-radius: 4px;\n                 font-weight: bold;\n             }}\n             QPushButton:hover {{\n                 background-color: #27ae60;\n             }}\n         \"\"\")\n         self.lbl_status.setText(STRINGS[\"usb_protection_disabled\"])\n         self.lbl_status.setStyleSheet(f\"font-size: 16px; font-weight: bold; color: {COLORS['danger']};\")\n-        # Set default to allow (authorized_default=1)\n-        self._set_usb_default_policy(authorize=True)\n \n-def _set_usb_default_policy(self, authorize: bool):\n+def _set_usb_default_policy(self, authorize: bool) -> bool:\n     \"\"\"\n     Set USB default authorization policy via bastion-root-helper.\n \n     Uses the dedicated root helper CLI to safely change USB policy\n     without any code injection risks.\n \n     Args:\n         authorize: True = allow new devices, False = block new devices\n+\n+    Returns:\n+        True if the policy was changed successfully, False otherwise.\n     \"\"\"\n     policy_arg = '--authorize' if authorize else '--block'\n     policy_name = 'allow' if authorize else 'block'\n \n     try:\n         # Use the root helper - no dynamic code, just fixed arguments\n         # Use absolute path to prevent PATH hijacking via pkexec\n         result = subprocess.run(\n             ['pkexec', '/usr/bin/bastion-root-helper', 'usb-default-policy', 'set', policy_arg],\n             check=False,\n             capture_output=True,\n             text=True,\n             timeout=30\n         )\n \n         if result.returncode == 0:\n             logger.info(f\"USB default policy set to {policy_name}\")\n+            return True\n         elif result.returncode == 126:\n             # User cancelled pkexec authentication dialog\n             logger.info(\"USB policy change cancelled by user\")\n+            return False\n         else:\n             # Log details internally, show generic message to user\n             logger.warning(f\"Failed to set USB policy: {result.stderr}\")\n             from bastion.notification import show_notification\n             show_notification(self, \"Error\", \"Failed to change USB policy. Check logs for details.\")\n+            return False\n \n     except subprocess.TimeoutExpired:\n         logger.error(\"USB policy change timed out\")\n         from bastion.notification import show_notification\n         show_notification(self, \"Timeout\", \"USB policy change timed out\")\n+        return False\n     except FileNotFoundError:\n         logger.error(\"bastion-root-helper not found\")\n         from bastion.notification import show_notification\n         show_notification(self, \"Error\", \"Root helper not installed. Please reinstall Bastion.\")\n+        return False\n     except Exception as e:\n         logger.error(f\"Failed to set USB policy: {e}\")\n+        return False\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The current toggle flips internal state and updates the UI before calling the privileged helper. If the helper fails or the user cancels the pkexec prompt, the GUI will indicate a state that doesn't match system policy. The suggested refactor to call the helper first and only update UI/state on success fixes a real logic/UX bug. Also, the helper currently returns nothing ‚Äî the refactor needs _set_usb_default_policy to return success/failure (bool) so the toggle can decide.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>Partial failures when setting the USB default policy are incorrectly reported as full success</summary>\n\n___\n\n\n**The USB default policy setter treats a partial failure (some controllers updated, <br>others failing) as a full success because <code>error_count</code> is never checked, so the CLI <br>can report success even when some USB host controllers remain misconfigured.**\n\n[bastion/root_helper.py [127-134]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-e14c111d9aa4b60221987bbf8f95e542a831e8ca7e826863a5de2f023a43f89dR127-R134)\n\n```diff\n-if success_count > 0:\n+if success_count > 0 and error_count == 0:\n     logger.info(f\"USB default policy set to {policy_name} ({success_count} controllers)\")\n     print(f\"SUCCESS: Set {success_count} controller(s) to {policy_name}\")\n     return 0\n+elif success_count > 0 and error_count > 0:\n+    logger.warning(\n+        f\"USB default policy partially applied: {success_count} controller(s) succeeded, \"\n+        f\"{error_count} controller(s) failed\"\n+    )\n+    print(\n+        f\"WARNING: Policy {policy_name} applied to {success_count} controller(s), \"\n+        f\"but {error_count} controller(s) failed\",\n+        file=sys.stderr,\n+    )\n+    return 1\n else:\n-    logger.error(f\"Failed to set USB policy on any controller\")\n+    logger.error(\"Failed to set USB policy on any controller\")\n     print(\"ERROR: Failed to set policy on any controller\", file=sys.stderr)\n     return 1\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The current logic treats any non-zero success_count as an overall success even if some controllers failed (error_count > 0). The proposed change distinguishes full success from partial success/failure, logs appropriately, emits a warning to stderr for partial application, and returns a non-zero exit code for partial failure. This fixes a real logic/visibility issue (misleading success reporting) rather than being purely cosmetic.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td rowspan=2><strong>Security</strong></td>\n<td>\n\n\n\n<details><summary>‚úÖ <s>Naively picking the first <code>who</code> user can start the GUI as root instead of an unprivileged desktop user</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit changed the fallback user-selection logic to avoid privileged/system accounts by validating candidate users via the passwd database and requiring UID >= 1000, which prevents choosing root and aligns with the intent of running the GUI under an unprivileged desktop user.\n\n\ncode diff:\n\n```diff\n@@ -93,8 +94,19 @@\n                         timeout=2\n                     )\n                     if result.stdout:\n-                        # Get first logged-in user\n-                        user = result.stdout.split()[0]\n+                        # Filter for real users (UID >= 1000) to avoid system accounts\n+                        users = result.stdout.strip().split('\\n')\n+                        for line in users:\n+                            if line.strip():\n+                                user = line.strip()\n+                                # Verify this is a real user account\n+                                try:\n+                                    import pwd\n+                                    pw = pwd.getpwnam(user)\n+                                    if pw and pw.pw_uid >= 1000:\n+                                        break  # Found valid user\n+                                except (KeyError, ImportError):\n+                                    pass\n                 except:\n                     pass\n```\n\n</details>\n\n\n___\n\n\n**The fallback that uses <code>who</code> to determine the logged-in user simply takes the first <br>username from the output, which can be <code>root</code>, causing the GUI to run as root despite <br>the intent \"not root\"; filtering out root sessions ensures the GUI runs under an <br>unprivileged user when possible.**\n\n[bastion/gui_manager.py [86-97]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-777aafb90ac7db10627e43a4f53923b0cffb53e24f8a18ad01da0f2b6be6601fR86-R97)\n\n```diff\n if not user:\n     # Try to find user from active X sessions\n     try:\n         result = subprocess.run(\n             ['who'],\n             capture_output=True,\n             text=True,\n             timeout=2\n         )\n         if result.stdout:\n-            # Get first logged-in user\n-            user = result.stdout.split()[0]\n-    except:\n+            # Prefer first non-root logged-in user\n+            for line in result.stdout.splitlines():\n+                parts = line.split()\n+                if parts:\n+                    candidate = parts[0]\n+                    if candidate != 'root':\n+                        user = candidate\n+                        break\n+            # Fallback: if only root sessions are found, use the first username\n+            if not user:\n+                user = result.stdout.split()[0]\n+    except Exception:\n         pass\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The current logic can pick `root` if root appears first in `who` output, violating the \"not root\" intent. Preferring the first non-root session is a sensible and low-risk improvement that better matches the function's stated goal.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td>\n\n\n\n<details><summary>‚úÖ <s>Unconditionally chmodding the parent directory can inadvertently relax permissions on an existing secure directory</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>The commit modified the code to avoid unconditionally calling os.chmod on the parent directory by adding a conditional guard around chmod. However, it checks `if not parent.exists()` after the directory has already been created, so the chmod will likely never run; this indicates the suggestion influenced the change, but it was not implemented correctly as suggested (tracking creation status before mkdir).\n\n\ncode diff:\n\n```diff\n@@ -152,7 +158,9 @@\n             logger.error(f\"Directory {parent} became a symlink, refusing to use\")\n             raise SecurityError(f\"Directory {parent} is a symlink\")\n \n-        os.chmod(parent, self.DIR_MODE)\n+        # Only chmod if we created the directory (don't change existing permissions)\n+        if not parent.exists():\n+            os.chmod(parent, self.DIR_MODE)\n     \n```\n\n</details>\n\n\n___\n\n\n**The directory creation helper unconditionally <code>chmod</code>s the parent directory to <br><code>DIR_MODE</code>, which can silently weaken permissions on an existing directory that was <br>intentionally more restrictive; to avoid this, only adjust permissions when the <br>directory is newly created.**\n\n[bastion/usb_rules.py [141-156]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-da629a89eec0c480da3d96816c0ba7044d8036e4822f9bb16483d0cdd014fca0R141-R156)\n\n```diff\n parent = self.db_path.parent\n \n # SECURITY: Check if parent directory is a symlink\n if parent.is_symlink():\n     logger.error(f\"Directory {parent} is a symlink, refusing to use\")\n     raise SecurityError(f\"Directory {parent} is a symlink\")\n \n+# Track whether we had to create the directory\n+created = not parent.exists()\n parent.mkdir(parents=True, exist_ok=True)\n \n # Verify it's still not a symlink after creation (race condition mitigation)\n if parent.is_symlink():\n     logger.error(f\"Directory {parent} became a symlink, refusing to use\")\n     raise SecurityError(f\"Directory {parent} is a symlink\")\n \n-os.chmod(parent, self.DIR_MODE)\n+# Only relax permissions when we created the directory ourselves\n+if created:\n+    os.chmod(parent, self.DIR_MODE)\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The current implementation always calls os.chmod on the parent directory which can unintentionally relax a deliberately stricter permission set on an existing directory. Tracking whether we created the directory and only setting permissions when it was just created avoids weakening existing permissions and is a sensible security improvement, not a bike-shed change.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td rowspan=1><strong>Race condition</strong></td>\n<td>\n\n\n\n<details><summary>Adding USB rules without using the same lock as the reload logic can race with reloads and leave the in-memory rule set temporarily out of sync with what was just written to disk</summary>\n\n___\n\n\n**USB rules are reloaded periodically under a lock, but rule additions in the USB <br>decision path update the rule manager without using the same lock; this can cause a <br>race where a newly reloaded manager holds stale in-memory rules until the next <br>reload, so user decisions may not take effect immediately.**\n\n[bastion/daemon.py [892-906]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-2ca8d9a4a9ca39a1a0426350a6082a2711e584a79da1f3e53fa431a4665e1baaR892-R906)\n\n```diff\n if verdict == 'allow':\n     action = \"allowed\" if save_rule else \"allowed once\"\n     logger.info(f\"User {action} USB device: {device.product_name}\")\n     if save_rule:\n-        self.usb_rule_manager.add_rule(device, 'allow', scope)\n+        with self.usb_rules_lock:\n+            self.usb_rule_manager.add_rule(device, 'allow', scope)\n     USBAuthorizer.authorize(device.bus_id)\n     self.stats['usb_devices_allowed'] += 1\n else:\n     action = \"blocked\" if save_rule else \"blocked once\"\n     logger.info(f\"User {action} USB device: {device.product_name}\")\n     if save_rule:\n-        self.usb_rule_manager.add_rule(device, 'block', scope)\n+        with self.usb_rules_lock:\n+            self.usb_rule_manager.add_rule(device, 'block', scope)\n     USBAuthorizer.deauthorize(device.bus_id)\n     self.stats['usb_devices_blocked'] += 1\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The PR already protects rule reloading with self.usb_rules_lock (see _reload_usb_rules_if_changed). add_rule() is called here without that same lock, which can race with a concurrent reload: either the new rule gets overwritten by the reload or the in-memory state is inconsistent until next reload. Wrapping add_rule() in the same lock is the correct, minimal synchronization fix.\n\n</details></details></td><td align=center>10\n\n</td></tr><tr><td rowspan=1><strong>Type error</strong></td>\n<td>\n\n\n\n<details><summary>‚úÖ <s>Missing Callable import in typing causes a NameError during class definition</s></summary>\n\n___\n\n<details><summary><b>Suggestion Impact:</b></summary>Updated the typing import to include Callable (alongside Optional), matching the suggested fix to prevent runtime NameError from unresolved Callable annotations.\n\n\ncode diff:\n\n```diff\n-from typing import Optional\n+from typing import Callable, Optional\n```\n\n</details>\n\n\n___\n\n\n**The type annotation for the callback parameter uses <code>Callable</code> but <code>Callable</code> is never <br>imported from <code>typing</code>, which will raise a <code>NameError</code> when the module is imported <br>because annotations are evaluated at class definition time in this file (no <code>from </code><br><code>__future__ import annotations</code>), breaking all imports of this module.**\n\n[bastion/usb_monitor.py [9]](https://github.com/shipdocs/bastion-firewall/pull/6/files#diff-6d9892f3b2e6bad306242fdda365e835092002b80950f330bdb500cb4f7959ebR9-R9)\n\n```diff\n-from typing import Optional\n+from typing import Optional, Callable\n \n```\n<details><summary>Suggestion importance[1-10]: 10</summary>\n\nWhy it matters? ü§î: The PR's final file uses Callable in the USBMonitor __init__ annotation:\ndef __init__(self, callback: Callable[[USBDeviceInfo, str], None]):\nbut the module only imports Optional from typing. Because there is no\n\"from __future__ import annotations\" at top of the module, annotations are\nevaluated at runtime when the function/class is defined, so Callable must\nbe defined in the namespace. This will raise a NameError on import. Adding\n\"Callable\" to the typing import fixes a real runtime import error (not a\ncosmetic change).\n\n</details></details></td><td align=center>10\n\n</td></tr></tr></tbody></table>\n\n","createdAt":"2025-12-25T01:37:58Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"THUMBS_DOWN","users":{"totalCount":1}}],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690701430","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7b-6Kq","author":{"login":"codeant-ai"},"authorAssociation":"NONE","body":"CodeAnt AI finished reviewing your PR.","createdAt":"2025-12-25T01:38:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690701482","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7cAaOV","author":{"login":"codeant-ai"},"authorAssociation":"NONE","body":"CodeAnt AI is running Incremental review\n\n---\n\n### Thanks for using CodeAnt! üéâ\n\nWe're free for open-source projects. if you're enjoying it, help us grow by sharing.\n\n[Share on X](https://twitter.com/intent/tweet?text=Just%20tried%20%40CodeAntAI%20for%20automated%20code%20review%20and%20I%27m%20impressed%21%20Free%20for%20open%20source%20with%20a%20free%20trial%20for%20private%20repos.%20Worth%20checking%20out%3A&url=https%3A//codeant.ai) ¬∑\n[Reddit](https://www.reddit.com/submit?title=Check%20out%20CodeAnt%20for%20automated%20code%20review&text=Just%20tried%20CodeAnt%20for%20automated%20code%20review%20and%20I%27m%20impressed%21%20Free%20for%20open%20source%20with%20a%20free%20trial%20for%20private%20repos.%20Worth%20checking%20out%3A%20https%3A//codeant.ai) ¬∑\n[LinkedIn](https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcodeant.ai&mini=true&title=Check%20out%20CodeAnt%20for%20automated%20code%20review&summary=Just%20tried%20CodeAnt%20for%20automated%20code%20review%20and%20I%27m%20impressed%21%20Free%20for%20open%20source%20with%20a%20free%20trial%20for%20private%20repos)\n","createdAt":"2025-12-25T07:51:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3691094933","viewerDidAuthor":false},{"id":"IC_kwDOQsqSJc7cAm3F","author":{"login":"qodo-code-review"},"authorAssociation":"CONTRIBUTOR","body":"**[Persistent suggestions](https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3690699342)** updated to latest commit 94d9a1f","createdAt":"2025-12-25T08:31:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/shipdocs/bastion-firewall/pull/6#issuecomment-3691146693","viewerDidAuthor":false}],"reviews":[{"id":"PRR_kwDOQsqSJc7XRoQn","author":{"login":"coderabbitai"},"authorAssociation":"CONTRIBUTOR","body":"**Actionable comments posted: 5**\n\n> [!CAUTION]\n> Some comments are outside the diff and can‚Äôt be posted inline due to platform limitations.\n> \n> \n> \n> <details>\n> <summary>‚ö†Ô∏è Outside diff range comments (1)</summary><blockquote>\n> \n> <details>\n> <summary>launch_bastion.sh (1)</summary><blockquote>\n> \n> `7-10`: **Environment logging may expose sensitive data.**\n> \n> Logging the full environment (`$(env)`) to `/tmp/bastion-launch.log` could expose sensitive environment variables (API keys, tokens, credentials) to any local user, since `/tmp` files are typically world-readable.\n> \n> Consider either removing the environment logging or restricting the log file permissions.\n> \n> <details>\n> <summary>üîé Proposed fix - remove sensitive logging</summary>\n> \n> ```diff\n>  # Debug logging\n>  exec 1> >(tee -a \"/tmp/bastion-launch.log\") 2>&1\n>  echo \"--- Launching Bastion at $(date) ---\"\n>  echo \"User: $(whoami)\"\n> -echo \"Environment: $(env)\"\n> +echo \"DISPLAY: ${DISPLAY:-unset}\"\n> +echo \"XDG_RUNTIME_DIR: ${XDG_RUNTIME_DIR:-unset}\"\n> ```\n> </details>\n> \n> </blockquote></details>\n> \n> </blockquote></details>\n\n<details>\n<summary>üßπ Nitpick comments (25)</summary><blockquote>\n\n<details>\n<summary>.gitignore (1)</summary><blockquote>\n\n`69-80`: **Consider making generated artifact patterns more specific.**\n\nThe additions for AI tooling directories are reasonable and appropriate for development workflows. However, the generated artifact patterns (lines 75‚Äì80) are quite broad and could inadvertently ignore legitimate documentation files that developers intentionally commit. For example:\n\n- `*_ANALYSIS.md` might conflict with intentional analysis documents like `API_ANALYSIS.md` or `ARCHITECTURE_ANALYSIS.md`\n- `*_REVIEW.md` could match code review notes or design review documents that should be tracked\n- Similarly, patterns like `CODE_QUALITY_*.md` and `SECURITY_*.md` might be too general\n\n**Suggestion:** Either make the patterns more specific (e.g., `.temp/*_ANALYSIS.md`, `build/*_REPORT.md`) or place these patterns in a separate `.gitignore-tools` file that developers explicitly enable, rather than applying them globally to the repository.\n\nAlternatively, if these files are indeed ephemeral and should never be committed, document this expectation for contributors (e.g., in CONTRIBUTING.md or a tool-setup guide).\n\n</blockquote></details>\n<details>\n<summary>SECURITY.md (1)</summary><blockquote>\n\n`13-13`: **Consider adding a language identifier to the code block.**\n\nThe fenced code block could use a placeholder language identifier like `text` or `plaintext` to satisfy markdown linters, though this is purely cosmetic for ASCII art.\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-```\n+```text\n ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/icon_manager.py (1)</summary><blockquote>\n\n`29-35`: **Consider annotating mutable class attribute with `ClassVar`.**\n\nPer Python best practices, mutable class-level attributes should be annotated with `typing.ClassVar` to indicate they are class variables rather than instance variables.\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n+from typing import ClassVar\n+\n class IconManager:\n     \"\"\"Manages application icons\"\"\"\n     \n     # Icon paths\n     ICON_DIR = Path(__file__).parent / 'resources'\n     BASTION_ICON_PNG = ICON_DIR / 'bastion-icon.png'\n     BASTION_ICON_SVG = ICON_DIR / 'bastion-icon.svg'\n\n     # Navigation icons (PNG for best compatibility)\n-    NAV_ICONS = {\n+    NAV_ICONS: ClassVar[dict[str, str]] = {\n         'Status': 'nav-status.png',\n         'Rules': 'nav-rules.png',\n         'USB': 'nav-usb.png',\n         'Logs': 'nav-logs.png',\n         'Settings': 'nav-settings.png'\n     }\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_manager.py (1)</summary><blockquote>\n\n`107-196`: **Consider extracting DISPLAY detection to a helper method.**\n\nThe DISPLAY detection logic spans 90 lines with multiple fallback strategies. Extracting this to a separate method like `_detect_display(user: str) -> Optional[str]` would improve readability and testability.\n\n</blockquote></details>\n<details>\n<summary>tests/test_root_helper.py (1)</summary><blockquote>\n\n`26-85`: **LGTM! Excellent security test coverage.**\n\nThe validation tests cover all major attack vectors including shell injection, path traversal, quote escaping, and length limits. This is thorough security testing.\n\n\n\n\n<details>\n<summary>Optional: Simplify boolean comparisons</summary>\n\nPer PEP 8, you can use implicit truthiness instead of explicit `== True/False`:\n\n```diff\n-    assert validate_key(\"046d:c52b:ABC123\") == True\n+    assert validate_key(\"046d:c52b:ABC123\")\n```\n\n```diff\n-    assert validate_key(\"046d:c52b:$(whoami)\") == False\n+    assert not validate_key(\"046d:c52b:$(whoami)\")\n```\n\nThis is a minor style preference and doesn't affect functionality.\n</details>\n\n</blockquote></details>\n<details>\n<summary>tests/test_usb_detection.py (2)</summary><blockquote>\n\n`43-45`: **Minor: Remove unnecessary f-string prefixes.**\n\nLines 43 and 45 use f-strings without any placeholders. These can be simplified to regular strings.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n     if device.is_high_risk:\n-        print(f\"   \\033[93m‚ö†Ô∏è  HIGH RISK: This device type can pose security risks!\\033[0m\")\n+        print(\"   \\033[93m‚ö†Ô∏è  HIGH RISK: This device type can pose security risks!\\033[0m\")\n     elif device.is_low_risk:\n-        print(f\"   \\033[92m‚úÖ Low risk device\\033[0m\")\n+        print(\"   \\033[92m‚úÖ Low risk device\\033[0m\")\n```\n</details>\n\n---\n\n`86-90`: **Optional: Prefix unused signal handler parameters.**\n\nThe signal handler parameters are required by the signature but unused. Consider prefixing them with underscore to indicate this is intentional.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-    def signal_handler(sig, frame):\n+    def signal_handler(_sig, _frame):\n         print(\"\\n\\nStopping USB monitor...\")\n         monitor.stop()\n         print(\"Done!\")\n         sys.exit(0)\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/root_helper.py (5)</summary><blockquote>\n\n`70-87`: **KEY_PATTERN is duplicated from `usb_validation.py`.**\n\nThis regex pattern is defined identically in `bastion/usb_validation.py` (lines 29-33). While duplication here may be intentional to keep the root helper standalone, consider importing from the validation module when available to avoid drift.\n\n---\n\n`94-134`: **Remove extraneous f-prefix on line 132.**\n\nThe f-string has no placeholders. This is flagged by static analysis (F541).\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-        logger.error(f\"Failed to set USB policy on any controller\")\n+        logger.error(\"Failed to set USB policy on any controller\")\n```\n</details>\n\n---\n\n`141-186`: **Consider using `logging.exception` for better stack traces.**\n\nIn exception handlers (lines 168, 183), using `logger.exception()` instead of `logger.error()` will include the stack trace, aiding debugging.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n         except ImportError as e:\n-            logger.error(f\"Cannot import USBRuleManager: {e}\")\n+            logger.exception(\"Cannot import USBRuleManager\")\n             print(\"ERROR: Cannot import bastion modules\", file=sys.stderr)\n             return 2\n     ...\n     except Exception as e:\n-        logger.error(f\"Error deleting rule {key}: {e}\")\n+        logger.exception(f\"Error deleting rule {key}\")\n         # Don't expose internal exception details to users\n         print(\"ERROR: Failed to delete rule\", file=sys.stderr)\n         return 2\n```\n</details>\n\n---\n\n`189-219`: **Remove extraneous f-prefix on line 206.**\n\nThe f-string has no placeholders.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-            print(f\"ERROR: Cannot import bastion modules\", file=sys.stderr)\n+            print(\"ERROR: Cannot import bastion modules\", file=sys.stderr)\n```\n</details>\n\n---\n\n`310-317`: **Redundant key validation.**\n\nThe key is validated twice: once at line 313 in `main()` and again at line 152 inside `cmd_usb_rule_delete()`. While defense-in-depth is good, consider removing the inner validation or documenting that it's intentional for direct function calls.\n\n</blockquote></details>\n<details>\n<summary>bastion-gui.py (2)</summary><blockquote>\n\n`314-334`: **Minor cleanup: Remove unused variable and extraneous f-prefix.**\n\nThe `result` variable at line 314 is unused, and line 334 has an f-string without placeholders.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-        result = dialog.exec()\n+        dialog.exec()\n\n         print(f\"[USB] Dialog result: {dialog.verdict} (scope={dialog.scope}, save_rule={dialog.save_rule})\")\n         ...\n         else:\n-            print(f\"[USB] Not connected, cannot send response\")\n+            print(\"[USB] Not connected, cannot send response\")\n```\n</details>\n\n---\n\n`330-332`: **Consider catching specific exception types.**\n\nCatching bare `Exception` is broad. Since this is socket I/O, consider catching `OSError` like the adjacent `handle_connection_request` does at line 263.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-            except Exception as e:\n+            except OSError as e:\n                 print(f\"[USB] Failed to send response: {e}\")\n                 self.handle_disconnect()\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_validation.py (1)</summary><blockquote>\n\n`203-214`: **Consider moving return into else block for clarity.**\n\nPer static analysis hint (TRY300), the success path could be in an `else` block. This is a minor style preference.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n     @staticmethod\n     def sanitize_timestamp(ts: str) -> str:\n         try:\n             datetime.fromisoformat(ts)\n-            return ts\n         except (ValueError, TypeError):\n             return datetime.now().isoformat()\n+        else:\n+            return ts\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_monitor.py (1)</summary><blockquote>\n\n`234-252`: **Minor: Unused lambda arguments in convenience function.**\n\nThe lambda at line 246 has unused parameters. This is functionally correct but flagged by linters.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-    monitor = USBMonitor(callback=lambda d, a: None)\n+    monitor = USBMonitor(callback=lambda _d, _a: None)\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_qt.py (2)</summary><blockquote>\n\n`952-983`: **Remove unused exception variable.**\n\nLine 980 catches `Exception as e` but doesn't use `e` in the handler.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-        except Exception as e:\n+        except Exception:\n             self.lbl_usb_title.setText(\"Unknown\")\n             self.lbl_usb_desc.setText(\"Could not check USB status\")\n```\n</details>\n\n---\n\n`1213-1217`: **Partial path for `pkexec` in some calls.**\n\nLines 1213-1214, 1229-1230 use `pkexec` without absolute path while other calls (line 1016, 1080) also use partial paths. For consistency, consider using `/usr/bin/pkexec` throughout.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (2)</summary><blockquote>\n\n`280-282`: **Remove extraneous f-prefix from radio button labels.**\n\nLine 280 has an f-string without placeholders.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-        self.rb_device = QRadioButton(f\"This device only\")\n+        self.rb_device = QRadioButton(\"This device only\")\n```\n</details>\n\n---\n\n`671-684`: **Remove unused variable `total`.**\n\nLine 682 computes `total` but never uses it.\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n         self._populate_table(self.table_blocked, blocked)\n\n         # Update status\n-        total = len(allowed) + len(blocked)\n         self.lbl_status_desc.setText(f\"Monitoring ‚Ä¢ {len(allowed)} allowed, {len(blocked)} blocked\")\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/daemon.py (5)</summary><blockquote>\n\n`291-351`: **GUI message reader has good security measures but check logging.**\n\nThe implementation includes good protections:\n- Buffer size limit (64KB) prevents memory exhaustion\n- UTF-8 decode error handling\n- Coordination with `_ask_gui` via `pending_requests` to prevent response stealing\n\nHowever, consider using `logging.exception` instead of `logging.error` on line 329 to include traceback information for debugging.\n\n\n\n\n<details>\n<summary>üîé Suggested logging improvement</summary>\n\n```diff\n-            logger.error(f\"GUI reader thread error: {e}\")\n+            logger.exception(f\"GUI reader thread error: {e}\")\n```\n\nThis provides automatic traceback information which is valuable for debugging thread errors.\n</details>\n\nBased on static analysis hints.\n\n---\n\n`752-765`: **GUI health check is functional; consider logging improvement.**\n\nThe GUI restart logic is straightforward. Consider using `logging.exception` on line 765 instead of `logging.error` to include traceback information for debugging.\n\n\n\n\n<details>\n<summary>üîé Suggested logging improvement</summary>\n\n```diff\n-            logger.error(f\"Error checking/starting GUI: {e}\")\n+            logger.exception(f\"Error checking/starting GUI: {e}\")\n```\n</details>\n\nBased on static analysis hints.\n\n---\n\n`767-788`: **Auto-reload mechanism is well-designed; minor logging improvement.**\n\nThe file modification tracking and thread-safe reload logic is solid. Creating a new `USBRuleManager` instance is safe since the daemon is the sole owner.\n\nConsider using `logging.exception` on line 788 for better debugging context.\n\n\n\n\n<details>\n<summary>üîé Suggested logging improvement</summary>\n\n```diff\n-            logger.error(f\"Error checking USB rules file: {e}\")\n+            logger.exception(f\"Error checking USB rules file: {e}\")\n```\n</details>\n\nBased on static analysis hints.\n\n---\n\n`790-812`: **Strong USB monitoring initialization with secure defaults.**\n\nKey security feature: Setting default USB policy to `BLOCK` (line 799) ensures devices are denied until explicitly allowed by the user‚Äîgood security posture.\n\nConsider using `logging.exception` on line 811 for debugging context.\n\n\n\n\n<details>\n<summary>üîé Suggested logging improvement</summary>\n\n```diff\n-            logger.error(f\"Error starting USB monitor: {e}\")\n+            logger.exception(f\"Error starting USB monitor: {e}\")\n```\n</details>\n\nBased on static analysis hints.\n\n---\n\n`842-960`: **Excellent security implementation with nonce-based anti-spoofing.**\n\nThis code demonstrates strong security practices:\n\n**Strengths:**\n- Cryptographically secure nonce generation (`secrets.token_hex(32)` = 256 bits)\n- Timing-safe nonce comparison with `secrets.compare_digest` (line 951)\n- Input sanitization via whitelist validation for `verdict` and `scope` (lines 937-943)\n- Proper thread-safe state management with locks\n- Risk-based fallback when GUI is unavailable or times out\n- Clear audit trail with comprehensive logging\n\n**Minor improvements:**\n1. Line 883: Remove unnecessary `f` prefix from string (no placeholders)\n2. Line 923: Use `logging.exception` instead of `logging.error` for better tracebacks\n\n\n\n\n<details>\n<summary>üîé Suggested improvements</summary>\n\n```diff\n-            logger.debug(f\"USB request sent, waiting for GUI response...\")\n+            logger.debug(\"USB request sent, waiting for GUI response...\")\n```\n\n```diff\n-            logger.error(f\"Error prompting for USB decision: {e}\")\n+            logger.exception(f\"Error prompting for USB decision: {e}\")\n```\n</details>\n\nBased on static analysis hints.\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>üìú Review details</summary>\n\n**Configuration used**: defaults\n\n**Review profile**: CHILL\n\n**Plan**: Pro\n\n<details>\n<summary>üì• Commits</summary>\n\nReviewing files that changed from the base of the PR and between 160a9472a7fb18148bd6b5422fdc4faf8128ee3c and ba6c9352bd6e6326b1623756b592cd0b6a692ef3.\n\n</details>\n\n<details>\n<summary>‚õî Files ignored due to path filters (10)</summary>\n\n* `bastion/resources/nav-logs.png` is excluded by `!**/*.png`\n* `bastion/resources/nav-logs.svg` is excluded by `!**/*.svg`\n* `bastion/resources/nav-rules.png` is excluded by `!**/*.png`\n* `bastion/resources/nav-rules.svg` is excluded by `!**/*.svg`\n* `bastion/resources/nav-settings.png` is excluded by `!**/*.png`\n* `bastion/resources/nav-settings.svg` is excluded by `!**/*.svg`\n* `bastion/resources/nav-status.png` is excluded by `!**/*.png`\n* `bastion/resources/nav-status.svg` is excluded by `!**/*.svg`\n* `bastion/resources/nav-usb.png` is excluded by `!**/*.png`\n* `bastion/resources/nav-usb.svg` is excluded by `!**/*.svg`\n\n</details>\n\n<details>\n<summary>üìí Files selected for processing (30)</summary>\n\n* `.gitignore`\n* `README.md`\n* `SECURITY.md`\n* `bastion-gui.py`\n* `bastion.conf`\n* `bastion/daemon.py`\n* `bastion/firewall_core.py`\n* `bastion/gui_manager.py`\n* `bastion/gui_qt.py`\n* `bastion/gui_theme.py`\n* `bastion/icon_manager.py`\n* `bastion/root_helper.py`\n* `bastion/usb_device.py`\n* `bastion/usb_gui.py`\n* `bastion/usb_monitor.py`\n* `bastion/usb_rules.py`\n* `bastion/usb_validation.py`\n* `build_deb.sh`\n* `com.bastion.root-helper.policy`\n* `debian/DEBIAN/control`\n* `launch_bastion.sh`\n* `requirements.txt`\n* `setup.py`\n* `test_network.py`\n* `test_startup.py`\n* `tests/test_root_helper.py`\n* `tests/test_usb_detection.py`\n* `tests/test_usb_rules.py`\n* `ufw_firewall_gui.py`\n* `uninstall_bastion.sh`\n\n</details>\n\n<details>\n<summary>üí§ Files with no reviewable changes (4)</summary>\n\n* test_startup.py\n* test_network.py\n* bastion/firewall_core.py\n* ufw_firewall_gui.py\n\n</details>\n\n<details>\n<summary>üß∞ Additional context used</summary>\n\n<details>\n<summary>üß¨ Code graph analysis (10)</summary>\n\n<details>\n<summary>bastion/usb_monitor.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (4)</summary>\n\n* `USBValidation` (36-214)\n* `sanitize_serial` (77-107)\n* `sanitize_hex_id` (64-74)\n* `sanitize_string` (110-128)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>uninstall_bastion.sh (3)</summary><blockquote>\n\n<details>\n<summary>build_deb.sh (1)</summary>\n\n* `print_info` (16-16)\n\n</details>\n<details>\n<summary>switch_to_enforcement.sh (2)</summary>\n\n* `print_info` (19-21)\n* `print_warning` (23-25)\n\n</details>\n<details>\n<summary>setup_firewall.sh (2)</summary>\n\n* `print_info` (37-39)\n* `print_warning` (41-43)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (7)</summary>\n\n* `USBValidation` (36-214)\n* `sanitize_hex_id` (64-74)\n* `sanitize_serial` (77-107)\n* `validate_verdict` (52-54)\n* `sanitize_string` (110-128)\n* `validate_scope` (57-61)\n* `sanitize_timestamp` (204-214)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>tests/test_root_helper.py (3)</summary><blockquote>\n\n<details>\n<summary>bastion/root_helper.py (4)</summary>\n\n* `main` (271-326)\n* `validate_key` (77-87)\n* `cmd_usb_rule_delete` (141-186)\n* `cmd_usb_default_policy_set` (94-134)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (1)</summary>\n\n* `validate_key` (184-201)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py (2)</summary>\n\n* `remove_rule` (379-394)\n* `key` (52-69)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_validation.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_rules.py (1)</summary>\n\n* `key` (52-69)\n\n</details>\n<details>\n<summary>bastion/root_helper.py (1)</summary>\n\n* `validate_key` (77-87)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>tests/test_usb_rules.py (3)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py (3)</summary>\n\n* `USBRule` (39-95)\n* `from_dict` (76-95)\n* `key` (52-69)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (4)</summary>\n\n* `USBValidation` (36-214)\n* `sanitize_serial` (77-107)\n* `sanitize_key` (131-181)\n* `validate_key` (184-201)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (5)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (3)</summary>\n\n* `USBDeviceInfo` (52-157)\n* `is_high_risk` (114-118)\n* `class_name` (132-149)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py (5)</summary>\n\n* `USBRuleManager` (98-400)\n* `USBRule` (39-95)\n* `key` (52-69)\n* `get_allowed_devices` (371-373)\n* `get_blocked_devices` (375-377)\n\n</details>\n<details>\n<summary>bastion/gui_qt.py (1)</summary>\n\n* `create_button` (313-345)\n\n</details>\n<details>\n<summary>bastion/notification.py (1)</summary>\n\n* `show_notification` (61-63)\n\n</details>\n<details>\n<summary>bastion/icon_manager.py (2)</summary>\n\n* `IconManager` (20-196)\n* `get_nav_icon` (166-196)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>build_deb.sh (1)</summary><blockquote>\n\n<details>\n<summary>rebrand_to_bastion.sh (1)</summary>\n\n* `print_step` (19-21)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_qt.py (3)</summary><blockquote>\n\n<details>\n<summary>bastion/icon_manager.py (2)</summary>\n\n* `IconManager` (20-196)\n* `get_nav_icon` (166-196)\n\n</details>\n<details>\n<summary>bastion/usb_gui.py (2)</summary>\n\n* `USBControlWidget` (452-907)\n* `refresh` (671-683)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py (3)</summary>\n\n* `USBRuleManager` (98-400)\n* `get_allowed_devices` (371-373)\n* `get_blocked_devices` (375-377)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion-gui.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_gui.py (1)</summary>\n\n* `USBPromptDialog` (147-449)\n\n</details>\n\n</blockquote></details>\n\n</details><details>\n<summary>ü™õ markdownlint-cli2 (0.18.1)</summary>\n\n<details>\n<summary>SECURITY.md</summary>\n\n13-13: Fenced code blocks should have a language specified\n\n(MD040, fenced-code-language)\n\n</details>\n\n</details>\n<details>\n<summary>ü™õ Ruff (0.14.10)</summary>\n\n<details>\n<summary>bastion/root_helper.py</summary>\n\n48-50: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n48-48: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n132-132: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n168-168: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n182-182: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n183-183: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n205-205: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n206-206: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n214-214: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n215-215: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n216-216: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>tests/test_usb_detection.py</summary>\n\n43-43: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n45-45: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n61-61: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n86-86: Unused function argument: `sig`\n\n(ARG001)\n\n---\n\n86-86: Unused function argument: `frame`\n\n(ARG001)\n\n</details>\n<details>\n<summary>bastion/usb_monitor.py</summary>\n\n38-38: Undefined name `Callable`\n\n(F821)\n\n---\n\n84-84: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n86-86: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n87-87: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n120-120: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n121-121: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n190-190: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n207-207: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n228-228: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n229-229: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n246-246: Unused lambda argument: `d`\n\n(ARG005)\n\n---\n\n246-246: Unused lambda argument: `a`\n\n(ARG005)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py</summary>\n\n146-146: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n153-153: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n221-221: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n231-231: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n235-235: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n236-236: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n237-237: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n270-270: Abstract `raise` to an inner function\n\n(TRY301)\n\n---\n\n270-270: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n290-290: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n428-428: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n436-436: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n440-440: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n458-458: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n474-474: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n479-479: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n481-481: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n498-498: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n503-503: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n505-505: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>tests/test_root_helper.py</summary>\n\n33-33: Avoid equality comparisons to `True`; use `validate_key(\"046d:c52b:ABC123\"):` for truth checks\n\nReplace with `validate_key(\"046d:c52b:ABC123\")`\n\n(E712)\n\n---\n\n37-37: Avoid equality comparisons to `True`; use `validate_key(\"046d:c52b:*\"):` for truth checks\n\nReplace with `validate_key(\"046d:c52b:*\")`\n\n(E712)\n\n---\n\n41-41: Avoid equality comparisons to `True`; use `validate_key(\"046d:*:*\"):` for truth checks\n\nReplace with `validate_key(\"046d:*:*\")`\n\n(E712)\n\n---\n\n45-45: Avoid equality comparisons to `False`; use `not validate_key(\"046d:c52b:$(whoami)\"):` for false checks\n\nReplace with `not validate_key(\"046d:c52b:$(whoami)\")`\n\n(E712)\n\n---\n\n49-49: Avoid equality comparisons to `False`; use `not validate_key(\"../../../etc:passwd:*\"):` for false checks\n\nReplace with `not validate_key(\"../../../etc:passwd:*\")`\n\n(E712)\n\n---\n\n53-53: Avoid equality comparisons to `False`; use `not validate_key(\"046d:c52b:'test\"):` for false checks\n\nReplace with `not validate_key(\"046d:c52b:'test\")`\n\n(E712)\n\n---\n\n56-56: Avoid equality comparisons to `False`; use `not validate_key('046d:c52b:\"test'):` for false checks\n\nReplace with `not validate_key('046d:c52b:\"test')`\n\n(E712)\n\n---\n\n60-60: Avoid equality comparisons to `False`; use `not validate_key(\"046d:c52b:test;rm -rf /\"):` for false checks\n\nReplace with `not validate_key(\"046d:c52b:test;rm -rf /\")`\n\n(E712)\n\n---\n\n64-64: Avoid equality comparisons to `False`; use `not validate_key(\"046d:c52b:`whoami`\"):` for false checks\n\nReplace with `not validate_key(\"046d:c52b:`whoami`\")`\n\n(E712)\n\n---\n\n69-69: Avoid equality comparisons to `False`; use `not validate_key(long_key):` for false checks\n\nReplace with `not validate_key(long_key)`\n\n(E712)\n\n---\n\n73-73: Avoid equality comparisons to `False`; use `not validate_key(\"\"):` for false checks\n\nReplace with `not validate_key(\"\")`\n\n(E712)\n\n---\n\n74-74: Avoid equality comparisons to `False`; use `not validate_key(None):` for false checks\n\nReplace with `not validate_key(None)`\n\n(E712)\n\n---\n\n78-78: Avoid equality comparisons to `False`; use `not validate_key(\"invalid\"):` for false checks\n\nReplace with `not validate_key(\"invalid\")`\n\n(E712)\n\n---\n\n79-79: Avoid equality comparisons to `False`; use `not validate_key(\"046d\"):` for false checks\n\nReplace with `not validate_key(\"046d\")`\n\n(E712)\n\n</details>\n<details>\n<summary>bastion/icon_manager.py</summary>\n\n29-35: Mutable class attributes should be annotated with `typing.ClassVar`\n\n(RUF012)\n\n---\n\n194-194: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py</summary>\n\n212-212: Consider moving this statement to an `else` block\n\n(TRY300)\n\n</details>\n<details>\n<summary>bastion/gui_manager.py</summary>\n\n62-62: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n66-66: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n67-67: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n90-90: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n98-98: Do not use bare `except`\n\n(E722)\n\n---\n\n98-99: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n119-119: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n120-120: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n145-145: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n151-151: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n152-152: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n171-171: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n173-173: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n173-173: try-except block with duplicate exception `Exception`\n\n(B025)\n\n---\n\n181-181: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n182-182: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n191-191: Do not use bare `except`\n\n(E722)\n\n---\n\n191-192: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n224-224: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n234-234: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>tests/test_usb_rules.py</summary>\n\n181-181: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n292-292: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n</details>\n<details>\n<summary>bastion/usb_gui.py</summary>\n\n280-280: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n422-422: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n436-436: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n682-682: Local variable `total` is assigned to but never used\n\nRemove assignment to unused variable `total`\n\n(F841)\n\n---\n\n768-768: Undefined name `subprocess`\n\n(F821)\n\n---\n\n787-787: Undefined name `subprocess`\n\n(F821)\n\n---\n\n788-788: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n792-792: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n795-795: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n796-796: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n868-868: Undefined name `subprocess`\n\n(F821)\n\n---\n\n894-894: Undefined name `subprocess`\n\n(F821)\n\n---\n\n895-895: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n898-898: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n900-900: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n906-906: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n915-915: Local variable `app` is assigned to but never used\n\nRemove assignment to unused variable `app`\n\n(F841)\n\n</details>\n<details>\n<summary>bastion/daemon.py</summary>\n\n325-325: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n328-328: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n329-329: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n441-441: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n764-764: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n765-765: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n787-787: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n788-788: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n810-810: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n811-811: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n883-883: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n922-922: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n923-923: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>bastion/gui_qt.py</summary>\n\n533-533: Multiple statements on one line (colon)\n\n(E701)\n\n---\n\n533-533: Multiple statements on one line (semicolon)\n\n(E702)\n\n---\n\n948-948: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n980-980: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n980-980: Local variable `e` is assigned to but never used\n\nRemove assignment to unused variable `e`\n\n(F841)\n\n---\n\n990-990: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n994-994: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n1016-1016: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n1016-1016: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n1080-1080: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n1083-1083: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n1101-1101: Redundant exception object included in `logging.exception` call\n\n(TRY401)\n\n---\n\n1213-1213: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n1213-1213: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n1214-1214: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n1214-1214: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n1229-1229: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n1229-1229: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n1230-1230: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n1230-1230: Starting a process with a partial executable path\n\n(S607)\n\n</details>\n<details>\n<summary>bastion-gui.py</summary>\n\n314-314: Local variable `result` is assigned to but never used\n\nRemove assignment to unused variable `result`\n\n(F841)\n\n---\n\n330-330: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n334-334: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n</details>\n\n</details>\n\n</details>\n\n<details>\n<summary>üîá Additional comments (73)</summary><blockquote>\n\n<details>\n<summary>requirements.txt (1)</summary><blockquote>\n\n`12-14`: **LGTM!**\n\nThe pyudev dependency is appropriately added with a descriptive section header and a reasonable minimum version constraint. This aligns with the USB monitoring functionality introduced in this PR.\n\n</blockquote></details>\n<details>\n<summary>bastion.conf (1)</summary><blockquote>\n\n`5-7`: **LGTM!**\n\nThe tmpfiles.d configuration correctly creates the runtime directory for the daemon socket. The 0755 permissions allow non-root GUI processes to connect to the socket while maintaining root ownership for write operations.\n\n</blockquote></details>\n<details>\n<summary>README.md (2)</summary><blockquote>\n\n`25-25`: **LGTM!**\n\nClear and concise feature description that accurately reflects the new USB device control functionality.\n\n---\n\n`61-64`: **LGTM!**\n\nThe system tray feature list is appropriately updated to distinguish firewall rules from USB device management.\n\n</blockquote></details>\n<details>\n<summary>debian/DEBIAN/control (1)</summary><blockquote>\n\n`6-7`: **LGTM on the dependency additions.**\n\nThe `python3-pyudev` runtime dependency correctly mirrors the `requirements.txt` addition, and the `Installed-Size` increase is reasonable given the new USB control modules.\n\n</blockquote></details>\n<details>\n<summary>uninstall_bastion.sh (4)</summary><blockquote>\n\n`263-275`: **Excellent security measure for runtime directory removal.**\n\nThe symlink check and `realpath` verification effectively prevent symlink-based attacks where an attacker could create `/run/bastion` as a symlink to a sensitive directory. This is a well-implemented defense-in-depth measure.\n\n---\n\n`204-214`: **LGTM on binary cleanup.**\n\nThe binary removal properly covers both legacy Douane and current Bastion binaries, including the new `bastion-root-helper`. Error suppression with `2>/dev/null || true` appropriately handles missing files.\n\n---\n\n`256-261`: **LGTM on tmpfiles.d cleanup.**\n\nProperly removes the tmpfiles.d configuration added by this PR.\n\n---\n\n`295-301`: **Glob patterns in `rm` may not expand as expected.**\n\nThe double-quoted glob patterns like `\"$user_home/.config/autostart/douane\"*.desktop` will not expand correctly. The glob should be outside the quotes.\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n for user_home in /home/*; do\n     if [ -d \"$user_home/.config/autostart\" ]; then\n-        rm -f \"$user_home/.config/autostart/douane\"*.desktop 2>/dev/null || true\n-        rm -f \"$user_home/.config/autostart/bastion\"*.desktop 2>/dev/null || true\n+        rm -f \"$user_home\"/.config/autostart/douane*.desktop 2>/dev/null || true\n+        rm -f \"$user_home\"/.config/autostart/bastion*.desktop 2>/dev/null || true\n     fi\n done\n```\n</details>\n\n\n\n> Likely an incorrect or invalid review comment.\n\n</blockquote></details>\n<details>\n<summary>launch_bastion.sh (1)</summary><blockquote>\n\n`13-19`: **LGTM on tray icon management.**\n\nThe check for an existing GUI process before spawning a new one prevents duplicate tray icons. Using the full path in `pgrep -f` is appropriate for accurate matching.\n\n</blockquote></details>\n<details>\n<summary>SECURITY.md (3)</summary><blockquote>\n\n`9-42`: **Excellent security architecture documentation.**\n\nThe ASCII diagram clearly illustrates privilege separation between unprivileged GUI, the pkexec-invoked root helper, and the privileged daemon. This documentation will help security reviewers and contributors understand the trust boundaries.\n\n---\n\n`58-70`: **LGTM on input validation documentation.**\n\nThe validation rules are specific and actionable, with clear max lengths and character restrictions. This serves as both documentation and a specification for implementers.\n\n---\n\n`91-95`: **Transparent disclosure of security limitations.**\n\nHonestly documenting limitations (DoS via deauthorization, kernel bypass, pre-boot attacks) helps users understand the threat model and make informed decisions about their security posture.\n\n</blockquote></details>\n<details>\n<summary>bastion/icon_manager.py (1)</summary><blockquote>\n\n`165-196`: **LGTM on navigation icon loading with good defensive checks.**\n\nThe implementation properly handles missing icons, failed loads, and empty pixmaps, returning an empty `QIcon` to trigger the emoji fallback in the UI. The double validation (icon not null AND pixmap not null at line 189) is a good safeguard.\n\nThe broad `Exception` catch at line 194 is acceptable here since Qt icon loading can raise various exceptions, and the fallback behavior (empty icon) is appropriate for any failure mode.\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_theme.py (1)</summary><blockquote>\n\n`1-47`: **LGTM! Clean theme configuration.**\n\nThe centralized theme configuration provides a clean separation of concerns for UI styling and localization. The accessor functions with fallback defaults ensure safe usage across the application.\n\n</blockquote></details>\n<details>\n<summary>build_deb.sh (4)</summary><blockquote>\n\n`53-53`: **LGTM!**\n\nCorrect location for systemd tmpfiles.d configuration.\n\n---\n\n`73-83`: **LGTM! Clean root helper wrapper.**\n\nThe wrapper script properly delegates to the bastion.root_helper module with correct path setup.\n\n---\n\n`85-88`: **LGTM! Secure policy file installation.**\n\nUsing `install -m 0644` ensures the policy file has correct permissions (root-owned, not writable by others).\n\n---\n\n`126-128`: **LGTM! Proper tmpfiles.d configuration.**\n\nThe tmpfiles.d config ensures /run/bastion directory is created by systemd.\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_manager.py (3)</summary><blockquote>\n\n`53-69`: **LGTM! Defensive process checking.**\n\nThe method safely checks GUI process status with appropriate timeout and defensive error handling. The broad exception catch is acceptable here as it returns a safe default (False) on any error.\n\n---\n\n`71-103`: **LGTM! Robust user detection.**\n\nThe fallback chain from SUDO_USER to `who` command provides reliable user detection for GUI startup.\n\n---\n\n`218-231`: **LGTM! Proper privilege demotion.**\n\nThe privilege demotion correctly sets GID before UID, which is the proper order to avoid permission errors. The approach ensures the GUI runs as the target user, not root.\n\n</blockquote></details>\n<details>\n<summary>com.bastion.root-helper.policy (1)</summary><blockquote>\n\n`1-64`: **LGTM! Secure polkit policy configuration.**\n\nThe policy correctly restricts privileged operations to authenticated admin users in active sessions only, denying remote/inactive access. The `auth_admin_keep` setting provides reasonable convenience without compromising security.\n\n</blockquote></details>\n<details>\n<summary>tests/test_root_helper.py (1)</summary><blockquote>\n\n`87-162`: **LGTM! Comprehensive CLI testing.**\n\nThe tests properly cover CLI argument handling and command execution with appropriate mocking. The security tests for injection attempts are particularly valuable.\n\n</blockquote></details>\n<details>\n<summary>tests/test_usb_detection.py (1)</summary><blockquote>\n\n`51-106`: **LGTM! Well-structured USB detection test.**\n\nThe test provides good interactive verification of USB monitoring with clear output formatting and graceful shutdown handling.\n\n</blockquote></details>\n<details>\n<summary>tests/test_usb_rules.py (6)</summary><blockquote>\n\n`22-122`: **LGTM! Comprehensive rule storage testing.**\n\nThe test thoroughly validates rule persistence, file permissions, JSON integrity, and scope matching. The permission checks (lines 55-60) are particularly valuable for security.\n\n---\n\n`125-164`: **LGTM! Excellent security testing.**\n\nThe sanitization tests validate defenses against path traversal, XSS, null byte injection, and buffer overflow attempts. This demonstrates strong security awareness.\n\n---\n\n`167-188`: **LGTM! Proper path traversal prevention.**\n\nThe authorizer tests confirm that path traversal attempts are properly blocked at the filesystem level.\n\n---\n\n`191-255`: **LGTM! Thorough serial sanitization testing.**\n\nThis test validates removal of all dangerous characters including shell metacharacters, quotes, backticks, dollar signs, newlines, null bytes, and enforces length limits. Excellent security coverage.\n\n---\n\n`258-319`: **LGTM! Complete key validation coverage.**\n\nThe tests cover all key formats (device, model, vendor), malicious input sanitization, old format conversion, and proper rejection of invalid keys.\n\n---\n\n`322-361`: **LGTM! End-to-end security validation.**\n\nThis integration test confirms that malicious serials are sanitized throughout the entire rule management flow, from addition to storage to retrieval.\n\n</blockquote></details>\n<details>\n<summary>setup.py (2)</summary><blockquote>\n\n`21-26`: **LGTM! Proper entry point configuration.**\n\nThe console script entry point for `bastion-root-helper` is correctly configured to invoke the root helper module's main function.\n\n---\n\n`27-38`: **LGTM! Complete packaging configuration.**\n\nThe data_files entries properly install all required desktop files, autostart configuration, polkit policy, and systemd service in their correct system locations.\n\n</blockquote></details>\n<details>\n<summary>bastion/root_helper.py (2)</summary><blockquote>\n\n`32-57`: **LGTM - Syslog logging setup with appropriate fallback.**\n\nThe silent exception catch at line 48-50 is intentional for environments where `/dev/log` is unavailable. The stderr fallback ensures audit messages are still captured.\n\n---\n\n`226-268`: **LGTM - CLI argument parser is well-structured.**\n\nThe parser provides a fixed command set with mutually exclusive options, preventing arbitrary code execution. The help text and examples are clear.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_device.py (2)</summary><blockquote>\n\n`13-48`: **LGTM - Well-designed USB class enumeration with risk categorization.**\n\nThe `USBClass` enum covers standard USB class codes, and the risk sets appropriately classify HID and wireless devices as high-risk while hubs and audio/video devices are low-risk.\n\n---\n\n`51-158`: **LGTM - Clean dataclass with proper risk precedence logic.**\n\nThe `is_low_risk` property correctly checks `is_high_risk` first to ensure a device cannot be both. The interface_classes handling ensures composite devices (like keyboards with storage) are correctly classified as high-risk.\n\n</blockquote></details>\n<details>\n<summary>bastion-gui.py (3)</summary><blockquote>\n\n`20-28`: **Good improvement: Per-user lock file prevents cross-user blocking.**\n\nUsing `XDG_RUNTIME_DIR` with fallback to `~/.cache/bastion` ensures each user has their own lock, preventing one user's GUI from blocking another's.\n\n---\n\n`56-61`: **Socket path change aligns with daemon relocation.**\n\nMoving to `/run/bastion/daemon.sock` follows systemd conventions for runtime sockets.\n\n---\n\n`266-290`: **Excellent anti-spoofing: Nonce validation prevents malicious injection.**\n\nRejecting requests without a nonce and echoing it back is a solid security measure against IPC message spoofing.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_validation.py (4)</summary><blockquote>\n\n`23-33`: **LGTM - Consistent regex patterns for sanitization.**\n\nThe character sets and key pattern are well-defined with clear comments explaining each format variant.\n\n---\n\n`51-61`: **LGTM - Safe validation with sensible defaults.**\n\n`validate_verdict` defaults to 'block' (fail-safe) and `validate_scope` defaults to 'device' (most restrictive scope).\n\n---\n\n`63-107`: **LGTM - Robust sanitization with logging.**\n\n`sanitize_hex_id` handles edge cases (non-string, empty) gracefully with zero-padding. `sanitize_serial` logs modifications which aids debugging suspicious devices.\n\n---\n\n`130-181`: **LGTM - Key normalization handles legacy formats.**\n\nThe 2-part to 3-part key migration ensures backwards compatibility while maintaining strict validation.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_monitor.py (3)</summary><blockquote>\n\n`53-88`: **LGTM - Robust monitor start with graceful error handling.**\n\nThe start method properly checks for pyudev availability and handles exceptions during observer setup.\n\n---\n\n`103-121`: **LGTM - Proper event filtering for USB devices.**\n\nSkipping interfaces (sys_name containing `:`) ensures only actual device events are processed, not interface-level events.\n\n---\n\n`123-209`: **LGTM - Thorough device info extraction with sanitization.**\n\nInterface class extraction for composite devices (PER_INTERFACE class 0x00) ensures HID capabilities are detected even on multi-function devices. All values are sanitized via `USBValidation`.\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_qt.py (5)</summary><blockquote>\n\n`468-501`: **LGTM - USB page integration with navigation.**\n\nThe USB page is properly added to the navigation and content stack, with icon fallback support.\n\n---\n\n`504-525`: **LGTM - Icon fallback mechanism is robust.**\n\nAttempting custom icons first and falling back to emoji ensures the UI works across different icon themes.\n\n---\n\n`617-651`: **LGTM - USB status card provides at-a-glance protection status.**\n\nThe card follows the existing pattern for outbound/inbound cards and navigates to the USB page for management.\n\n---\n\n`887-927`: **Good security practice: Absolute paths for system commands.**\n\nUsing `/usr/bin/systemctl` instead of `systemctl` prevents PATH hijacking attacks when running with elevated privileges.\n\n---\n\n`1088-1103`: **LGTM - Tray icon launch with absolute path and process isolation.**\n\nUsing `start_new_session=True` properly detaches the tray process, and the absolute path prevents hijacking.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (6)</summary><blockquote>\n\n`38-95`: **LGTM - USBRule dataclass with proper sanitization.**\n\nThe `from_dict` method sanitizes all inputs, and the `key` property generates consistent sanitized keys based on scope.\n\n---\n\n`135-155`: **LGTM - Double symlink check mitigates TOCTOU race.**\n\nChecking before `mkdir` and after creation reduces the window for symlink attacks.\n\n---\n\n`239-291`: **LGTM - Atomic save with proper cleanup.**\n\nThe temp file + rename pattern is correct. The symlink check before replace and cleanup in exception handlers are well-implemented.\n\n---\n\n`316-340`: **`last_seen` update is not persisted.**\n\nLine 327 updates `rule.last_seen` in memory but doesn't call `_save()`. This means `last_seen` will be lost on reload. If this is intentional (to avoid disk I/O on every lookup), consider documenting it or adding periodic persistence.\n\n---\n\n`418-441`: **LGTM - Safe bus_id sanitization prevents path traversal.**\n\nThe regex sanitization, empty check, and `..` rejection ensure the bus_id cannot escape the sysfs path.\n\n---\n\n`517-549`: **LGTM - Default policy application with proper error handling.**\n\nIterating over all USB host controllers and reporting partial success is appropriate behavior.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (5)</summary><blockquote>\n\n`28-144`: **LGTM - ConfirmDeleteDialog follows application theme.**\n\nThe dialog styling is consistent with other dialogs in the application.\n\n---\n\n`147-262`: **LGTM - USBPromptDialog with risk-based styling.**\n\nUsing danger color for high-risk devices and showing warnings for HID-capable devices provides appropriate user guidance.\n\n---\n\n`752-797`: **LGTM - Privileged policy change with proper error handling.**\n\nUsing the root helper with absolute path and handling authentication cancellation (returncode 126) provides good UX.\n\n---\n\n`850-907`: **LGTM - Rule deletion with privilege escalation.**\n\nThe root helper is used correctly, and various error conditions (timeout, not found, permission denied) are handled with appropriate user feedback.\n\n---\n\n`910-939`: **Note: `app` variable in test function is required.**\n\nLine 915's `app` appears unused but is required to initialize the Qt event loop. The linter warning (F841) is a false positive in this context.\n\n</blockquote></details>\n<details>\n<summary>bastion/daemon.py (10)</summary><blockquote>\n\n`10-10`: **LGTM! Good security practice with `secrets` module.**\n\nThe imports are appropriate. Using `secrets` for nonce generation is the correct choice for anti-spoofing tokens.\n\n\n\n\nAlso applies to: 20-23\n\n---\n\n`93-95`: **Good security improvement moving socket to `/run/bastion`.**\n\nUsing `/run/bastion` instead of `/tmp` reduces the attack surface by avoiding world-writable directories.\n\n---\n\n`108-131`: **Well-structured USB and GUI state management.**\n\nThe initialization properly sets up thread-safe USB device control with:\n- Appropriate locks for concurrent access (`usb_rules_lock`, `usb_pending_lock`)\n- Anti-spoofing nonce for IPC security\n- Event-based synchronization for async responses\n\n---\n\n`180-181`: **USB monitor startup looks correct.**\n\nThe placement after GUI connection ensures the GUI is available for USB prompts.\n\n---\n\n`196-213`: **Good periodic health checking for USB rules and GUI.**\n\nThe check intervals (5s for USB rules, 10s for GUI) are well-balanced between responsiveness and resource usage.\n\n---\n\n`340-351`: **Clean message dispatching logic.**\n\nThe JSON parsing and message type dispatch is straightforward and handles errors appropriately.\n\n---\n\n`402-443`: **Excellent socket security improvements.**\n\nThe implementation demonstrates strong security practices:\n- Uses `/run/bastion` instead of world-writable `/tmp`\n- Restricts permissions to owner + group (0o660) or owner-only (0o600) as fallback\n- Explicit comment preventing world-writable permissions\n- Proper group-based access control with graceful degradation\n\n---\n\n`719-747`: **Good cleanup logic with proper USB policy restoration.**\n\nKey improvements:\n- More specific exception handling (`OSError` instead of bare `Exception`)\n- Restores USB default policy to `allow` on shutdown, ensuring the system works normally without the daemon\n- Proper cleanup order (USB monitor ‚Üí packet processor ‚Üí iptables ‚Üí socket)\n\n---\n\n`814-840`: **Clean USB event handling with proper thread safety.**\n\nThe logic correctly:\n- Filters to 'add' events only\n- Uses thread-safe rule lookup with `usb_rules_lock`\n- Applies authorization/deauthorization based on rules\n- Falls through to user prompt when no rule exists\n\n---\n\n`621-646`: **Incorrect claim about timeout reset mechanism.**\n\nThe timeout at line 628 (`self.gui_socket.settimeout(60.0)`) is set **once before the while loop**, not on each iteration. The review comment incorrectly states the timeout resets with each `usb_response`.\n\nHowever, there is a legitimate timing concern: each iteration of the while loop (lines 629‚Äì634) can block for up to 60 seconds on the `recv()` call. If multiple USB responses arrive in sequence, the total wait could reach (N+1)√ó60 seconds, where N is the number of USB responses‚Äîbut this is due to sequential blocking reads, not timeout resets.\n\nThe proposed fix also has a timing issue: it measures elapsed time from the try block (line 626), not from the original request start (line 610), so it doesn't actually enforce a unified 60-second budget for the entire operation.\n\n\n\n> Likely an incorrect or invalid review comment.\n\n</blockquote></details>\n\n</blockquote></details>\n\n</details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->","submittedAt":"2025-12-25T01:37:33Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"ba6c9352bd6e6326b1623756b592cd0b6a692ef3"}},{"id":"PRR_kwDOQsqSJc7XSoCj","author":{"login":"coderabbitai"},"authorAssociation":"CONTRIBUTOR","body":"**Actionable comments posted: 1**\n\n<details>\n<summary>‚ôªÔ∏è Duplicate comments (5)</summary><blockquote>\n\n<details>\n<summary>debian/DEBIAN/control (1)</summary><blockquote>\n\n`1-7`: **Past issue resolved: Build-Depends field removed.**\n\nThe invalid `Build-Depends` field mentioned in previous reviews has been correctly removed from this binary package control file. The dependencies are now properly categorized as runtime requirements.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_monitor.py (1)</summary><blockquote>\n\n`8-9`: **Past issue resolved: Callable import added.**\n\nThe missing `Callable` import flagged in previous reviews has been correctly added.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (1)</summary><blockquote>\n\n`8-8`: **Past issue resolved: Documentation now matches implementation.**\n\nThe file permission documentation (line 8) now correctly states \"0640\" matching the `FILE_MODE = 0o640` constant (line 121). The mismatch flagged in previous reviews has been corrected.\n\n\n\n\n\nAlso applies to: 121-121\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_manager.py (1)</summary><blockquote>\n\n`171-172`: **Past issue resolved: Duplicate exception handler removed.**\n\nThe duplicate exception handler flagged in previous reviews has been removed. The code now has a single exception handler at lines 171-172.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (1)</summary><blockquote>\n\n`10-11`: **Past issue resolved: subprocess import added.**\n\nThe missing `subprocess` import flagged in previous reviews has been correctly added.\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>üßπ Nitpick comments (5)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_monitor.py (2)</summary><blockquote>\n\n`86-88`: **Consider using `logging.exception` for better debugging context.**\n\nReplace `logger.error(f\"Failed to start USB monitor: {e}\")` with `logger.exception(\"Failed to start USB monitor\")` to automatically include the stack trace. This aids troubleshooting when USB monitoring fails due to system-level issues.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n         except Exception as e:\n-            logger.error(f\"Failed to start USB monitor: {e}\")\n+            logger.exception(\"Failed to start USB monitor\")\n             return False\n```\n</details>\n\n---\n\n`246-246`: **Use underscore for intentionally unused lambda arguments.**\n\nThe lambda callback arguments are intentionally unused. Follow Python convention by naming them with underscores to indicate they're ignored.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-    monitor = USBMonitor(callback=lambda d, a: None)\n+    monitor = USBMonitor(callback=lambda _device, _action: None)\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (1)</summary><blockquote>\n\n`418-441`: **Consider validating bus_id format more strictly.**\n\nThe current sanitization prevents path traversal, but you could add explicit format validation for bus_id (expected format: `^\\d+-[\\d.]+$` like \"1-2.3\"). This would reject malformed inputs earlier and provide clearer error messages.\n\n\n\n<details>\n<summary>üîé Proposed enhancement</summary>\n\n```diff\n     @classmethod\n     def _get_auth_path(cls, bus_id: str) -> Path:\n         \"\"\"Get authorization file path for device.\n\n         Raises:\n             ValueError: If bus_id is invalid or empty after sanitization.\n         \"\"\"\n         # Reject empty bus_id immediately\n         if not bus_id or not bus_id.strip():\n             logger.error(\"Invalid bus_id: empty string\")\n             raise ValueError(\"Invalid bus_id: empty string\")\n         \n+        # Validate expected format (e.g., \"1-2.3\" or \"1-2\")\n+        import re\n+        if not re.match(r'^\\d+-[\\d.]+$', bus_id):\n+            logger.error(f\"Invalid bus_id format: {bus_id}\")\n+            raise ValueError(f\"Invalid bus_id format: {bus_id}\")\n+        \n         # Sanitize bus_id to prevent path traversal\n         # Only allow alphanumeric and dash (bus_id format: \"1-2.3\" becomes \"1-23\")\n         safe_bus_id = re.sub(r'[^0-9a-zA-Z.-]', '', bus_id)\n         # Reject empty IDs after sanitization\n         if not safe_bus_id:\n             logger.error(f\"Invalid bus_id format (empty after sanitization): {bus_id}\")\n             raise ValueError(f\"Invalid bus_id: {bus_id}\")\n-        # Additional safety: reject if contains \"..\" or starts with \"/\"\n-        if '..' in safe_bus_id or safe_bus_id.startswith('/'):\n-            logger.error(f\"Invalid bus_id format: {bus_id}\")\n-            raise ValueError(f\"Invalid bus_id: {bus_id}\")\n         return cls.SYSFS_USB_PATH / safe_bus_id / 'authorized'\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (2)</summary><blockquote>\n\n`683-683`: **Remove unused `total` variable.**\n\nThe variable `total` is calculated but never used. Either remove it or use it in the status message if you intended to show the total count.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n         # Update status\n-        total = len(allowed) + len(blocked)\n         self.lbl_status_desc.setText(f\"Monitoring ‚Ä¢ {len(allowed)} allowed, {len(blocked)} blocked\")\n```\n</details>\n\n---\n\n`281-281`: **Remove unnecessary f-string prefix.**\n\nThe f-string has no placeholders. Use a regular string instead.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-        self.rb_device = QRadioButton(f\"This device only\")\n+        self.rb_device = QRadioButton(\"This device only\")\n```\n</details>\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>üìú Review details</summary>\n\n**Configuration used**: defaults\n\n**Review profile**: CHILL\n\n**Plan**: Pro\n\n<details>\n<summary>üì• Commits</summary>\n\nReviewing files that changed from the base of the PR and between ba6c9352bd6e6326b1623756b592cd0b6a692ef3 and daaef9d4123ee89bd278031d3516b609b5882b14.\n\n</details>\n\n<details>\n<summary>üìí Files selected for processing (5)</summary>\n\n* `bastion/gui_manager.py`\n* `bastion/usb_gui.py`\n* `bastion/usb_monitor.py`\n* `bastion/usb_rules.py`\n* `debian/DEBIAN/control`\n\n</details>\n\n<details>\n<summary>üß∞ Additional context used</summary>\n\n<details>\n<summary>üß¨ Code graph analysis (4)</summary>\n\n<details>\n<summary>bastion/usb_monitor.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (3)</summary>\n\n* `sanitize_serial` (77-107)\n* `sanitize_hex_id` (64-74)\n* `sanitize_string` (110-128)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (3)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (3)</summary>\n\n* `USBDeviceInfo` (52-157)\n* `is_high_risk` (114-118)\n* `class_name` (132-149)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py (5)</summary>\n\n* `USBRuleManager` (98-400)\n* `USBRule` (39-95)\n* `key` (52-69)\n* `get_allowed_devices` (371-373)\n* `get_blocked_devices` (375-377)\n\n</details>\n<details>\n<summary>bastion/notification.py (2)</summary>\n\n* `reject` (58-59)\n* `show_notification` (61-63)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (7)</summary>\n\n* `USBValidation` (36-214)\n* `sanitize_hex_id` (64-74)\n* `sanitize_serial` (77-107)\n* `validate_verdict` (52-54)\n* `sanitize_string` (110-128)\n* `validate_scope` (57-61)\n* `sanitize_timestamp` (204-214)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_manager.py (1)</summary><blockquote>\n\n<details>\n<summary>bastion/firewall_core.py (1)</summary>\n\n* `get` (49-72)\n\n</details>\n\n</blockquote></details>\n\n</details><details>\n<summary>ü™õ Ruff (0.14.10)</summary>\n\n<details>\n<summary>bastion/usb_monitor.py</summary>\n\n84-84: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n86-86: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n87-87: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n120-120: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n121-121: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n190-190: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n207-207: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n228-228: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n229-229: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n246-246: Unused lambda argument: `d`\n\n(ARG005)\n\n---\n\n246-246: Unused lambda argument: `a`\n\n(ARG005)\n\n</details>\n<details>\n<summary>bastion/usb_gui.py</summary>\n\n281-281: f-string without any placeholders\n\nRemove extraneous `f` prefix\n\n(F541)\n\n---\n\n423-423: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n437-437: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n683-683: Local variable `total` is assigned to but never used\n\nRemove assignment to unused variable `total`\n\n(F841)\n\n---\n\n769-769: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n770-770: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n789-789: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n793-793: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n796-796: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n797-797: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n869-869: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n870-870: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n896-896: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n899-899: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n901-901: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n907-907: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n916-916: Local variable `app` is assigned to but never used\n\nRemove assignment to unused variable `app`\n\n(F841)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py</summary>\n\n146-146: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n153-153: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n221-221: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n231-231: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n235-235: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n236-236: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n237-237: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n270-270: Abstract `raise` to an inner function\n\n(TRY301)\n\n---\n\n270-270: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n290-290: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n428-428: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n436-436: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n440-440: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n458-458: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n474-474: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n479-479: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n481-481: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n498-498: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n503-503: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n505-505: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>bastion/gui_manager.py</summary>\n\n62-62: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n66-66: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n67-67: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n90-90: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n98-98: Do not use bare `except`\n\n(E722)\n\n---\n\n98-99: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n119-119: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n120-120: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n145-145: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n151-151: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n152-152: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n171-171: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n179-179: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n180-180: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n189-189: Do not use bare `except`\n\n(E722)\n\n---\n\n189-190: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n222-222: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n232-232: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n\n</details>\n\n</details>\n\n<details>\n<summary>üîá Additional comments (5)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_monitor.py (1)</summary><blockquote>\n\n`157-160`: **Excellent security-focused sanitization of USB device data.**\n\nThe implementation properly sanitizes all device information before constructing USBDeviceInfo objects. Serial numbers, vendor/product IDs, and names are all passed through validation to prevent injection attacks. This defensive approach is appropriate given that USB devices can provide malicious data.\n\n\n\n\nAlso applies to: 193-204\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (1)</summary><blockquote>\n\n`143-154`: **Robust security implementation with symlink and TOCTOU protections.**\n\nThe code implements multiple layers of security:\n- Symlink detection before and after directory/file operations to prevent TOCTOU attacks\n- Atomic write pattern (temp file + rename) to prevent corruption\n- SecurityError exceptions for security-critical rejections\n\nThis defense-in-depth approach is appropriate for a security-focused firewall application.\n\n\n\n\nAlso applies to: 174-177, 266-270\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_manager.py (2)</summary><blockquote>\n\n`216-229`: **Privilege demotion implemented correctly with proper environment setup.**\n\nThe implementation properly demotes privileges using `setgid` before `setuid` and sets up the target user's environment (HOME, DISPLAY, XDG_RUNTIME_DIR, XAUTHORITY). The use of `preexec_fn` is appropriate here.\n\nNote: `preexec_fn` is not safe in multithreaded programs. Ensure the daemon is single-threaded or has minimal thread activity when calling `start_gui()`.\n\n---\n\n`110-191`: **Robust multi-layered DISPLAY detection strategy.**\n\nThe implementation uses three progressively broader detection methods:\n1. Direct `/proc/<pid>/environ` parsing (most reliable)\n2. `ps` output parsing (fallback)\n3. Common defaults with `xset` validation (last resort)\n\nThis approach handles various desktop environments and failure scenarios gracefully. The extensive logging aids troubleshooting.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (1)</summary><blockquote>\n\n`763-775`: **Secure privilege elevation implementation using root helper.**\n\nBoth methods correctly use absolute paths (`/usr/bin/bastion-root-helper`) to prevent PATH hijacking via pkexec, and pass arguments as CLI parameters rather than interpolating them into code. The 30-second timeout and return code checking (including 126 for user cancellation) are appropriate.\n\n\n\n\nAlso applies to: 862-874\n\n</blockquote></details>\n\n</blockquote></details>\n\n</details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->","submittedAt":"2025-12-25T07:57:08Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"daaef9d4123ee89bd278031d3516b609b5882b14"}},{"id":"PRR_kwDOQsqSJc7XSv_6","author":{"login":"coderabbitai"},"authorAssociation":"CONTRIBUTOR","body":"**Actionable comments posted: 4**\n\n<details>\n<summary>üßπ Nitpick comments (3)</summary><blockquote>\n\n<details>\n<summary>bastion/gui_manager.py (1)</summary><blockquote>\n\n`110-111`: **Log exceptions in bare except blocks for debuggability.**\n\nThese bare `except: pass` blocks silently swallow errors, making debugging difficult. Consider logging at debug level.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-                except:\n-                    pass\n+                except Exception as e:\n+                    logger.debug(f\"Could not get user from who: {e}\")\n```\n\n```diff\n-                    except:\n-                        pass\n+                    except Exception as e:\n+                        logger.debug(f\"Could not test display {display}: {e}\")\n```\n</details>\n\n\nAlso applies to: 205-206\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_monitor.py (1)</summary><blockquote>\n\n`86-88`: **Remove unused exception variable.**\n\nThe exception `e` is captured but unused since `logger.exception()` automatically includes the exception info.\n\n\n\n<details>\n<summary>üîé Proposed fix</summary>\n\n```diff\n-        except Exception as e:\n+        except Exception:\n             logger.exception(\"Failed to start USB monitor\")\n             return False\n```\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (1)</summary><blockquote>\n\n`674-674`: **Consider moving `USBRuleManager` reload to a dedicated method.**\n\nInstantiating a new `USBRuleManager` on every refresh reloads from disk, which is the intended behavior. However, if refresh is called frequently, this could cause I/O overhead.\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>üìú Review details</summary>\n\n**Configuration used**: defaults\n\n**Review profile**: CHILL\n\n**Plan**: Pro\n\n<details>\n<summary>üì• Commits</summary>\n\nReviewing files that changed from the base of the PR and between daaef9d4123ee89bd278031d3516b609b5882b14 and 94d9a1f05e422479d4bbfe1adeac224f56113aa2.\n\n</details>\n\n<details>\n<summary>üìí Files selected for processing (5)</summary>\n\n* `bastion/gui_manager.py`\n* `bastion/usb_gui.py`\n* `bastion/usb_monitor.py`\n* `bastion/usb_rules.py`\n* `debian/DEBIAN/control`\n\n</details>\n\n<details>\n<summary>üß∞ Additional context used</summary>\n\n<details>\n<summary>üß¨ Code graph analysis (2)</summary>\n\n<details>\n<summary>bastion/usb_rules.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (7)</summary>\n\n* `USBValidation` (36-214)\n* `sanitize_hex_id` (64-74)\n* `sanitize_serial` (77-107)\n* `sanitize_timestamp` (204-214)\n* `validate_verdict` (52-54)\n* `sanitize_string` (110-128)\n* `validate_scope` (57-61)\n\n</details>\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_monitor.py (2)</summary><blockquote>\n\n<details>\n<summary>bastion/usb_device.py (1)</summary>\n\n* `USBDeviceInfo` (52-157)\n\n</details>\n<details>\n<summary>bastion/usb_validation.py (4)</summary>\n\n* `USBValidation` (36-214)\n* `sanitize_serial` (77-107)\n* `sanitize_hex_id` (64-74)\n* `sanitize_string` (110-128)\n\n</details>\n\n</blockquote></details>\n\n</details><details>\n<summary>ü™õ Ruff (0.14.10)</summary>\n\n<details>\n<summary>bastion/gui_manager.py</summary>\n\n63-63: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n67-67: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n68-68: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n91-91: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n110-110: Do not use bare `except`\n\n(E722)\n\n---\n\n110-111: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n131-131: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n132-132: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n161-161: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n167-167: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n168-168: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n187-187: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n195-195: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n196-196: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n205-205: Do not use bare `except`\n\n(E722)\n\n---\n\n205-206: `try`-`except`-`pass` detected, consider logging the exception\n\n(S110)\n\n---\n\n242-242: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n252-252: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>bastion/usb_rules.py</summary>\n\n152-152: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n159-159: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n229-229: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n239-239: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n243-243: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n244-244: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n245-245: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n278-278: Abstract `raise` to an inner function\n\n(TRY301)\n\n---\n\n278-278: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n298-298: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n441-441: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n447-447: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n455-455: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n459-459: Avoid specifying long messages outside the exception class\n\n(TRY003)\n\n---\n\n477-477: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n493-493: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n498-498: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n500-500: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n517-517: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n522-522: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n524-524: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>bastion/usb_monitor.py</summary>\n\n84-84: Consider moving this statement to an `else` block\n\n(TRY300)\n\n---\n\n86-86: Local variable `e` is assigned to but never used\n\nRemove assignment to unused variable `e`\n\n(F841)\n\n---\n\n120-120: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n121-121: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n190-190: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n207-207: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n228-228: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n229-229: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n</details>\n<details>\n<summary>bastion/usb_gui.py</summary>\n\n423-423: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n437-437: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n768-768: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n769-769: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n788-788: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n792-792: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n795-795: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n796-796: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n868-868: `subprocess` call: check for execution of untrusted input\n\n(S603)\n\n---\n\n869-869: Starting a process with a partial executable path\n\n(S607)\n\n---\n\n895-895: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n898-898: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n900-900: Do not catch blind exception: `Exception`\n\n(BLE001)\n\n---\n\n906-906: Use `logging.exception` instead of `logging.error`\n\nReplace with `exception`\n\n(TRY400)\n\n---\n\n915-915: Local variable `app` is assigned to but never used\n\nRemove assignment to unused variable `app`\n\n(F841)\n\n</details>\n\n</details>\n\n</details>\n\n<details>\n<summary>üîá Additional comments (18)</summary><blockquote>\n\n<details>\n<summary>debian/DEBIAN/control (1)</summary><blockquote>\n\n`6-7`: **Dependencies updated correctly for USB device control feature.**\n\nThe Python version requirement has been updated to 3.7+ to match pyudev 0.24.0's requirements, and the pyudev dependency has been added to support USB monitoring. The previous review concerns about Build-Depends and Python version have been addressed.\n\n</blockquote></details>\n<details>\n<summary>bastion/gui_manager.py (2)</summary><blockquote>\n\n`53-70`: **LGTM - GUI process detection looks correct.**\n\nThe method properly checks both the tracked process handle and uses `pgrep -x` for exact binary matching to avoid false positives from similarly-named processes.\n\n---\n\n`236-249`: **Privilege demotion implementation looks secure.**\n\nThe `demote_to_user` function correctly sets GID before UID (proper order to avoid permission issues), and the GUI is started with `start_new_session=True` to properly detach from the daemon.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_monitor.py (4)</summary><blockquote>\n\n`1-52`: **Well-structured module with graceful pyudev fallback.**\n\nThe module properly handles the optional pyudev dependency with clear error logging when unavailable, and the class docstring provides helpful usage examples.\n\n---\n\n`103-121`: **Event handling logic is correct with proper filtering.**\n\nThe handler correctly filters to only `add`/`remove` actions and skips USB interfaces (`:` in sys_name) to avoid duplicate events. The sanitization via USBValidation is properly applied.\n\n---\n\n`123-209`: **Device info extraction is thorough and secure.**\n\nThe method properly:\n- Handles missing vendor/product IDs gracefully\n- Parses hex values from sysfs attributes correctly\n- Sanitizes serial numbers via `USBValidation.sanitize_serial`\n- Extracts interface classes for composite devices\n- Returns `None` for invalid/incomplete devices\n\n---\n\n`234-252`: **Convenience functions provide clean public API.**\n\n`list_usb_devices()` and `is_pyudev_available()` offer a simple interface for consumers without requiring monitor instantiation for one-off queries.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_rules.py (5)</summary><blockquote>\n\n`1-35`: **Well-documented security model and clean module structure.**\n\nThe docstring clearly documents the security features (atomic writes, symlink checks, TOCTOU mitigations), and the SecurityError exception provides a clear error type for security-related failures.\n\n---\n\n`38-101`: **USBRule dataclass with comprehensive sanitization.**\n\nThe `from_dict` method properly sanitizes all fields from potentially untrusted JSON data, including hex IDs, strings, serials, and timestamps. The `key` property correctly generates scope-appropriate keys with sanitized components.\n\n---\n\n`247-299`: **Atomic write implementation is secure and correct.**\n\nThe atomic write pattern properly:\n- Creates temp file in the same directory (ensures same filesystem for atomic rename)\n- Sets permissions before writing content\n- Checks for symlink TOCTOU before rename\n- Cleans up temp file on failure\n- Uses `os.replace()` for POSIX atomic rename\n\n---\n\n`431-460`: **Robust bus_id validation prevents path traversal.**\n\nThe validation properly:\n- Rejects empty strings\n- Validates format with regex (`^\\d+-[\\d.]+$`)\n- Sanitizes characters as defense-in-depth\n- Explicitly rejects `..` and leading `/`\n\n---\n\n`536-568`: **`set_default_policy` iterates over USB controllers correctly.**\n\nThe method properly globs for `usb*` host controllers and handles individual failures gracefully, returning success if at least one controller was configured.\n\n</blockquote></details>\n<details>\n<summary>bastion/usb_gui.py (6)</summary><blockquote>\n\n`29-145`: **ConfirmDeleteDialog follows application theme consistently.**\n\nThe dialog styling matches the application's design system with proper use of COLORS constants and consistent button styling.\n\n---\n\n`148-272`: **USBPromptDialog correctly implements risk-aware UI.**\n\nThe dialog properly:\n- Uses danger accent color for high-risk devices (HID, wireless)\n- Shows warning for devices that can act as keyboards\n- Implements consistent styling with FirewallDialog\n- Displays truncated serial for long values\n\n---\n\n`397-412`: **Timer countdown and timeout behavior are correct.**\n\nThe timer updates every 100ms for smooth progress bar animation and correctly defaults to \"block once\" on timeout (safe default - doesn't persist the rule).\n\n---\n\n`765-796`: **Privilege escalation via root helper is correctly implemented.**\n\nThe subprocess call:\n- Uses absolute path `/usr/bin/bastion-root-helper` to prevent PATH hijacking\n- Passes only fixed arguments, no user-controlled data interpolation\n- Handles cancellation (returncode 126) gracefully\n- Has appropriate timeout (30s)\n\nThe static analysis warning about \"untrusted input\" (S603) is a false positive here since arguments are hardcoded strings.\n\n---\n\n`850-907`: **Rule deletion with privilege escalation handles edge cases well.**\n\nThe implementation:\n- Uses absolute path for the root helper\n- Passes the key as a CLI argument (validated by helper)\n- Distinguishes between user cancellation, not found, and errors\n- Provides user feedback via notifications\n\n---\n\n`910-939`: **Test function `app` variable is required, not unused.**\n\nThe static analysis hint about unused `app` (F841) is a false positive. The `QApplication` instance must remain in scope for `dialog.exec()` to work correctly - it's the Qt event loop owner.\n\n</blockquote></details>\n\n</blockquote></details>\n\n</details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->","submittedAt":"2025-12-25T08:33:43Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"94d9a1f05e422479d4bbfe1adeac224f56113aa2"}}]}
