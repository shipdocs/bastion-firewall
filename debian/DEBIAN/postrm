#!/bin/bash
#
# Post-removal script for Bastion Firewall
# This runs AFTER package files are removed
#

set -e

case "$1" in
    remove)
        echo ""
        echo "============================================================"
        echo "ðŸ° Bastion Firewall - Post-Removal Cleanup"
        echo "============================================================"
        echo ""

        # Reload systemd to remove service
        echo "Reloading systemd daemon..."
        systemctl daemon-reload 2>/dev/null || true
        echo "âœ“ Systemd reloaded"

        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            echo "Updating desktop database..."
            update-desktop-database -q 2>/dev/null || true
            echo "âœ“ Desktop database updated"
        fi

        # Refresh AppStream cache for Software Centre
        if command -v appstreamcli >/dev/null 2>&1; then
            echo "Refreshing Software Centre cache..."
            appstreamcli refresh --force 2>/dev/null || true
            echo "âœ“ Software Centre cache refreshed"
        fi

        echo ""
        echo "âœ“ Bastion Firewall removed"
        echo ""
        ;;

    purge)
        echo ""
        echo "============================================================"
        echo "ðŸ° Bastion Firewall - Complete Purge"
        echo "============================================================"
        echo ""

        # Remove configuration directory (both old and new)
        if [ -d "/etc/bastion" ]; then
            echo "Removing configuration directory..."
            rm -rf /etc/bastion
            echo "âœ“ /etc/bastion removed"
        fi

        # Also remove old Douane config if it exists
        if [ -d "/etc/douane" ]; then
            rm -rf /etc/douane
            echo "âœ“ /etc/douane removed (legacy)"
        fi

        # Remove log files (both old and new)
        if [ -f "/var/log/bastion-daemon.log" ]; then
            echo "Removing log files..."
            rm -f /var/log/bastion-daemon.log
            echo "âœ“ Log files removed"
        fi

        # Remove old Douane logs
        rm -f /var/log/douane-daemon.log 2>/dev/null || true
        rm -rf /var/log/douane 2>/dev/null || true
        rm -rf /var/log/bastion 2>/dev/null || true

        # Remove socket files (both old and new)
        if [ -S "/tmp/bastion-daemon.sock" ]; then
            echo "Removing socket file..."
            rm -f /tmp/bastion-daemon.sock
            echo "âœ“ Socket removed"
        fi
        rm -f /var/run/douane.sock 2>/dev/null || true

        # Remove user config (for all users)
        echo "Removing user configurations..."
        rm -rf /root/.config/bastion 2>/dev/null || true
        rm -rf /root/.config/douane 2>/dev/null || true

        # Remove from all user home directories
        for user_home in /home/*; do
            if [ -d "$user_home/.config/bastion" ]; then
                rm -rf "$user_home/.config/bastion"
            fi
            if [ -d "$user_home/.config/douane" ]; then
                rm -rf "$user_home/.config/douane"
            fi
            # Also remove user-specific autostart entries
            if [ -d "$user_home/.config/autostart" ]; then
                rm -f "$user_home/.config/autostart/bastion"*.desktop 2>/dev/null || true
                rm -f "$user_home/.config/autostart/douane"*.desktop 2>/dev/null || true
            fi
        done
        echo "âœ“ User configurations removed"

        # Remove system-wide autostart entries
        if [ -d "/etc/xdg/autostart" ]; then
            echo "Removing autostart entries..."
            rm -f /etc/xdg/autostart/bastion*.desktop 2>/dev/null || true
            rm -f /etc/xdg/autostart/douane*.desktop 2>/dev/null || true
            echo "âœ“ Autostart entries removed"
        fi

        # Reload systemd
        systemctl daemon-reload 2>/dev/null || true

        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database -q 2>/dev/null || true
        fi

        # Refresh AppStream cache for Software Centre
        if command -v appstreamcli >/dev/null 2>&1; then
            echo "Refreshing Software Centre cache..."
            appstreamcli refresh --force 2>/dev/null || true
            echo "âœ“ Software Centre cache refreshed"
        fi

        echo ""
        echo "============================================================"
        echo "âœ“ Bastion Firewall completely purged"
        echo "============================================================"
        echo ""
        echo "All configuration files and data have been removed."
        echo ""
        ;;

    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Do nothing for these cases
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0

