#!/bin/bash
set -e

case "$1" in
    install|upgrade)
        # Stop services
        systemctl stop bastion-firewall 2>/dev/null || true
        systemctl stop douane 2>/dev/null || true

        # Kill processes
        pkill -9 -f bastion-daemon 2>/dev/null || true
        pkill -9 -f bastion-gui 2>/dev/null || true
        pkill -9 -f douane-daemon 2>/dev/null || true
        pkill -9 -f douane-gui 2>/dev/null || true

        # Remove sockets
        rm -f /tmp/bastion-daemon.sock 2>/dev/null || true
        rm -f /var/run/bastion/bastion-daemon.sock 2>/dev/null || true
        rm -f /var/run/douane.sock 2>/dev/null || true
        rm -f /tmp/douane-daemon.sock 2>/dev/null || true

        # Remove iptables NFQUEUE rules
        while iptables -S OUTPUT 2>/dev/null | grep -q "NFQUEUE --queue-num 0"; do
            iptables -D OUTPUT -j NFQUEUE --queue-num 0 2>/dev/null || break
        done
        while iptables -S OUTPUT 2>/dev/null | grep -q "NFQUEUE --queue-num 1"; do
            iptables -D OUTPUT -j NFQUEUE --queue-num 1 --queue-bypass 2>/dev/null || \
            iptables -D OUTPUT -j NFQUEUE --queue-num 1 2>/dev/null || break
        done

        # Force cleanup if rules remain
        if iptables -S OUTPUT 2>/dev/null | grep -q NFQUEUE; then
            iptables-save | grep -v NFQUEUE | iptables-restore 2>/dev/null || true
            if iptables -S OUTPUT 2>/dev/null | grep -q NFQUEUE; then
                iptables -F OUTPUT 2>/dev/null || true
                iptables -P OUTPUT ACCEPT 2>/dev/null || true
            fi
        fi
        ;;

    abort-upgrade)
        # Do nothing
        ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0

