#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_error() { echo -e "${RED}✗ $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠ $1${NC}"; }

echo "=== Bastion Firewall v2.0 - Post-Installation ==="
echo ""

# Check kernel version and BTF support
KERNEL_VERSION=$(uname -r)
echo "Kernel version: $KERNEL_VERSION"

if [ -f /sys/kernel/btf/vmlinux ]; then
    print_success "BTF support detected - eBPF will work"
else
    print_warning "BTF support not detected - eBPF may not work"
    print_warning "Daemon will fall back to /proc scanning"
fi

# Create bastion user/group if they don't exist
if ! getent group bastion > /dev/null; then
    groupadd -r bastion
    print_success "Created bastion group"
fi
if ! getent passwd bastion > /dev/null; then
    useradd -r -g bastion -d /var/lib/bastion -s /usr/sbin/nologin -c "Bastion Firewall User" bastion
    print_success "Created bastion user"
fi

# Set up configuration directory
mkdir -p /etc/bastion
if [ ! -f /etc/bastion/config.json ]; then
    cat > /etc/bastion/config.json << 'EOF'
{
  "mode": "learning",
  "timeout_seconds": 30,
  "allow_localhost": true,
  "queue_num": 1
}
EOF
    chmod 644 /etc/bastion/config.json
    print_success "Created default configuration"
fi

# Set up rules file
if [ ! -f /etc/bastion/rules.json ]; then
    echo '{"applications": {}, "services": {}}' > /etc/bastion/rules.json
    chmod 644 /etc/bastion/rules.json
    print_success "Created empty rules file"
fi

# Ensure strict blocking by removing loose default rules
if [ -f /etc/bastion/rules.json ]; then
    python3 -c "import json; p='/etc/bastion/rules.json'; d=json.load(open(p)); d.pop('unknown:443', None); json.dump(d, open(p,'w'), indent=2)" || true
    print_success "Enforced strict blocking (removed unknown:443 rule)"
fi

# Set up socket directory
mkdir -p /var/run/bastion
chmod 755 /var/run/bastion
print_success "Created socket directory"

# Set permissions for logs
mkdir -p /var/log/bastion
chown -R bastion:bastion /var/log/bastion
chmod 750 /var/log/bastion

# FIX #12: Ensure log file is owned by bastion user
touch /var/log/bastion-daemon.log
chown bastion:bastion /var/log/bastion-daemon.log
chmod 644 /var/log/bastion-daemon.log
print_success "Configured logging"

# Install logrotate configuration
if [ -f /etc/logrotate.d/bastion-firewall ]; then
    print_success "Logrotate configuration installed"
fi

# Check if Rust daemon binary exists
if [ -f /usr/bin/bastion-daemon ]; then
    print_success "Rust daemon installed"
    
    # Check if eBPF program is embedded or available
    if [ -f /usr/share/bastion-firewall/bastion-ebpf.o ]; then
        print_success "eBPF program available"
    fi
else
    print_error "Rust daemon binary not found at /usr/bin/bastion-daemon"
fi

# Reload systemd
systemctl daemon-reload
print_success "Systemd configuration reloaded"

# Set up iptables rules (CRITICAL: must be done before starting daemon)
print_success "Setting up iptables rules..."

# FIX #6: Check if nftables is in use (Debian 12+)
if command -v nft &> /dev/null && nft list table ip filter 2>/dev/null | grep -q "bastion"; then
    print_warning "nftables detected - using iptables-nft compatibility layer"
fi

# FIX #6, #10: Force NFQUEUE rule position to ensure it is not shadowed
# Clean up any old NFQUEUE rules
while iptables -D OUTPUT -m state --state NEW -j NFQUEUE --queue-num 1 --queue-bypass 2>/dev/null; do :; done
while iptables -D OUTPUT -m state --state NEW -j NFQUEUE --queue-num 1 2>/dev/null; do :; done

# Insert NFQUEUE rule at the top (will be pushed down by bypass rules)
# This ensures it runs before any other firewall rules (like UFW) might accept traffic
iptables -I OUTPUT 1 -m state --state NEW -j NFQUEUE --queue-num 1 --queue-bypass
print_success "NFQUEUE rule configured (forced position)"

# FIX #6, #8: Check for existing BASTION_BYPASS rules before adding
# Add bypass rules FIRST (higher priority)
if ! iptables -C OUTPUT -m owner --gid-owner systemd-network -m comment --comment "BASTION_BYPASS" -j ACCEPT 2>/dev/null; then
    iptables -I OUTPUT 1 -m owner --gid-owner systemd-network -m comment --comment "BASTION_BYPASS" -j ACCEPT
    print_success "systemd-network bypass rule added"
fi

if ! iptables -C OUTPUT -m owner --uid-owner 0 -m comment --comment "BASTION_BYPASS" -j ACCEPT 2>/dev/null; then
    iptables -I OUTPUT 1 -m owner --uid-owner 0 -m comment --comment "BASTION_BYPASS" -j ACCEPT
    print_success "root bypass rule added"
fi

print_success "iptables rules configured"

# Enable and start service
systemctl enable bastion-daemon 2>/dev/null || true

# FIX #14: Check if firewall rule setup succeeded before starting daemon
# Verify NFQUEUE rule exists
if ! iptables -C OUTPUT -m state --state NEW -j NFQUEUE --queue-num 1 --queue-bypass 2>/dev/null; then
    print_error "NFQUEUE rule not found - firewall setup may have failed"
    print_warning "Daemon will not be started until firewall rules are properly configured"
    print_warning "Please check your iptables configuration and re-run: sudo dpkg-reconfigure bastion-firewall"
else
    # Start the daemon
    if systemctl restart bastion-daemon 2>/dev/null; then
        print_success "Bastion daemon started"
    else
        print_warning "Could not start daemon automatically"
        echo "  You can start it manually with: sudo systemctl start bastion-daemon"
    fi
fi

# Update desktop database
update-desktop-database 2>/dev/null || true

# Autostart helpers
if [ -d /home ]; then
    for user_dir in /home/*; do
        if [ -d "$user_dir/.config/autostart" ]; then
            chown -R $(basename "$user_dir"):$(basename "$user_dir") "$user_dir/.config/autostart" 2>/dev/null || true
        fi
    done
fi

echo ""
echo "=== Installation Complete ==="
echo ""
echo "Bastion Firewall v2.0 has been installed with:"
echo "  • Rust daemon with eBPF support"
echo "  • Qt6 GUI for connection popups"
echo "  • Learning mode enabled by default"
echo ""
echo "To launch the GUI:"
echo "  bastion-gui &"
echo ""
echo "To check daemon status:"
echo "  sudo systemctl status bastion-daemon"
echo ""
echo "Documentation: /usr/share/doc/bastion-firewall/"
echo ""

exit 0
