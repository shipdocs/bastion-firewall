#!/bin/bash
#
# Post-installation script for Bastion Firewall
#

set -e

echo ""
echo "============================================================"
echo "ðŸ° Bastion Firewall - Post Installation"
echo "============================================================"
echo ""

# Install system dependencies for system tray
echo "Installing system dependencies..."
apt-get install -y gir1.2-ayatanaappindicator3-0.1 whiptail >/dev/null 2>&1 || true

# Install Python dependencies
echo "Installing Python dependencies..."
pip3 install --break-system-packages psutil tabulate NetfilterQueue scapy pystray pillow 2>/dev/null || \
pip3 install psutil tabulate NetfilterQueue scapy pystray pillow 2>/dev/null || true

# Create config directory
mkdir -p /etc/bastion

# Check if this is a fresh install (no existing config)
FRESH_INSTALL=false
if [ ! -f /etc/bastion/config.json ]; then
    FRESH_INSTALL=true
fi

# Interactive configuration for fresh installs
if [ "$FRESH_INSTALL" = true ]; then
    echo ""
    echo "============================================================"
    echo "Initial Configuration"
    echo "============================================================"
    echo ""

    # Ask about starting mode
    if whiptail --title "Bastion Firewall Setup" --yes-button "Learning Mode" --no-button "Enforcement Mode" --yesno \
"Welcome to Bastion Firewall - Your Last Line of Defense!

LEARNING MODE (Recommended):
  â€¢ Shows popups for all connections
  â€¢ Automatically allows all connections
  â€¢ Builds your rule set safely
  â€¢ No risk of blocking important services

ENFORCEMENT MODE (Advanced):
  â€¢ Actually blocks connections
  â€¢ Requires careful configuration
  â€¢ May block critical services if misconfigured

Choose your initial mode:" 18 70; then
        MODE="learning"
        echo "âœ“ Selected: Learning Mode (safe)"
    else
        MODE="enforcement"
        echo "âœ“ Selected: Enforcement Mode (blocking enabled)"
    fi

    # Ask about autostart
    if whiptail --title "Bastion Firewall Setup" --yes-button "Enable Autostart" --no-button "Manual Start" --yesno \
"Start Bastion Firewall automatically at login?

ENABLE AUTOSTART (Recommended):
  â€¢ Firewall starts when you log in
  â€¢ Always protected

MANUAL START:
  â€¢ Start from application menu when needed
  â€¢ You control when it runs" 14 70; then
        AUTOSTART=true
        echo "âœ“ Autostart: Enabled"
    else
        AUTOSTART=false
        echo "âœ“ Autostart: Disabled"
    fi

    # Ask about starting now
    if whiptail --title "Bastion Firewall Setup" --yes-button "Start Now" --no-button "Start Later" --yesno \
"Start Bastion Firewall now?

This will launch the firewall GUI client immediately." 10 70; then
        START_NOW=true
        echo "âœ“ Will start firewall after installation"
    else
        START_NOW=false
        echo "âœ“ Will not start firewall now"
    fi

    # Create config file
    cat > /etc/bastion/config.json << EOF
{
  "mode": "$MODE",
  "cache_decisions": true,
  "default_action": "deny",
  "timeout_seconds": 30,
  "allow_localhost": true,
  "allow_lan": false,
  "log_decisions": true,
  "filtering": {
    "monitor_protocols": ["tcp", "udp"],
    "ignore_local": true,
    "ignore_localhost": true
  },
  "ufw": {
    "default_outbound_policy": "allow",
    "enable_logging": true
  }
}
EOF
    echo "âœ“ Created configuration file"

    # Setup autostart if requested
    if [ "$AUTOSTART" = true ]; then
        # Create autostart directory for all users
        mkdir -p /etc/xdg/autostart
        cat > /etc/xdg/autostart/bastion-tray.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=Bastion Firewall Tray Icon
Comment=Start Bastion Firewall Tray Icon
Exec=/usr/local/bin/bastion-gui
Icon=security-high
Terminal=false
Categories=System;Security;
X-GNOME-Autostart-enabled=true
Hidden=false
NoDisplay=false
EOF
        chmod 644 /etc/xdg/autostart/bastion-tray.desktop
        echo "âœ“ Autostart enabled"
    fi

else
    echo "âœ“ Existing configuration preserved"
    # Upgrade scenario
    if [ "$1" = "configure" ] && [ -n "$2" ]; then
        # This is an upgrade
        echo "Restarting Bastion Firewall service..."
        systemctl restart bastion-firewall || true

        # Try to restart GUI for the active user
        REAL_USER="${SUDO_USER:-$USER}"
        if [ "$REAL_USER" != "root" ] && [ -n "$REAL_USER" ]; then
            echo "Restarting GUI for $REAL_USER..."

            # Get the user's UID and GID
            USER_UID=$(id -u "$REAL_USER" 2>/dev/null || echo "")
            USER_GID=$(id -g "$REAL_USER" 2>/dev/null || echo "")

            if [ -n "$USER_UID" ] && [ -n "$USER_GID" ]; then
                # Find the user's DISPLAY
                USER_DISPLAY=$(ps aux | grep -E "Xorg|X11" | grep "$REAL_USER" | grep -oP ':\d+' | head -1 || echo ":0")

                # Start GUI as the user with proper environment
                sudo -u "$REAL_USER" DISPLAY="$USER_DISPLAY" /usr/local/bin/bastion-gui >/dev/null 2>&1 &
                echo "âœ“ GUI restarted"
            else
                echo "âš  Could not determine user session"
            fi
        fi
    fi
    AUTOSTART=false
    START_NOW=false
fi

# Create log directory
mkdir -p /var/log
touch /var/log/bastion-daemon.log
chmod 644 /var/log/bastion-daemon.log

# Reload systemd
systemctl daemon-reload 2>/dev/null || true

echo ""
echo "============================================================"
echo "âœ“ Bastion Firewall Installed"
echo "============================================================"
echo ""

if [ "$START_NOW" = true ]; then
    # Get the user who invoked sudo (if any)
    REAL_USER="${SUDO_USER:-$USER}"
    if [ "$REAL_USER" != "root" ] && [ -n "$REAL_USER" ]; then
        echo "Starting Bastion Firewall for user $REAL_USER..."

        # Find the user's DISPLAY
        USER_DISPLAY=$(ps aux | grep -E "Xorg|X11" | grep "$REAL_USER" | grep -oP ':\d+' | head -1 || echo ":0")

        # Start GUI as the user with proper environment
        sudo -u "$REAL_USER" DISPLAY="$USER_DISPLAY" /usr/local/bin/bastion-gui >/dev/null 2>&1 &
        echo "âœ“ Firewall started"
    else
        echo "âš  Cannot auto-start (no user session detected)"
        echo "  Please start manually from the application menu"
    fi
else
    echo "To start manually:"
    echo "  /usr/local/bin/bastion-gui"
    echo ""
    echo "Or from the application menu:"
    echo "  Search for 'Bastion Firewall'"
fi

echo ""
echo "Documentation: /usr/share/doc/bastion-firewall/"
exit 0

