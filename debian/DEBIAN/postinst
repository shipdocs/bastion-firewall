#!/bin/bash
#
# Post-installation script for Douane Firewall
#

set -e

echo ""
echo "============================================================"
echo "Douane Firewall - Post Installation"
echo "============================================================"
echo ""

# Install system dependencies for system tray
echo "Installing system dependencies..."
apt-get install -y gir1.2-ayatanaappindicator3-0.1 whiptail >/dev/null 2>&1 || true

# Install Python dependencies
echo "Installing Python dependencies..."
pip3 install --break-system-packages psutil tabulate NetfilterQueue scapy pystray pillow 2>/dev/null || \
pip3 install psutil tabulate NetfilterQueue scapy pystray pillow 2>/dev/null || true

# Create config directory
mkdir -p /etc/douane

# Check if this is a fresh install (no existing config)
FRESH_INSTALL=false
if [ ! -f /etc/douane/config.json ]; then
    FRESH_INSTALL=true
fi

# Interactive configuration for fresh installs
if [ "$FRESH_INSTALL" = true ]; then
    echo ""
    echo "============================================================"
    echo "Initial Configuration"
    echo "============================================================"
    echo ""

    # Ask about starting mode
    if whiptail --title "Douane Firewall Setup" --yes-button "Learning Mode" --no-button "Enforcement Mode" --yesno \
"Welcome to Douane Application Firewall!

LEARNING MODE (Recommended):
  • Shows popups for all connections
  • Automatically allows all connections
  • Builds your rule set safely
  • No risk of blocking important services

ENFORCEMENT MODE (Advanced):
  • Actually blocks connections
  • Requires careful configuration
  • May block critical services if misconfigured

Choose your initial mode:" 18 70; then
        MODE="learning"
        echo "✓ Selected: Learning Mode (safe)"
    else
        MODE="enforcement"
        echo "✓ Selected: Enforcement Mode (blocking enabled)"
    fi

    # Ask about autostart
    if whiptail --title "Douane Firewall Setup" --yes-button "Enable Autostart" --no-button "Manual Start" --yesno \
"Start Douane Firewall automatically at login?

ENABLE AUTOSTART (Recommended):
  • Firewall starts when you log in
  • Always protected

MANUAL START:
  • Start from application menu when needed
  • You control when it runs" 14 70; then
        AUTOSTART=true
        echo "✓ Autostart: Enabled"
    else
        AUTOSTART=false
        echo "✓ Autostart: Disabled"
    fi

    # Ask about starting now
    if whiptail --title "Douane Firewall Setup" --yes-button "Start Now" --no-button "Start Later" --yesno \
"Start Douane Firewall now?

This will launch the firewall GUI client immediately." 10 70; then
        START_NOW=true
        echo "✓ Will start firewall after installation"
    else
        START_NOW=false
        echo "✓ Will not start firewall now"
    fi

    # Create config file
    cat > /etc/douane/config.json << EOF
{
  "mode": "$MODE",
  "cache_decisions": true,
  "default_action": "deny",
  "timeout_seconds": 30,
  "allow_localhost": true,
  "allow_lan": false,
  "log_decisions": true,
  "filtering": {
    "monitor_protocols": ["tcp", "udp"],
    "ignore_local": true,
    "ignore_localhost": true
  },
  "ufw": {
    "default_outbound_policy": "allow",
    "enable_logging": true
  }
}
EOF
    echo "✓ Created configuration file"

    # Setup autostart if requested
    if [ "$AUTOSTART" = true ]; then
        # Create autostart directory for all users
        mkdir -p /etc/xdg/autostart
        cat > /etc/xdg/autostart/douane-firewall.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=Douane Firewall
Comment=Start Douane Application Firewall
Exec=/usr/local/bin/douane-gui-client
Icon=security-high
Terminal=false
Categories=System;Security;
X-GNOME-Autostart-enabled=true
Hidden=false
NoDisplay=false
EOF
        chmod 644 /etc/xdg/autostart/douane-firewall.desktop
        echo "✓ Autostart enabled"
    fi

else
    echo "✓ Existing configuration preserved"
    # Upgrade scenario
    if [ "$1" = "configure" ] && [ -n "$2" ]; then
        # This is an upgrade
        echo "Restarting Douane Firewall service..."
        systemctl restart douane-firewall || true
        
        # Try to restart GUI for the active user
        REAL_USER="${SUDO_USER:-$USER}"
        if [ "$REAL_USER" != "root" ] && [ -n "$REAL_USER" ]; then
             echo "Restarting GUI for $REAL_USER..."
             su - "$REAL_USER" -c "DISPLAY=:0 /usr/local/bin/douane-gui-client &" 2>/dev/null || true
        fi
    fi
    AUTOSTART=false
    START_NOW=false
fi

# Create log directory
mkdir -p /var/log
touch /var/log/douane-daemon.log
chmod 644 /var/log/douane-daemon.log

# Reload systemd
systemctl daemon-reload 2>/dev/null || true

echo ""
echo "============================================================"
echo "✓ Douane Firewall Installed"
echo "============================================================"
echo ""

if [ "$START_NOW" = true ]; then
    # Get the user who invoked sudo (if any)
    REAL_USER="${SUDO_USER:-$USER}"
    if [ "$REAL_USER" != "root" ] && [ -n "$REAL_USER" ]; then
        echo "Starting Douane Firewall for user $REAL_USER..."
        # Start as the real user, not root
        su - "$REAL_USER" -c "DISPLAY=:0 /usr/local/bin/douane-gui-client &" 2>/dev/null || true
        echo "✓ Firewall started"
    else
        echo "⚠ Cannot auto-start (no user session detected)"
        echo "  Please start manually from the application menu"
    fi
else
    echo "To start manually:"
    echo "  /usr/local/bin/douane-gui-client"
    echo ""
    echo "Or from the application menu:"
    echo "  Search for 'Douane Firewall'"
fi

echo ""
echo "Documentation: /usr/share/doc/douane-firewall/"
exit 0

