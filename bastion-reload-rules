#!/bin/bash
# Bastion Firewall - Rules Reload Helper
# This script updates the rules file and signals the daemon to reload
# Usage: bastion-reload-rules <temp_file_path> <target_path>

set -e  # Exit on error

if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run as root" >&2
    exit 1
fi

if [ $# -ne 2 ]; then
    echo "Usage: $0 <temp_file> <rules_file>" >&2
    exit 1
fi

TEMP_FILE="$1"
RULES_FILE="$2"

# Validate destination path - must be under /etc/bastion/
case "$RULES_FILE" in
    /etc/bastion/rules.json) ;;
    *)
        echo "Error: Invalid rules file path: $RULES_FILE" >&2
        echo "Rules file must be /etc/bastion/rules.json" >&2
        exit 1
        ;;
esac

# Validate paths
if [ ! -f "$TEMP_FILE" ]; then
    echo "Error: Temporary file does not exist: $TEMP_FILE" >&2
    exit 1
fi

# Reject symlinks to avoid clobbering arbitrary root-owned files
if [ -L "$TEMP_FILE" ]; then
    echo "Error: Temporary file must not be a symlink: $TEMP_FILE" >&2
    exit 1
fi

# Also check if target is a symlink to prevent privilege escalation
if [ -L "$RULES_FILE" ]; then
    echo "Error: Rules file must not be a symlink: $RULES_FILE" >&2
    exit 1
fi

# Move the temporary file to the rules location
mv "$TEMP_FILE" "$RULES_FILE"

# Set proper permissions (readable by all, writable by root)
chmod 644 "$RULES_FILE"

# Signal the daemon to reload rules and clear cache
# Use -x for exact process name matching (not full command line)
if ! pkill -HUP -x bastion-daemon; then
    echo "Error: bastion-daemon is not running; could not reload rules" >&2
    exit 1
fi

exit 0
